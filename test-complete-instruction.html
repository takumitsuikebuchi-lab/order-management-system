<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完全版運行指示書テスト</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .checklist {
            background: #fff3cd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .checklist h3 {
            margin-top: 0;
            color: #856404;
        }
        .checklist ul {
            margin: 10px 0;
        }
        .checklist li {
            margin: 8px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>完全版運行指示書テスト</h1>
        
        <div class="test-info">
            <h3>📋 テスト内容</h3>
            <p>オリジナルの運行指示書の全要素を保持しながら、配車時間表示機能を追加した完全版をテストします。</p>
        </div>

        <div class="checklist">
            <h3>✅ 確認項目チェックリスト</h3>
            <ul>
                <li><strong>配車時間表示:</strong> 1ページ目の最初の案件のすぐ上に、16ptの見出しサイズで「1件目の配車時間: 08:30」が黄色背景で表示されているか</li>
                <li><strong>標準指示事項:</strong> 最終ページに法定速度、休憩時間、荷崩れ防止等の5項目が表示されているか</li>
                <li><strong>法令遵守に基づく運行計画:</strong> 出発予定、到着予定、運行経路等の記入欄が表示されているか</li>
                <li><strong>運行管理者押印スペース:</strong> 「運行管理者　押印」のラベルと60px×60pxの押印枠が表示されているか</li>
                <li><strong>フッター注記:</strong> 「※本指示書は輸送安全規則に沿った記載項目を含みます。点呼簿・運転日報と併せて保管してください。」が表示されているか</li>
                <li><strong>案件情報:</strong> 引取先、配送先、積荷、数量等の情報が正しく表示されているか</li>
                <li><strong>ドライバー・車両情報:</strong> 各ページに表示されているか</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="test-button" onclick="testSingleOrder()">単一案件テスト</button>
            <button class="test-button" onclick="testMultipleOrders()">複数案件テスト（3件）</button>
            <button class="test-button" onclick="testManyOrders()">複数案件テスト（5件）</button>
        </div>
    </div>

    <script>
        // 会社情報（グローバル変数として定義）
        const companyInfo = {
            name: 'テスト運送株式会社',
            address: '〒123-4567 東京都渋谷区テスト町1-2-3',
            tel: '03-1234-5678'
        };

        // サンプルデータ
        function createSampleOrder(index) {
            const date = new Date();
            date.setDate(date.getDate() + index);
            
            return {
                id: index + 1,
                date: date.toISOString().split('T')[0],
                customerName: `株式会社サンプル${index + 1}`,
                pickupLocation: `引取先${index + 1}`,
                pickupAddress: `東京都新宿区西新宿${index + 1}-${index + 1}-${index + 1}`,
                deliveryLocation: `配送先${index + 1}`,
                deliveryAddress: `神奈川県横浜市中区山下町${index + 1}-${index + 1}`,
                deliveryTel: `045-123-456${index}`,
                cargo: `サンプル貨物${index + 1}`,
                packaging: 'パレット',
                quantity: (index + 1) * 10,
                unit: '個',
                instructions: `案件${index + 1}の個別指示事項です。\n時間厳守でお願いします。`,
                driver: '山田太郎',
                vehicle: '品川500あ1234',
                instructionSheet: false
            };
        }

        // ダミーの関数（実際のシステムにある関数）
        function saveData() {
            console.log('saveData called');
        }
        
        function cloudEnabled() {
            return false;
        }
        
        function cloudBatchUpdate() {
            console.log('cloudBatchUpdate called');
        }
        
        function renderTable() {
            console.log('renderTable called');
        }
        
        function updateStats() {
            console.log('updateStats called');
        }

        // 完全版の運行指示書印刷関数
        function printInstructionsWithSettings(printOrders, dispatchTime) {
            // ドライバー整合性チェック（空欄は除外）
            if (printOrders.length > 1) {
                const drivers = Array.from(new Set(
                    printOrders
                        .map(o => (o.driver || '').trim())
                        .filter(d => d.length > 0)
                ));
                if (drivers.length > 1) {
                    alert('複数選択時は同一ドライバーで印刷してください（空欄は除外）');
                    return;
                }
            }
            
            // 運行指示書の生成
            let printContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>運行指示書</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 10mm 15mm;
                        }
                        body { 
                            font-family: 'MS Gothic', 'ＭＳ ゴシック', monospace; 
                            font-size: 10pt;
                            line-height: 1.3;
                            color: #000;
                        }
                        .page { 
                            page-break-after: always;
                            position: relative;
                            width: 100%;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 8px;
                        }
                        .title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin-bottom: 2px;
                        }
                        .company-info {
                            font-size: 9pt;
                            line-height: 1.2;
                        }
                        
                        /* 配車時間の表示スタイル */
                        .dispatch-time {
                            font-size: 16pt;
                            font-weight: bold;
                            margin: 10px 0 15px 0;
                            padding: 10px;
                            background: #ffffcc;
                            border: 2px solid #000;
                            text-align: center;
                        }
                        
                        /* 複数案件用のスタイル */
                        .multi-orders {
                            margin-top: 10px;
                        }
                        .order-section {
                            margin-bottom: 15px;
                            border: 2px solid #000;
                            padding: 5px;
                        }
                        .order-header-outside {
                            font-size: 12pt;
                            font-weight: bold;
                            margin: 6px 0 6px 0;
                            line-height: 1.4;
                        }
                        .compact-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 5px;
                            font-size: 9pt;
                        }
                        .compact-table th {
                            background: #eeeeee;
                            border: 1px solid #000;
                            padding: 2px 4px;
                            text-align: left;
                            width: 20%;
                            font-weight: normal;
                        }
                        .compact-table td {
                            border: 1px solid #000;
                            padding: 2px 4px;
                        }
                        .instructions-compact {
                            border: 1px solid #000;
                            padding: 3px 5px;
                            font-size: 8pt;
                            min-height: 25px;
                            margin-bottom: 5px;
                        }
                        
                        /* 標準指示事項（複数案件用） */
                        .standard-instructions {
                            font-size: 8pt;
                            line-height: 1.5;
                            margin-top: 10px;
                            padding: 8px;
                            background: #f5f5f5;
                            border: 1px solid #000;
                        }
                        
                        /* 法令遵守に基づく運行計画 */
                        .operation-plan {
                            border: 1px solid #000;
                            padding: 8px;
                            font-size: 9pt;
                            margin-top: 10px;
                        }
                        .operation-plan-title {
                            font-size: 10pt;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .plan-table {
                            width: 100%;
                        }
                        .plan-table td {
                            padding: 3px 0;
                            font-size: 9pt;
                            vertical-align: bottom;
                        }
                        .plan-label {
                            width: 30%;
                        }
                        .plan-value {
                            border-bottom: 1px solid #000;
                            width: 70%;
                        }
                        
                        /* 押印スペース */
                        .signature-area {
                            margin-top: 10px;
                            text-align: right;
                        }
                        .signature-box {
                            display: inline-block;
                            text-align: center;
                        }
                        .signature-label {
                            font-size: 9pt;
                            margin-bottom: 3px;
                        }
                        .signature-stamp {
                            border: 1px solid #000;
                            width: 60px;
                            height: 60px;
                            display: inline-block;
                        }
                        
                        /* フッター注記 */
                        .footer-note {
                            font-size: 8pt;
                            margin-top: 10px;
                            line-height: 1.3;
                        }
                    </style>
                </head>
                <body>
            `;
            
            // 複数案件を1枚にまとめる場合
            const MULTI_ORDERS_PER_PAGE = 4;
            
            for (let startIdx = 0; startIdx < printOrders.length; startIdx += MULTI_ORDERS_PER_PAGE) {
                const chunk = printOrders.slice(startIdx, startIdx + MULTI_ORDERS_PER_PAGE);
                const isLastPage = (startIdx + MULTI_ORDERS_PER_PAGE) >= printOrders.length;
                const isFirstPage = (startIdx === 0);

                printContent += `
                    <div class="page">
                        <div class="header">
                            <div class="title">運行指示書（貨物）</div>
                            <div class="company-info">
                                ${companyInfo.name}<br>
                                ${companyInfo.address}<br>
                                TEL・FAX ${companyInfo.tel}
                            </div>
                        </div>
                `;
                
                // 配車時間を1ページ目の最初の案件の上に表示
                if (isFirstPage && dispatchTime) {
                    printContent += `
                        <div class="dispatch-time">
                            1件目の配車時間: ${dispatchTime}
                        </div>
                    `;
                }

                printContent += `<div class="multi-orders">`;

                // このページに載せる案件を表示
                chunk.forEach((order, idx) => {
                    const globalIdx = startIdx + idx;
                    const orderDate = order.date ? new Date(order.date).toLocaleDateString('ja-JP') : '';
                    
                    printContent += `
                        <div class="order-header-outside">
                            ${globalIdx + 1}件目: ${order.customerName || order.customer_name || ''} (${orderDate})
                        </div>
                        <div class="order-section">
                            <table class="compact-table">
                                <tr>
                                    <th>引取先</th>
                                    <td>${order.pickupLocation || order.pickup_location || ''}</td>
                                    <th>配送先</th>
                                    <td>${order.deliveryLocation || order.delivery_location || ''}</td>
                                </tr>
                                <tr>
                                    <th>引取住所</th>
                                    <td colspan="3">${order.pickupAddress || order.pickup_address || ''}</td>
                                </tr>
                                <tr>
                                    <th>配送住所</th>
                                    <td colspan="3">${order.deliveryAddress || order.delivery_address || ''}</td>
                                </tr>
                                <tr>
                                    <th>積荷</th>
                                    <td>${order.cargo || ''}</td>
                                    <th>数量</th>
                                    <td>${order.quantity || ''} ${order.unit || ''}</td>
                                </tr>
                            </table>
                            <div class="instructions-compact">
                                <strong>指示事項:</strong> ${(order.instructions || '').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                });

                printContent += `</div>`;

                const firstOrder = chunk[0];
                const driverName = firstOrder.driver || '';
                const vehicleName = firstOrder.vehicle || '';

                printContent += `
                    <div style="margin-top: 15px; font-size: 10pt;">
                        <div style="margin-bottom: 5px;">
                            <strong>ドライバー:</strong> ${driverName}　
                            <strong>車両:</strong> ${vehicleName}
                        </div>
                    </div>
                `;

                // 最終ページにのみ標準指示事項、法令遵守、押印スペース、フッター注記を表示
                if (isLastPage) {
                    printContent += `
                        <div class="standard-instructions">
                            <strong>【標準指示事項】</strong><br>
                            ・法定速度・車間距離・シートベルト徹底<br>
                            ・連続運転4時間以内ごとに30分以上の休憩（分割可）<br>
                            ・荷崩れ防止／固縛確認、危険予測運転の徹底<br>
                            ・出発／帰庫時の点呼、酒気帯び無・体調良好を確認<br>
                            ・異常／事故／渋滞等は速やかに配車へ連絡
                        </div>
                        
                        <div class="operation-plan">
                            <div class="operation-plan-title">法令遵守に基づく運行計画（現場記入可）</div>
                            <table class="plan-table">
                                <tr>
                                    <td class="plan-label">出発予定</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">到着予定</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">運行経路・主な経由地（日時）</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">注意が必要な箇所の位置</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">休憩地点と時間</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">交代地点</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding-top: 5px;">その他 安全確保に必要な事項</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="plan-value">&nbsp;</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-label">運行管理者　押印</div>
                                <div class="signature-stamp"></div>
                            </div>
                        </div>
                        
                        <div class="footer-note">
                            ※本指示書は輸送安全規則に沿った記載項目を含みます。点呼簿・運転日報と併せて保管してください。
                        </div>
                    `;
                }

                printContent += `</div>`;
            }

            printContent += `
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            // 指示書発行フラグ更新
            printOrders.forEach(order => {
                order.instructionSheet = true;
            });
            saveData();
            // クラウド一括更新
            try {
                if (cloudEnabled()) {
                    const ids = printOrders.map(o => o.id).filter(id => id != null);
                    cloudBatchUpdate(ids, { instructionSheet: true });
                }
            } catch(e) {}
            renderTable();
            updateStats();
        }

        // テスト関数
        function testSingleOrder() {
            const orders = [createSampleOrder(0)];
            printInstructionsWithSettings(orders, '08:30');
        }

        function testMultipleOrders() {
            const orders = [
                createSampleOrder(0),
                createSampleOrder(1),
                createSampleOrder(2)
            ];
            printInstructionsWithSettings(orders, '09:00');
        }

        function testManyOrders() {
            const orders = [
                createSampleOrder(0),
                createSampleOrder(1),
                createSampleOrder(2),
                createSampleOrder(3),
                createSampleOrder(4)
            ];
            printInstructionsWithSettings(orders, '07:30');
        }
    </script>
</body>
</html>

