<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå…¨ç‰ˆé‹è¡ŒæŒ‡ç¤ºæ›¸ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .checklist {
            background: #fff3cd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .checklist h3 {
            margin-top: 0;
            color: #856404;
        }
        .checklist ul {
            margin: 10px 0;
        }
        .checklist li {
            margin: 8px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>å®Œå…¨ç‰ˆé‹è¡ŒæŒ‡ç¤ºæ›¸ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-info">
            <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆå†…å®¹</h3>
            <p>ã‚ªãƒªã‚¸ãƒŠãƒ«ã®é‹è¡ŒæŒ‡ç¤ºæ›¸ã®å…¨è¦ç´ ã‚’ä¿æŒã—ãªãŒã‚‰ã€é…è»Šæ™‚é–“è¡¨ç¤ºæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸå®Œå…¨ç‰ˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        </div>

        <div class="checklist">
            <h3>âœ… ç¢ºèªé …ç›®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
            <ul>
                <li><strong>é…è»Šæ™‚é–“è¡¨ç¤º:</strong> 1ãƒšãƒ¼ã‚¸ç›®ã®æœ€åˆã®æ¡ˆä»¶ã®ã™ãä¸Šã«ã€16ptã®è¦‹å‡ºã—ã‚µã‚¤ã‚ºã§ã€Œ1ä»¶ç›®ã®é…è»Šæ™‚é–“: 08:30ã€ãŒé»„è‰²èƒŒæ™¯ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>æ¨™æº–æŒ‡ç¤ºäº‹é …:</strong> æœ€çµ‚ãƒšãƒ¼ã‚¸ã«æ³•å®šé€Ÿåº¦ã€ä¼‘æ†©æ™‚é–“ã€è·å´©ã‚Œé˜²æ­¢ç­‰ã®5é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”»:</strong> å‡ºç™ºäºˆå®šã€åˆ°ç€äºˆå®šã€é‹è¡ŒçµŒè·¯ç­‰ã®è¨˜å…¥æ¬„ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>é‹è¡Œç®¡ç†è€…æŠ¼å°ã‚¹ãƒšãƒ¼ã‚¹:</strong> ã€Œé‹è¡Œç®¡ç†è€…ã€€æŠ¼å°ã€ã®ãƒ©ãƒ™ãƒ«ã¨60pxÃ—60pxã®æŠ¼å°æ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜:</strong> ã€Œâ€»æœ¬æŒ‡ç¤ºæ›¸ã¯è¼¸é€å®‰å…¨è¦å‰‡ã«æ²¿ã£ãŸè¨˜è¼‰é …ç›®ã‚’å«ã¿ã¾ã™ã€‚ç‚¹å‘¼ç°¿ãƒ»é‹è»¢æ—¥å ±ã¨ä½µã›ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>æ¡ˆä»¶æƒ…å ±:</strong> å¼•å–å…ˆã€é…é€å…ˆã€ç©è·ã€æ•°é‡ç­‰ã®æƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒ»è»Šä¸¡æƒ…å ±:</strong> å„ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="test-button" onclick="testSingleOrder()">å˜ä¸€æ¡ˆä»¶ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testMultipleOrders()">è¤‡æ•°æ¡ˆä»¶ãƒ†ã‚¹ãƒˆï¼ˆ3ä»¶ï¼‰</button>
            <button class="test-button" onclick="testManyOrders()">è¤‡æ•°æ¡ˆä»¶ãƒ†ã‚¹ãƒˆï¼ˆ5ä»¶ï¼‰</button>
        </div>
    </div>

    <script>
        // ä¼šç¤¾æƒ…å ±ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©ï¼‰
        const companyInfo = {
            name: 'ãƒ†ã‚¹ãƒˆé‹é€æ ªå¼ä¼šç¤¾',
            address: 'ã€’123-4567 æ±äº¬éƒ½æ¸‹è°·åŒºãƒ†ã‚¹ãƒˆç”º1-2-3',
            tel: '03-1234-5678'
        };

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        function createSampleOrder(index) {
            const date = new Date();
            date.setDate(date.getDate() + index);
            
            return {
                id: index + 1,
                date: date.toISOString().split('T')[0],
                customerName: `æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«${index + 1}`,
                pickupLocation: `å¼•å–å…ˆ${index + 1}`,
                pickupAddress: `æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿${index + 1}-${index + 1}-${index + 1}`,
                deliveryLocation: `é…é€å…ˆ${index + 1}`,
                deliveryAddress: `ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚ä¸­åŒºå±±ä¸‹ç”º${index + 1}-${index + 1}`,
                deliveryTel: `045-123-456${index}`,
                cargo: `ã‚µãƒ³ãƒ—ãƒ«è²¨ç‰©${index + 1}`,
                packaging: 'ãƒ‘ãƒ¬ãƒƒãƒˆ',
                quantity: (index + 1) * 10,
                unit: 'å€‹',
                instructions: `æ¡ˆä»¶${index + 1}ã®å€‹åˆ¥æŒ‡ç¤ºäº‹é …ã§ã™ã€‚\næ™‚é–“å³å®ˆã§ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
                driver: 'å±±ç”°å¤ªéƒ',
                vehicle: 'å“å·500ã‚1234',
                instructionSheet: false
            };
        }

        // ãƒ€ãƒŸãƒ¼ã®é–¢æ•°ï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ã‚‹é–¢æ•°ï¼‰
        function saveData() {
            console.log('saveData called');
        }
        
        function cloudEnabled() {
            return false;
        }
        
        function cloudBatchUpdate() {
            console.log('cloudBatchUpdate called');
        }
        
        function renderTable() {
            console.log('renderTable called');
        }
        
        function updateStats() {
            console.log('updateStats called');
        }

        // å®Œå…¨ç‰ˆã®é‹è¡ŒæŒ‡ç¤ºæ›¸å°åˆ·é–¢æ•°
        function printInstructionsWithSettings(printOrders, dispatchTime) {
            // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰
            if (printOrders.length > 1) {
                const drivers = Array.from(new Set(
                    printOrders
                        .map(o => (o.driver || '').trim())
                        .filter(d => d.length > 0)
                ));
                if (drivers.length > 1) {
                    alert('è¤‡æ•°é¸æŠæ™‚ã¯åŒä¸€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§å°åˆ·ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰');
                    return;
                }
            }
            
            // é‹è¡ŒæŒ‡ç¤ºæ›¸ã®ç”Ÿæˆ
            let printContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>é‹è¡ŒæŒ‡ç¤ºæ›¸</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 10mm 15mm;
                        }
                        body { 
                            font-family: 'MS Gothic', 'ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯', monospace; 
                            font-size: 10pt;
                            line-height: 1.3;
                            color: #000;
                        }
                        .page { 
                            page-break-after: always;
                            position: relative;
                            width: 100%;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 8px;
                        }
                        .title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin-bottom: 2px;
                        }
                        .company-info {
                            font-size: 9pt;
                            line-height: 1.2;
                        }
                        
                        /* é…è»Šæ™‚é–“ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
                        .dispatch-time {
                            font-size: 16pt;
                            font-weight: bold;
                            margin: 10px 0 15px 0;
                            padding: 10px;
                            background: #ffffcc;
                            border: 2px solid #000;
                            text-align: center;
                        }
                        
                        /* è¤‡æ•°æ¡ˆä»¶ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                        .multi-orders {
                            margin-top: 10px;
                        }
                        .order-section {
                            margin-bottom: 15px;
                            border: 2px solid #000;
                            padding: 5px;
                        }
                        .order-header-outside {
                            font-size: 12pt;
                            font-weight: bold;
                            margin: 6px 0 6px 0;
                            line-height: 1.4;
                        }
                        .compact-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 5px;
                            font-size: 9pt;
                        }
                        .compact-table th {
                            background: #eeeeee;
                            border: 1px solid #000;
                            padding: 2px 4px;
                            text-align: left;
                            width: 20%;
                            font-weight: normal;
                        }
                        .compact-table td {
                            border: 1px solid #000;
                            padding: 2px 4px;
                        }
                        .instructions-compact {
                            border: 1px solid #000;
                            padding: 3px 5px;
                            font-size: 8pt;
                            min-height: 25px;
                            margin-bottom: 5px;
                        }
                        
                        /* æ¨™æº–æŒ‡ç¤ºäº‹é …ï¼ˆè¤‡æ•°æ¡ˆä»¶ç”¨ï¼‰ */
                        .standard-instructions {
                            font-size: 8pt;
                            line-height: 1.5;
                            margin-top: 10px;
                            padding: 8px;
                            background: #f5f5f5;
                            border: 1px solid #000;
                        }
                        
                        /* æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”» */
                        .operation-plan {
                            border: 1px solid #000;
                            padding: 8px;
                            font-size: 9pt;
                            margin-top: 10px;
                        }
                        .operation-plan-title {
                            font-size: 10pt;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .plan-table {
                            width: 100%;
                        }
                        .plan-table td {
                            padding: 3px 0;
                            font-size: 9pt;
                            vertical-align: bottom;
                        }
                        .plan-label {
                            width: 30%;
                        }
                        .plan-value {
                            border-bottom: 1px solid #000;
                            width: 70%;
                        }
                        
                        /* æŠ¼å°ã‚¹ãƒšãƒ¼ã‚¹ */
                        .signature-area {
                            margin-top: 10px;
                            text-align: right;
                        }
                        .signature-box {
                            display: inline-block;
                            text-align: center;
                        }
                        .signature-label {
                            font-size: 9pt;
                            margin-bottom: 3px;
                        }
                        .signature-stamp {
                            border: 1px solid #000;
                            width: 60px;
                            height: 60px;
                            display: inline-block;
                        }
                        
                        /* ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜ */
                        .footer-note {
                            font-size: 8pt;
                            margin-top: 10px;
                            line-height: 1.3;
                        }
                    </style>
                </head>
                <body>
            `;
            
            // è¤‡æ•°æ¡ˆä»¶ã‚’1æšã«ã¾ã¨ã‚ã‚‹å ´åˆ
            const MULTI_ORDERS_PER_PAGE = 4;
            
            for (let startIdx = 0; startIdx < printOrders.length; startIdx += MULTI_ORDERS_PER_PAGE) {
                const chunk = printOrders.slice(startIdx, startIdx + MULTI_ORDERS_PER_PAGE);
                const isLastPage = (startIdx + MULTI_ORDERS_PER_PAGE) >= printOrders.length;
                const isFirstPage = (startIdx === 0);

                printContent += `
                    <div class="page">
                        <div class="header">
                            <div class="title">é‹è¡ŒæŒ‡ç¤ºæ›¸ï¼ˆè²¨ç‰©ï¼‰</div>
                            <div class="company-info">
                                ${companyInfo.name}<br>
                                ${companyInfo.address}<br>
                                TELãƒ»FAX ${companyInfo.tel}
                            </div>
                        </div>
                `;
                
                // é…è»Šæ™‚é–“ã‚’1ãƒšãƒ¼ã‚¸ç›®ã®æœ€åˆã®æ¡ˆä»¶ã®ä¸Šã«è¡¨ç¤º
                if (isFirstPage && dispatchTime) {
                    printContent += `
                        <div class="dispatch-time">
                            1ä»¶ç›®ã®é…è»Šæ™‚é–“: ${dispatchTime}
                        </div>
                    `;
                }

                printContent += `<div class="multi-orders">`;

                // ã“ã®ãƒšãƒ¼ã‚¸ã«è¼‰ã›ã‚‹æ¡ˆä»¶ã‚’è¡¨ç¤º
                chunk.forEach((order, idx) => {
                    const globalIdx = startIdx + idx;
                    const orderDate = order.date ? new Date(order.date).toLocaleDateString('ja-JP') : '';
                    
                    printContent += `
                        <div class="order-header-outside">
                            ${globalIdx + 1}ä»¶ç›®: ${order.customerName || order.customer_name || ''} (${orderDate})
                        </div>
                        <div class="order-section">
                            <table class="compact-table">
                                <tr>
                                    <th>å¼•å–å…ˆ</th>
                                    <td>${order.pickupLocation || order.pickup_location || ''}</td>
                                    <th>é…é€å…ˆ</th>
                                    <td>${order.deliveryLocation || order.delivery_location || ''}</td>
                                </tr>
                                <tr>
                                    <th>å¼•å–ä½æ‰€</th>
                                    <td colspan="3">${order.pickupAddress || order.pickup_address || ''}</td>
                                </tr>
                                <tr>
                                    <th>é…é€ä½æ‰€</th>
                                    <td colspan="3">${order.deliveryAddress || order.delivery_address || ''}</td>
                                </tr>
                                <tr>
                                    <th>ç©è·</th>
                                    <td>${order.cargo || ''}</td>
                                    <th>æ•°é‡</th>
                                    <td>${order.quantity || ''} ${order.unit || ''}</td>
                                </tr>
                            </table>
                            <div class="instructions-compact">
                                <strong>æŒ‡ç¤ºäº‹é …:</strong> ${(order.instructions || '').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                });

                printContent += `</div>`;

                const firstOrder = chunk[0];
                const driverName = firstOrder.driver || '';
                const vehicleName = firstOrder.vehicle || '';

                printContent += `
                    <div style="margin-top: 15px; font-size: 10pt;">
                        <div style="margin-bottom: 5px;">
                            <strong>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼:</strong> ${driverName}ã€€
                            <strong>è»Šä¸¡:</strong> ${vehicleName}
                        </div>
                    </div>
                `;

                // æœ€çµ‚ãƒšãƒ¼ã‚¸ã«ã®ã¿æ¨™æº–æŒ‡ç¤ºäº‹é …ã€æ³•ä»¤éµå®ˆã€æŠ¼å°ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜ã‚’è¡¨ç¤º
                if (isLastPage) {
                    printContent += `
                        <div class="standard-instructions">
                            <strong>ã€æ¨™æº–æŒ‡ç¤ºäº‹é …ã€‘</strong><br>
                            ãƒ»æ³•å®šé€Ÿåº¦ãƒ»è»Šé–“è·é›¢ãƒ»ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆå¾¹åº•<br>
                            ãƒ»é€£ç¶šé‹è»¢4æ™‚é–“ä»¥å†…ã”ã¨ã«30åˆ†ä»¥ä¸Šã®ä¼‘æ†©ï¼ˆåˆ†å‰²å¯ï¼‰<br>
                            ãƒ»è·å´©ã‚Œé˜²æ­¢ï¼å›ºç¸›ç¢ºèªã€å±é™ºäºˆæ¸¬é‹è»¢ã®å¾¹åº•<br>
                            ãƒ»å‡ºç™ºï¼å¸°åº«æ™‚ã®ç‚¹å‘¼ã€é…’æ°—å¸¯ã³ç„¡ãƒ»ä½“èª¿è‰¯å¥½ã‚’ç¢ºèª<br>
                            ãƒ»ç•°å¸¸ï¼äº‹æ•…ï¼æ¸‹æ»ç­‰ã¯é€Ÿã‚„ã‹ã«é…è»Šã¸é€£çµ¡
                        </div>
                        
                        <div class="operation-plan">
                            <div class="operation-plan-title">æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”»ï¼ˆç¾å ´è¨˜å…¥å¯ï¼‰</div>
                            <table class="plan-table">
                                <tr>
                                    <td class="plan-label">å‡ºç™ºäºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">åˆ°ç€äºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">é‹è¡ŒçµŒè·¯ãƒ»ä¸»ãªçµŒç”±åœ°ï¼ˆæ—¥æ™‚ï¼‰</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">æ³¨æ„ãŒå¿…è¦ãªç®‡æ‰€ã®ä½ç½®</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">ä¼‘æ†©åœ°ç‚¹ã¨æ™‚é–“</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">äº¤ä»£åœ°ç‚¹</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding-top: 5px;">ãã®ä»– å®‰å…¨ç¢ºä¿ã«å¿…è¦ãªäº‹é …</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="plan-value">&nbsp;</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-label">é‹è¡Œç®¡ç†è€…ã€€æŠ¼å°</div>
                                <div class="signature-stamp"></div>
                            </div>
                        </div>
                        
                        <div class="footer-note">
                            â€»æœ¬æŒ‡ç¤ºæ›¸ã¯è¼¸é€å®‰å…¨è¦å‰‡ã«æ²¿ã£ãŸè¨˜è¼‰é …ç›®ã‚’å«ã¿ã¾ã™ã€‚ç‚¹å‘¼ç°¿ãƒ»é‹è»¢æ—¥å ±ã¨ä½µã›ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    `;
                }

                printContent += `</div>`;
            }

            printContent += `
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            // æŒ‡ç¤ºæ›¸ç™ºè¡Œãƒ•ãƒ©ã‚°æ›´æ–°
            printOrders.forEach(order => {
                order.instructionSheet = true;
            });
            saveData();
            // ã‚¯ãƒ©ã‚¦ãƒ‰ä¸€æ‹¬æ›´æ–°
            try {
                if (cloudEnabled()) {
                    const ids = printOrders.map(o => o.id).filter(id => id != null);
                    cloudBatchUpdate(ids, { instructionSheet: true });
                }
            } catch(e) {}
            renderTable();
            updateStats();
        }

        // ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testSingleOrder() {
            const orders = [createSampleOrder(0)];
            printInstructionsWithSettings(orders, '08:30');
        }

        function testMultipleOrders() {
            const orders = [
                createSampleOrder(0),
                createSampleOrder(1),
                createSampleOrder(2)
            ];
            printInstructionsWithSettings(orders, '09:00');
        }

        function testManyOrders() {
            const orders = [
                createSampleOrder(0),
                createSampleOrder(1),
                createSampleOrder(2),
                createSampleOrder(3),
                createSampleOrder(4)
            ];
            printInstructionsWithSettings(orders, '07:30');
        }
    </script>
</body>
</html>

