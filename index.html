<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹é€æ¥­å—æ³¨æ˜ç´°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #e5e7eb;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .month-badge {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .today-date {
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-sub {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
        .action-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.25rem;
        }

        .action-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            max-width: 100%;
        }

        .action-row + .action-row {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-main);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        .btn-nav {
            padding: 0.375rem 0.625rem;
            font-size: 0.8rem;
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-nav:hover {
            background: var(--bg-main);
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            appearance: none;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
/* === å—æ³¨ä¸€è¦§ã®æ¨ªå¹…ã‚’â€œå¼·åˆ¶â€ã§æˆ»ã™ï¼ˆå‹ã¦ã‚‹æŒ‡å®šï¼‰ === */
.container .table-wrapper {
  max-width: 1200px !important;  /* ã“ã“ã§ä¸Šé™ã‚’æ±ºã‚ã‚‹ï¼šãŠå¥½ã¿ã§ 1100/1300 ã«èª¿æ•´OK */
  width: 100% !important;        /* ãƒ©ãƒƒãƒ‘ãƒ¼è‡ªä½“ã¯ã‚³ãƒ³ãƒ†ãƒŠå¹…ã«å¯¾ã—ã¦100% */
  margin-left: auto !important;  /* ä¸­å¤®å¯„ã› */
  margin-right: auto !important;
}

/* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç¶­æŒ */
.container .table-wrapper .table-scroll {
  overflow-x: auto !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã¯ãƒ©ãƒƒãƒ‘ãƒ¼ã®ä¸­ã§100%ã«åã‚ã‚‹ */
#orderTable {
  width: 100% !important;
  border-collapse: collapse;
}


/* å—æ³¨ä¸€è¦§ã®æ¨ªå¹…ã‚’æˆ»ã—ã¦ä¸­å¤®å¯„ã›ã«ã™ã‚‹ */
.table-wrapper {
  max-width: 1400px;   /* ç”»é¢ã„ã£ã±ã„ã«åºƒãŒã‚‰ãªã„ä¸Šé™ã€‚å¥½ã¿ã§èª¿æ•´å¯ï¼ˆä¾‹: 1100, 1300ï¼‰ */
  margin: 0 auto;      /* ä¸­å¤®å¯„ã› */
}

.table-scroll {
  overflow-x: auto;    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¶­æŒ */
}

#orderTable {          /* ï¼ .data-table ã¨åŒç¾©ã§ã€ã“ã®ç”»é¢ã§ã¯ã“ã¡ã‚‰ãŒç¢ºå®Ÿ */
  width: 100%;         /* ãƒ©ãƒƒãƒ‘ãƒ¼ã®ä¸­ã§ãƒ•ã‚£ãƒƒãƒˆ */
  border-collapse: collapse;
}

        .table-scroll {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-main);
            color: var(--text-primary);
            padding: 0.5rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .data-table td {
            padding: 0.35rem 0.4rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            line-height: 1.2;
            vertical-align: middle;
        }

        /* å—æ³¨ä¸€è¦§ï¼šè¡Œã®ç¸æ¨¡æ§˜ï¼ˆç™½ï¼è–„ã„é’ï¼‰ */
        .data-table tbody tr:nth-child(odd) {
            background: #ffffff;
        }
        .data-table tbody tr:nth-child(even) {
            background: #f0f7ff; /* è–„ã„é’ï¼ˆå…ƒã®è¨­å®šï¼‰ */
        }

        .data-table tr:hover {
            background: var(--bg-main);
        }

        .data-table tr.row-selected {
            background: #fed7aa !important; /* æŒ‡ç¤ºæ›¸ã€Œæœªã€ã¨åŒè‰²ï¼ˆè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
        }
        .data-table tr.row-selected:hover {
            background: #fdba74 !important; /* ãƒ›ãƒãƒ¼æ™‚ã¯å°‘ã—æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .checkbox {
            width: 0.9rem;
            height: 0.9rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-small {
            width: 0.8rem;
            height: 0.8rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* ãƒãƒƒã‚¸ */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.45rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fed7aa;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        /* ç©è·ã‚«ãƒ©ãƒ¼ */
        .cargo-tomato { background: #fee2e2; color: #991b1b; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-potato { background: #fef3c7; color: #92400e; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-onion { background: #f3e8ff; color: #6b21a8; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-cabbage { background: #dcfce7; color: #166534; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-carrot { background: #fed7aa; color: #7c2d12; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-melon { background: #fce7f3; color: #9f1239; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-corn { background: #fef9c3; color: #713f12; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-pumpkin { background: #ffedd5; color: #9a3412; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-squid { background: #dbeafe; color: #1e40af; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-salmon { background: #ffe4e6; color: #881337; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-scallop { background: #e0e7ff; color: #3730a3; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-fish { background: #cffafe; color: #155e75; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-frozen { background: #ede9fe; color: #5b21b6; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }
        .cargo-other { background: #f3f4f6; color: #374151; padding: 0.05rem 0.35rem; border-radius: 3px; font-weight: 500; font-size: 0.75rem; }

        /* ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚«ãƒ©ãƒ¼ */
        .driver-1 {
            background: #fef3c7;
            color: #92400e;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .driver-2 {
            background: #fce7f3;
            color: #9f1239;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .driver-3 {
            background: #e9d5ff;
            color: #6b21a8;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .driver-4 {
            background: #ccfbf1;
            color: #134e4a;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .driver-5 {
            background: #fed7aa;
            color: #7c2d12;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        /* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow);
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:hover {
            background: var(--bg-main);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            margin: 3rem auto;
            border-radius: 12px;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .modal-content.small {
            max-width: 500px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

.modal-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background: #fff;}


        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: var(--bg-main);
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.close-button {
    position: static;
    width: 48px;
    height: 48px;
    font-size: 1.75rem;
    line-height: 1;
    margin-left: auto;
    border-radius: 10px;
}

@media (pointer: coarse) {
    .close-button {
        width: 56px;
        height: 56px;
        font-size: 2rem;
    }
}


        .close-button:hover {
            background: var(--bg-main);
            color: var(--text-primary);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
        }

        .form-label::before {
            content: 'â–  ';
            color: var(--primary);
        }

        .form-input-full {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: #fff;
            transition: all 0.15s ease;
            min-height: 40px;
        }

        .form-input-full:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: #fff;
        }

        .form-input-full::placeholder {
            color: #94a3b8;
        }

        /* IME/å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®ãƒ’ãƒ³ãƒˆ */
        .jp-input {
            ime-mode: active; /* ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§æ—¥æœ¬èªIMEã‚’å„ªå…ˆï¼ˆéæ¨™æº–ï¼‰ */
        }
        .numeric-input {
            ime-mode: disabled; /* æ•°å€¤æ¬„ã§ã¯IMEã‚’ã‚ªãƒ•ï¼ˆéæ¨™æº–ï¼‰ */
        }

        .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 80px;
            background: #fff;
        }

        /* ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« */
        .master-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .master-table th {
            background: var(--bg-main);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 2px solid var(--border);
        }

        .master-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .master-table tr:hover {
            background: var(--bg-main);
        }

        .master-actions {
            display: flex;
            gap: 0.5rem;
        }

        .master-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .master-item {
            background: var(--bg-main);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
            transition: all 0.2s ease;
        }

        .master-item:hover {
            background: #e2e8f0;
        }

        .master-item.dragging {
            opacity: 0.5;
        }

        .master-item-content {
            flex: 1;
        }

        .master-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drag-handle {
            cursor: move;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .master-item button {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
        }

        /* æ—¥ä»˜é¸æŠ */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
/* ===== ãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ä¿®æ­£ï¼ˆinput[type=date]ãƒ»textareaç”¨ï¼‰ ===== */
input[type="date"],
textarea {
    font-family: inherit !important;
    color: var(--text-primary);
    font-size: 0.875rem;
}
/* ===== ä¸€è¦§ã‚¿ã‚°ã®ãƒ™ãƒ¼ã‚¹ï¼ˆstyleã§è‰²ã ã‘ä¸Šæ›¸ãï¼‰ ===== */
.tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 9999px;
  font-size: 12px;
  line-height: 1.8;
  vertical-align: middle;
  white-space: nowrap;
}
/* ====== å—æ³¨ä¸€è¦§ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ç”»é¢å¹…ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ ====== */

/* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æ¶²ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ï¼ˆä¸­å¤®å›ºå®šã®ä¸Šé™ã‚’è§£é™¤ï¼‰ */
.container {
  max-width: 100% !important;
}

/* ä¸€è¦§ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¯å¸¸ã«ç”»é¢å¹…ã„ã£ã±ã„ */
.table-wrapper,
.table-scroll {
  width: 100% !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã¯å¸¸ã«ãƒ©ãƒƒãƒ‘ãƒ¼ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
.data-table,
#orderTable {
  width: 100% !important;
  table-layout: auto;         /* å†…å®¹ã«å¿œã˜ã¦åˆ—å¹…ã‚’èª¿æ•´ï¼ˆå¿…è¦ãªã‚‰ fixed ã«å¤‰æ›´ï¼‰ */
}

/* åˆ—ãŒå¤šã„ã¨ãã¯ã‚¹ãƒãƒ›ç­‰ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã« */
.table-scroll {
  overflow-x: auto !important;
}

/* æ–‡å­—ãŒã¯ã¿å‡ºã—ã¦ã‚¬ã‚¿ã¤ãã®ã‚’æŠ‘ãˆã‚‹ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
.data-table th,
.data-table td {
  white-space: nowrap;        /* æŠ˜ã‚Šè¿”ã—é˜²æ­¢ï¼ˆè¦ã‚‰ãªã‘ã‚Œã°å¤–ã™ï¼‰ */
  overflow: hidden;
  text-overflow: ellipsis;    /* åã¾ã‚Šãã‚‰ãªã„æ–‡å­—ã¯â€¦çœç•¥è¡¨ç¤º */
}

/* ä½™ç™½ã®å‡ä¸€åŒ–ï¼šç”»é¢ç«¯ã«ãƒ™ã‚¿ä»˜ãã—ã™ãã‚‹æ™‚ã¯é©åº¦ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
.container,
.action-bar,
.table-wrapper {
  padding-left: 1rem;
  padding-right: 1rem;
}

/* å¤§ç”»é¢ã§å­—ãŒè©°ã¾ã‚Šã™ãã‚‹å ´åˆã®å¾®èª¿æ•´ï¼ˆä»»æ„ï¼‰ */
@media (min-width: 1440px) {
  .data-table th { font-size: 0.8rem; }
  .data-table td { font-size: 0.8rem; }
}
/* ===== å—æ³¨ä¸€è¦§ã‚’ä¸Šéƒ¨ã‚³ãƒ³ãƒ†ãƒŠã¨åŒã˜å¹…ã§ä¸­å¤®å¯„ã› ===== */
.table-wrapper {
  max-width: 1800px !important;  /* ä¸Šéƒ¨ã® .container ã¨åŒã˜å¹… */
  width: 100%;
  margin-left: auto !important;
  margin-right: auto !important;
  border-radius: 8px;
  background: var(--bg-card);
}

.table-scroll {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}
/* ===== ä¸Šéƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¨å—æ³¨ä¸€è¦§ã®ç™½æ å¹…ã‚’çµ±ä¸€ ===== */

/* ä¸Šéƒ¨ãƒœã‚¿ãƒ³ç¾¤ï¼ˆaction-barï¼‰ã¨å—æ³¨ä¸€è¦§ï¼ˆtable-wrapperï¼‰ã®æ¨ªå¹…ã‚’åŒä¸€ã« */
.action-bar,
.table-wrapper {
  max-width: 1800px;          /* ä¸Šé™ã‚’çµ±ä¸€ã€‚å¿…è¦ã«å¿œã˜ã¦ 1600px ãªã©ã«èª¿æ•´ */
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  border-radius: 8px;
  background: var(--bg-card);
  box-shadow: var(--shadow-sm);
}

/* ã‚¹ãƒãƒ›å¯¾å¿œï¼šç”»é¢ãŒç‹­ã„æ™‚ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã—ã¦ä½™ç™½ã‚’è©°ã‚ã‚‹ */
@media (max-width: 1024px) {
  .action-bar,
  .table-wrapper {
    max-width: 100%;
    border-radius: 0;
    box-shadow: none;
  }
}
/* === é¡§å®¢ååˆ—ã®å¹…ã‚’å›ºå®šã—ã¦ã€é•·ã„ã¨ãã¯ä¸‹ã«æŠ˜ã‚Šè¿”ã™ï¼ˆéš£åˆ—ã«è¢«ã‚‰ãªã„ï¼‰ === */

/* é¡§å®¢åã®ã‚»ãƒ«å¹…å›ºå®šï¼‹æŠ˜ã‚Šè¿”ã—è¨±å¯ */
#orderTable th:nth-child(3),
#orderTable td:nth-child(3) {
  width: 200px;              /* â˜…é¡§å®¢åã®æœ€å¤§å¹…ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ 180ã€œ250pxï¼‰ */
  min-width: 200px;
  white-space: normal !important;
  word-break: break-word;
  line-height: 1.3;
  vertical-align: top;       /* æŠ˜ã‚Šè¿”ã—ãŸã¨ãã«ä¸Šå¯„ã› */
}

/* è¡¨å…¨ä½“ã®è‡ªå‹•èª¿æ•´ã‚’ONã«ã—ã¦ã€æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é¿ã‘ã‚‹ */
#orderTable {
  table-layout: auto;
}

/* å¼•å–å…ˆãƒ»é…é€å…ˆãªã©ã¯è‡ªå‹•å¹…ã« */
#orderTable td:nth-child(4),
#orderTable td:nth-child(5) {
  white-space: nowrap;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«ãŒæ®µå·®ã«ãªã£ã¦ã‚‚è¡Œå¢ƒç•Œã‚’ç›®ç«‹ãŸã›ãªã„ï¼ˆå¥½ã¿ï¼‰ */
#orderTable td {
  vertical-align: top;
}
/* === é¡§å®¢åãƒ»å¼•å–å…ˆãƒ»é…é€å…ˆã®åˆ—å¹…ã‚’å›ºå®šã—ã¦æŠ˜ã‚Šè¿”ã—è¡¨ç¤º === */
#orderTable th:nth-child(3),
#orderTable td:nth-child(3),   /* é¡§å®¢å */
#orderTable th:nth-child(4),
#orderTable td:nth-child(4),   /* å¼•å–å…ˆ */
#orderTable th:nth-child(5),
#orderTable td:nth-child(5) {  /* é…é€å…ˆ */
  width: 150px;                /* â˜…åˆ—ã®åŸºæœ¬å¹…ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ 200ã€œ250pxï¼‰ */
  min-width: 150px;
  white-space: normal !important;  /* æŠ˜ã‚Šè¿”ã—è¨±å¯ */
  word-break: break-word;          /* æ—¥æœ¬èªã§ã‚‚è‡ªç„¶ã«æ”¹è¡Œ */
  line-height: 1.3;
  vertical-align: top;             /* ä¸Šå¯„ã›è¡¨ç¤º */
}

/* è¡¨å…¨ä½“ã‚’è‡ªå‹•èª¿æ•´ãƒ¢ãƒ¼ãƒ‰ã«ï¼ˆåˆ—å¹…ã‚’æŸ”è»Ÿã«ï¼‰ */
#orderTable {
  table-layout: auto;
}

/* ä¿å­˜ç›´å¾Œã«è¡Œã‚’ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#tableBody tr { transition: background-color 450ms ease; }
#tableBody tr.row-highlight { background-color: #fff3cd; }

        /* é‹è¡ŒæŒ‡ç¤ºæ›¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .order-sequence-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: move;
            transition: all 0.2s;
        }
        
        .order-sequence-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .order-sequence-item.dragging {
            opacity: 0.4;
        }
        
        .drag-handle {
            font-size: 20px;
            color: #94a3b8;
            margin-right: 12px;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .order-number {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
            margin-right: 12px;
            min-width: 30px;
        }
        
        .order-info {
            flex: 1;
            font-size: 14px;
        }

    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>é‹é€æ¥­å—æ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div class="month-navigation">
                    <button class="btn btn-nav" onclick="prevMonth()">â†</button>
                    <div class="month-badge" id="currentMonth">2024å¹´9æœˆ</div>
                    <button class="btn btn-nav" onclick="nextMonth()">â†’</button>
                </div>
            </div>
            <div class="today-date" id="todayDate">9/28 åœŸæ›œæ—¥</div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">å½“æœˆå£²ä¸Šé«˜ï¼ˆç¨è¾¼ï¼‰</div>
                <div class="stat-value" id="totalGross">Â¥0</div>
                <div class="stat-sub">ç¨æŠœ: <span id="totalNet">Â¥0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å—æ³¨ä»¶æ•°</div>
                <div class="stat-value" id="orderCount">0ä»¶</div>
                <div class="stat-sub">æœªå®Œäº†: <span id="incompleteCount">0ä»¶</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ¬æ—¥é…é€äºˆå®š</div>
                <div class="stat-value" id="todayDeliveryCount">0ä»¶</div>
                <div class="stat-sub">é…é€äºˆå®š</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¿Œæ—¥é…é€äºˆå®š</div>
                <div class="stat-value" id="tomorrowDeliveryCount">0ä»¶</div>
                <div class="stat-sub">é…é€äºˆå®š</div>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
        <div class="action-bar">
<div class="action-row">
    <!-- 1è¡Œç›®ï¼šæ¥­å‹™ãƒœã‚¿ãƒ³ï¼ˆæŒ‡å®šé †ï¼‰ -->
    <button class="btn btn-primary" onclick="openModal()">ï¼‹ æ–°è¦å—æ³¨</button>

    <button class="btn btn-warning" onclick="printInstructions()">ğŸ“„ é‹è¡ŒæŒ‡ç¤ºæ›¸ï¼ˆé¸æŠåˆ†ï¼‰</button>
    <button class="btn btn-warning" onclick="printPickupSlips()">ğŸ“‹ å¼•å–æ›¸ï¼ˆé¸æŠåˆ†ï¼‰</button>

    <button class="btn btn-warning" onclick="exportInvoiceCSV()">ğŸ’° è«‹æ±‚æ›¸CSVï¼ˆMFç”¨ï¼‰</button>
    <button class="btn btn-success" onclick="exportCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
    <button class="btn btn-secondary" onclick="chooseExportDir()">ğŸ’¾ CSVä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€è¨­å®š</button>
    <button class="btn btn-secondary" onclick="openCloudSettings()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šï¼ˆSupabaseï¼‰</button>
    <span id="cloudStatus" style="margin-left: 8px; font-size: 0.85rem; padding: 2px 6px; border-radius: 12px; background: #eee;">æ¥ç¶š: ãƒ­ãƒ¼ã‚«ãƒ«</span>

    <!-- CSVå–è¾¼ï¼ˆéš ã—inputã¯ã“ã®ã¾ã¾åˆ©ç”¨ï¼‰ -->
    <input type="file" id="csvImport" accept=".csv" style="display: none;" onchange="importCSV(event)">
    <button class="btn btn-secondary" onclick="document.getElementById('csvImport').click()">ğŸ“ CSVå–è¾¼</button>
</div>

<div class="action-row">
    <!-- 2è¡Œç›®ï¼šãƒã‚¹ã‚¿ç³»ï¼ˆå¸¸ã«ã“ã®è¡Œã«ä¸¦ã¹ã‚‹ï¼‰ -->
    <button class="btn btn-secondary" onclick="openCustomerMaster()">ğŸ‘¥ é¡§å®¢ãƒã‚¹ã‚¿</button>
    <button class="btn btn-secondary" onclick="openCargoMaster()">ğŸ“¦ ç©è·ãƒã‚¹ã‚¿</button>
    <button class="btn btn-secondary" onclick="openPackagingMaster()">ğŸ“‹ è·å§¿ãƒã‚¹ã‚¿</button>
    <button class="btn btn-secondary" onclick="openUnitMaster()">ğŸ“ å˜ä½ãƒã‚¹ã‚¿</button>
    <button class="btn btn-secondary" onclick="openDriverMaster()">ğŸ‘¤ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒã‚¹ã‚¿</button>
    <button class="btn btn-secondary" onclick="openVehicleMaster()">ğŸšš è»Šä¸¡ãƒã‚¹ã‚¿</button>
</div>

<div class="action-row">
    <!-- 3è¡Œç›®ï¼šæ¤œç´¢/ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå…ƒã®ã¾ã¾ç§»è¨­ï¼‰ -->
    <input type="text" class="form-input" placeholder="æ¤œç´¢..." id="searchInput" onkeyup="filterTable()" style="width: 200px;">
    <div class="date-filter">
        <label style="font-size: 0.875rem;">æ—¥ä»˜æŒ‡å®š:</label>
        <input type="date" class="form-input" id="dateFilter" onchange="filterTable()">
        <button class="btn btn-sm btn-secondary" onclick="clearDateFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <select class="form-select" id="sortOrder" onchange="sortTable()" style="width: 120px;">
        <option value="date-asc">æ—¥ä»˜é †</option>
        <option value="id-asc">ç™»éŒ²é †</option>
    </select>
    <select class="form-select" id="driverFilter" onchange="filterTable()">
        <option value="">å…¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
    </select>
    <input type="text" class="form-input" id="customerFilterSearch" list="customerFilterList" placeholder="é¡§å®¢æ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰" oninput="filterTable()" style="width: 180px;" />
    <datalist id="customerFilterList"></datalist>
</div>

            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="table-wrapper">
            <div class="table-scroll">
                <table class="data-table" id="orderTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>æ—¥ä»˜</th>
                            <th>é¡§å®¢å</th>
                            <th>å¼•å–å…ˆ</th>
                            <th>é…é€å…ˆ</th>
                            <th>ç©è·</th>
                            <th>æ•°é‡</th>
                            <th>è·å§¿</th>
                            <th>å˜ä¾¡</th>
                            <th>é‡‘é¡ï¼ˆç¨åˆ¥ï¼‰</th>
                            <th>é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</th>
                            <th>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</th>
                            <th>è»Šä¸¡</th>
                            <th>æŒ‡ç¤ºæ›¸</th>
                            <th>è«‹æ±‚æ›¸</th>
                            <th>å…¥é‡‘</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å—æ³¨ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°è¦å—æ³¨ç™»éŒ²</h2>
                <button class="close-button" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">å—æ³¨No <span style="color: red;">*å¿…é ˆ</span></label>
                            <input type="text" class="form-input-full numeric-input" id="orderNo" required lang="en" inputmode="text">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ—¥ä»˜ <span style="color: red;">*å¿…é ˆ</span></label>
                            <input type="date" class="form-input-full" id="orderDate" required>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">é¡§å®¢å <span style="color: red;">*å¿…é ˆ</span></label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-input-full jp-input" id="customerName" required oninput="filterMaster(this.value, 'customer')" lang="ja" inputmode="text">
                                <div class="autocomplete-list" id="customerAutocomplete"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¼•å–å…ˆ <span style="color: red;">*å¿…é ˆ</span></label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-input-full jp-input" id="pickupLocation" required oninput="filterMaster(this.value, 'pickup')" lang="ja" inputmode="text">
                                <div class="autocomplete-list" id="pickupAutocomplete"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¼•å–å…ˆä½æ‰€</label>
                            <input type="text" class="form-input-full jp-input" id="pickupAddress" lang="ja" inputmode="text">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é…é€å…ˆ <span style="color: red;">*å¿…é ˆ</span></label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-input-full jp-input" id="deliveryLocation" required oninput="filterMaster(this.value, 'delivery')" lang="ja" inputmode="text">
                                <div class="autocomplete-list" id="deliveryAutocomplete"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é…é€å…ˆä½æ‰€</label>
                            <input type="text" class="form-input-full jp-input" id="deliveryAddress" lang="ja" inputmode="text">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç©è· <span style="color: red;">*å¿…é ˆ</span></label>
                            <select class="form-input-full" id="cargo" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ•°é‡</label>
                            <input type="number" class="form-input-full numeric-input" id="quantity" onchange="calculateAmount()" inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å˜ä½</label>
                            <select class="form-input-full" id="unit">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è·å§¿</label>
                            <select class="form-input-full" id="packaging">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å˜ä¾¡ï¼ˆç¨æŠœï¼‰</label>
                            <input type="number" class="form-input-full numeric-input" id="unitPrice" onchange="calculateAmount()" inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é‡‘é¡ï¼ˆç¨åˆ¥ï¼‰</label>
                            <input type="number" class="form-input-full numeric-input" id="amountNet" onchange="calculateGrossFromNet()" inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>
                            <input type="number" class="form-input-full numeric-input" id="amountGross" readonly inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é…é€å…ˆé›»è©±ç•ªå·</label>
                            <input type="tel" class="form-input-full numeric-input" id="deliveryTel" inputmode="tel">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</label>
                            <select class="form-input-full" id="driver">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è»Šä¸¡</label>
                            <select class="form-input-full" id="vehicle">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">ç‰¹è¨˜äº‹é …</label>
                            <textarea class="form-textarea jp-input" id="instructions" lang="ja" inputmode="text"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveOrder()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="cloudSettingsModal">
        <div class="modal-content small">
            <div class="modal-header">
                <h2>ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šï¼ˆSupabaseï¼‰</h2>
                <button class="close-button" onclick="closeCloudSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project URL</label>
                    <input type="text" class="form-input-full" id="cloudProjectUrl" placeholder="https://xxxx.supabase.co">
                </div>
                <div class="form-group">
                    <label class="form-label">anon key</label>
                    <input type="text" class="form-input-full" id="cloudAnonKey" placeholder="é•·ã„è‹±æ•°å­—ã®ã‚­ãƒ¼">
                </div>
                <div class="form-group">
                    <label class="form-label"><input type="checkbox" id="cloudEnabledCheckbox"> ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ä½¿ç”¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæ™‚ä¿å­˜ï¼‰</label>
                </div>
                <div class="note" style="font-size: 0.85rem; color: #666;">
                    ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«åã¯ <code>orders</code> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
                    ãƒ»RLSã‚’æœ‰åŠ¹åŒ–ã—ã€ç¤¾å†…ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚<br>
                    ãƒ»ä¿å­˜æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCloudSettings()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveCloudSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="customerMasterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é¡§å®¢ãƒã‚¹ã‚¿ç®¡ç†</h2>
                <button class="close-button" onclick="closeCustomerMaster()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="openAddCustomerModal()">ï¼‹ æ–°è¦è¿½åŠ </button>
                    <input type="file" id="customerCsvImport" accept=".csv" style="display: none;" onchange="importCustomerCSV(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('customerCsvImport').click()">
                        ğŸ“ CSVå–è¾¼
                    </button>
                    <button class="btn btn-success" onclick="exportCustomerCSV()">
                        ğŸ“Š CSVå‡ºåŠ›
                    </button>
                </div>
                <table class="master-table">
                    <thead>
                        <tr>
                            <th>é¡§å®¢å</th>
                            <th>ä½æ‰€</th>
                            <th>é›»è©±ç•ªå·</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="customerMasterBody">
                        <!-- ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomerMaster()">é–‰ã˜ã‚‹</button>
                <button class="btn btn-primary" onclick="saveCustomerMaster()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ãã®ä»–ã®ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="simpleMasterModal">
        <div class="modal-content small">
            <div class="modal-header">
                <h2 id="simpleMasterTitle">ãƒã‚¹ã‚¿ç®¡ç†</h2>
                <button class="close-button" onclick="closeSimpleMaster()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" class="form-input-full jp-input" id="simpleMasterInput" placeholder="æ–°è¦è¿½åŠ ..." lang="ja" inputmode="text">
                        <button class="btn btn-primary" onclick="addSimpleMasterItem()">è¿½åŠ </button>
                    </div>
                </div>
                <div class="master-list" id="simpleMasterList">
                    <!-- ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSimpleMaster()">é–‰ã˜ã‚‹</button>
                <button class="btn btn-primary" onclick="saveSimpleMaster()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="customerAddModal">
        <div class="modal-content small">
            <div class="modal-header">
                <h2>é¡§å®¢ã‚’æ–°è¦è¿½åŠ </h2>
                <button class="close-button" onclick="closeCustomerAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerAddForm">
                    <div class="form-group">
                        <label class="form-label">é¡§å®¢å <span style="color: var(--danger);">*å¿…é ˆ</span></label>
                        <input type="text" class="form-input-full jp-input" id="newCustomerName" placeholder="ä¾‹ï¼‰å±±ç”°å•†äº‹" required lang="ja" inputmode="text">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä½æ‰€</label>
                        <input type="text" class="form-input-full jp-input" id="newCustomerAddress" placeholder="ä¾‹ï¼‰æ±äº¬éƒ½æ¸¯åŒº..." lang="ja" inputmode="text">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é›»è©±ç•ªå·</label>
                        <input type="tel" class="form-input-full numeric-input" id="newCustomerTel" placeholder="ä¾‹ï¼‰03-xxxx-xxxx" inputmode="tel">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomerAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveNewCustomer()">è¿½åŠ </button>
            </div>
        </div>
    </div>
    <!-- é‹è¡ŒæŒ‡ç¤ºæ›¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="instructionSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é‹è¡ŒæŒ‡ç¤ºæ›¸ã®è¨­å®š</h2>
                <button class="close-button" onclick="closeInstructionSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" style="font-size: 14pt; font-weight: bold;">1ä»¶ç›®ã®é…è»Šæ™‚é–“ <span style="color: var(--danger);">*å¿…é ˆ</span></label>
                    <input type="time" class="form-input-full" id="dispatchTime" required style="font-size: 16pt; padding: 12px;">
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label" style="font-size: 12pt; font-weight: bold;">é…é€é †åºï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆï¼‰</label>
                    <div id="orderSequenceList" style="margin-top: 10px;">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeInstructionSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="generateInstructionSheet()">é‹è¡ŒæŒ‡ç¤ºæ›¸ã‚’å‡ºåŠ›</button>
            </div>
        </div>
    </div>


    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        let orders = [];
        let currentMonth = new Date();
        let editingId = null;
        let currentMasterType = null;
        let draggedItem = null;

        // ä¼šç¤¾æƒ…å ±ï¼ˆãã‚‡ã†ã—ã‚“è¼¸é€æ ªå¼ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼‰
        let companyInfo = {
            name: 'ãã‚‡ã†ã—ã‚“è¼¸é€æ ªå¼ä¼šç¤¾',
            address: 'å¤•å¼µéƒ¡æ —å±±ç”ºå­—æ—­å°23ç•ªåœ°129',
            tel: '0123-76-9950'
        };

        // é¡§å®¢ãƒã‚¹ã‚¿
        let customerMaster = [
            { name: 'ãˆ±åŒ—æµ·é“é’æœ', address: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºå—1æ¡è¥¿5ä¸ç›®', tel: '011-211-1111' },
            { name: 'ãˆ±æœ­å¹Œå¸‚å ´', address: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—12æ¡è¥¿20ä¸ç›®', tel: '011-611-3111' },
            { name: 'ãˆ±é“å—ç‰©ç”£', address: 'å‡½é¤¨å¸‚è‹¥æ¾ç”º9-19', tel: '0138-22-3333' },
            { name: 'ãˆ±åŒ—æµ·é“å¸‚å ´', address: 'æœ­å¹Œå¸‚æ±åŒºåŒ—9æ¡æ±4ä¸ç›®', tel: '011-711-2222' },
            { name: 'ãˆ±æ—­å·é’æœ', address: 'æ—­å·å¸‚æµé€šå›£åœ°1æ¡2ä¸ç›®', tel: '0166-48-1111' },
            { name: 'ãˆ±å¸¯åºƒå¸‚å ´', address: 'å¸¯åºƒå¸‚è¥¿20æ¡å—1ä¸ç›®', tel: '0155-33-3333' },
            { name: 'ãˆ±é‡§è·¯æ°´ç”£', address: 'é‡§è·¯å¸‚æ–°å¯Œå£«ç”º6ä¸ç›®', tel: '0154-51-2222' },
            { name: 'ãˆ±å‡½é¤¨é’æœ', address: 'å‡½é¤¨å¸‚è¥¿æ¡”æ¢—ç”º589', tel: '0138-49-5555' },
            { name: 'JAåŒ—æµ·é“', address: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—4æ¡è¥¿1ä¸ç›®', tel: '011-232-6000' },
            { name: 'JAã•ã£ã½ã‚', address: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—10æ¡è¥¿24ä¸ç›®', tel: '011-621-1111' },
            { name: 'å €ç”° æ·³ä¸€', address: 'å¤•å¼µéƒ¡æ —å±±ç”ºé³©å±±ï¼”', tel: '0123-72-1234' },
            { name: 'JAãã‚‰ã¡å—æ —å±±ç”ºé¦¬éˆ´è–¯é›†å‡ºè·è²¯è”µã‚»ãƒ³ã‚¿ãƒ¼', address: 'å¤•å¼µéƒ¡æ —å±±ç”ºå¯Œå£«', tel: '0123-73-5678' },
            { name: 'JAãã‚‰ã¡å—æœ¬æ‰€è²©å£²éƒ¨', address: 'å¤•å¼µéƒ¡æ —å±±ç”ºè§’ç”°165ç•ªåœ°', tel: '0123-72-1468' }
        ];

        // ãã®ä»–ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
        let cargoMaster = ['ãƒˆãƒãƒˆ', 'ã˜ã‚ƒãŒã„ã‚‚', 'ç‰ã­ã', 'ã‚­ãƒ£ãƒ™ãƒ„', 'äººå‚', 'ãƒ¡ãƒ­ãƒ³', 'ã¨ã†ã‚‚ã‚ã“ã—', 'ã‹ã¼ã¡ã‚ƒ', 'ã„ã‹', 'é®­', 'ãƒ›ã‚¿ãƒ†', 'é®®é­š', 'å†·å‡é£Ÿå“', 'ãã®ä»–'];
        let packagingMaster = ['ãƒ€ãƒ³ãƒœãƒ¼ãƒ«', '10kg DB', 'éº»è¢‹20kg', 'ãƒ‘ãƒ¬ãƒƒãƒˆ', 'ã‚³ãƒ³ãƒ†ãƒŠ', 'ãƒ“ãƒ‹ãƒ¼ãƒ«è¢‹', 'ç™ºæ³¡ã‚¹ãƒãƒ­ãƒ¼ãƒ«', 'æœ¨ç®±', 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã‚±ãƒ¼ã‚¹'];
        let unitMaster = ['ã‚±ãƒ¼ã‚¹', 'å€‹', 'è¢‹', 'ç®±', 'ãƒ‘ãƒ¬ãƒƒãƒˆ', 'kg', 'å°'];

        // ä»•æ§˜ã‚µãƒãƒªï¼ˆæŒ™å‹•ã¯å¤‰æ›´ã—ãªã„å®šæ•°åŒ–ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é›†ï¼‰
        const PRINT_DELAY_MS = 500;              // å°åˆ·å®Ÿè¡Œã¾ã§ã®å¾…æ©Ÿæ™‚é–“
        const MULTI_ORDERS_PER_PAGE = 4;         // è¤‡æ•°æ¡ˆä»¶å°åˆ·æ™‚ã®1ãƒšãƒ¼ã‚¸å½“ãŸã‚Šæœ€å¤§ä»¶æ•°
        const MF_WITHHOLDING = 'å«ã¾ãªã„';        // MFè«‹æ±‚æ›¸CSVã®æºæ³‰å¾´åæŒ‡å®š
        const TAX_RATE_STR = '10%';              // MFè«‹æ±‚æ›¸CSVã®å“ç›®æ¶ˆè²»ç¨ç‡
        const CSV_CRLF = '\r\n';               // CSVæ”¹è¡Œã‚³ãƒ¼ãƒ‰ï¼ˆCRLFï¼‰
        const CSV_BOM  = '\uFEFF';              // CSV BOMï¼ˆUTF-8ï¼‰

        // CSVä¿å­˜å…ˆï¼ˆFile System Access API ã§é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ï¼‰
        let exportBaseDirHandle = null;

        async function chooseExportDir() {
            if (!window.showDirectoryPicker) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜ã«æœªå¯¾å¿œã§ã™ã€‚Chrome/Edgeç­‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚\nï¼ˆæœªå¯¾å¿œã®å ´åˆã¯é€šå¸¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ä¿å­˜ã—ã¾ã™ï¼‰');
                return;
            }
            try {
                exportBaseDirHandle = await window.showDirectoryPicker();
                alert('CSVä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ä»Šå¾Œã¯ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã¸è‡ªå‹•ä¿å­˜ã—ã¾ã™ã€‚');
            } catch (e) {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚ã—ãªã„
            }
        }

        async function saveCsvToDir(blob, filename, subfolderName) {
            if (!exportBaseDirHandle) return false;
            try {
                const targetDir = subfolderName ? await exportBaseDirHandle.getDirectoryHandle(subfolderName, { create: true }) : exportBaseDirHandle;
                const fileHandle = await targetDir.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                return true;
            } catch (err) {
                console.error('CSVä¿å­˜ã«å¤±æ•—:', err);
                return false;
            }
        }

        function toNumber(v) {
            if (v === null || v === undefined) return 0;
            const s = String(v).replace(/[^\d.-]/g, '');
            const n = Number(s);
            return Number.isFinite(n) ? n : 0;
        }

        function fmtDate(isoLike) {
            if (!isoLike) return '';
            const d = new Date(isoLike);
            if (isNaN(d)) return String(isoLike);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}/${mm}/${dd}`;
        }
        let driverMaster = ['æ··è¼‰æµé€š', 'é–€è„‡æ‚Ÿå¤§', 'é“ç®¡ã‚µãƒ¼ãƒ“ã‚¹', 'ä½å·æ€¥ä¾¿', 'å±±ç”°å¤ªéƒ', 'éˆ´æœ¨æ¬¡éƒ', 'ç”°ä¸­ä¸‰éƒ', 'æ¸¡è¾ºæµé›…'];
        let vehicleMaster = ['æœ­å¹Œ100ã‚12-34', 'æœ­å¹Œ300ã¿22-33', 'æœ­å¹Œ400ã™11-22', 'æœ­å¹Œ500ãª33-44', 'å¸¯åºƒ500ãŸ56-78', 'æ—­å·400ã™11-22', 'å‡½é¤¨300ã‚‰90-12', 'å‡½é¤¨400ã¦99-00', 'é‡§è·¯100ã‚77-88', '85-82 æ—¥é‡å¤§å‹è»Š'];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå›èµ·å‹•ãƒã‚§ãƒƒã‚¯ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†ãªã‚‰ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const setupCompleted = localStorage.getItem('setupCompleted');
            if (!setupCompleted) {
                window.location.href = 'setup-wizard.html';
                return;
            }
            
            // ç¾åœ¨ã®æœˆã‚’è¨­å®š
            currentMonth = new Date();
            currentMonth.setDate(1); // æœˆã®1æ—¥ã«è¨­å®š
            
            // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šèª­ã¿è¾¼ã¿ï¼†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            loadCloudConfig();
            updateCloudStatusUI();

            loadData();
            loadMasters();
            rebuildColorMapFor('driver', driverMaster);
            updateMonth();
            updateTodayDate();
            renderTable();
            updateStats();
            setupFilters();
            updateSelectOptions();
            
            // ã‚¯ãƒ©ã‚¦ãƒ‰ãŒæœ‰åŠ¹ãªã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç”»é¢ã‚’æ›´æ–°
            if (cloudEnabled()) {
                cloudFetchOrders().then(fetched => {
                    if (Array.isArray(fetched) && fetched.length >= 0) {
                        orders = fetched.map(row => normalizeOrderRow(row));
                        // IDæ¬ æã®å—æ³¨ã«ä¸€æ„ãªIDã‚’è£œå®Œ
                        const base = Date.now();
                        orders.forEach((o, idx) => {
                            if (o.id === undefined || o.id === null || o.id === '') {
                                o.id = base + idx;
                            }
                        });
                        saveData();
                        renderTable();
                        updateStats();
                        setupFilters();
                        updateCloudStatusUI(true);
                    }
                }).catch(err => {
                    console.warn('ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—:', err);
                    updateCloudStatusUI(false);
                });
            }
            
            
            // 1åˆ†ã”ã¨ã«æ—¥ä»˜ã‚’æ›´æ–°
            setInterval(updateTodayDate, 60000);
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    document.querySelectorAll('.autocomplete-list').forEach(list => {
                        list.classList.remove('active');
                    });
                }
            });
        });

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’æ›´æ–°
        function updateTodayDate() {
            const today = new Date();
            const days = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];
            const month = today.getMonth() + 1;
            const date = today.getDate();
            const day = days[today.getDay()];
            document.getElementById('todayDate').textContent = `${month}/${date} ${day}`;
        }

        // ãƒã‚¹ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterMaster(keyword, type) {
            const listId = type === 'customer' ? 'customerAutocomplete' : 
                          type === 'pickup' ? 'pickupAutocomplete' : 'deliveryAutocomplete';
            const list = document.getElementById(listId);
            
            if (!keyword) {
                list.classList.remove('active');
                return;
            }
            
            const filtered = customerMaster.filter(item => 
                item.name.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (filtered.length > 0) {
                list.innerHTML = filtered.map(item => 
                    `<div class="autocomplete-item" onclick="selectMasterItem('${item.name}', '${type}')">${item.name}</div>`
                ).join('');
                list.classList.add('active');
            } else {
                list.classList.remove('active');
            }
        }

        // ãƒã‚¹ã‚¿ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ
        function selectMasterItem(name, type) {
            const selectedItem = customerMaster.find(item => item.name === name);
            
            if (type === 'customer') {
                document.getElementById('customerName').value = name;
                document.getElementById('customerAutocomplete').classList.remove('active');
            } else if (type === 'pickup') {
                document.getElementById('pickupLocation').value = name;
                document.getElementById('pickupAutocomplete').classList.remove('active');
                if (selectedItem) {
                    document.getElementById('pickupAddress').value = selectedItem.address;
                }
            } else if (type === 'delivery') {
                document.getElementById('deliveryLocation').value = name;
                document.getElementById('deliveryAutocomplete').classList.remove('active');
                if (selectedItem) {
                    document.getElementById('deliveryAddress').value = selectedItem.address;
                    document.getElementById('deliveryTel').value = selectedItem.tel;
                }
            }
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠæ™‚ã®è¡Œè‰²å¤‰æ›´
        function updateRowSelection() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const checkbox = row.querySelector('.checkbox');
                if (checkbox && checkbox.checked) {
                    row.classList.add('row-selected');
                } else {
                    row.classList.remove('row-selected');
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('orders');
            if (saved) {
                orders = JSON.parse(saved);
                // IDæ¬ æã®è£œå®Œï¼ˆCSVå–è¾¼ã‚„æ—§ãƒ‡ãƒ¼ã‚¿å¯¾ç­–ï¼‰
                let changed = false;
                orders.forEach((o, idx) => {
                    if (o.id === undefined || o.id === null || o.id === '') {
                        o.id = Date.now() + idx;
                        changed = true;
                    }
                });
                if (changed) saveData();
            } else {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                orders = [
                    {
                        id: 1, orderNo: 'R240901-001', date: '2024-09-01',
                        customerName: 'ãˆ±åŒ—æµ·é“é’æœ', pickupLocation: 'æœ­å¹Œå¸‚å ´',
                        pickupAddress: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—12æ¡è¥¿20ä¸ç›®', deliveryLocation: 'æ—­å·å¸‚å ´',
                        deliveryAddress: 'æ—­å·å¸‚æ°¸å±±2æ¡5ä¸ç›®', deliveryTel: '0166-48-2311',
                        cargo: 'ãƒˆãƒãƒˆ', quantity: 150, unit: 'ã‚±ãƒ¼ã‚¹', packaging: 'ãƒ€ãƒ³ãƒœãƒ¼ãƒ«',
                        unitPrice: 120, amountNet: 18000, amountGross: 19800,
                        instructions: 'â€»å†·è”µè¼¸é€å¿…é ˆ\nâ€»8æ™‚ï½10æ™‚åˆ°ç€å³å®ˆ', driver: 'æ··è¼‰æµé€š',
                        vehicle: 'æœ­å¹Œ100ã‚12-34', instructionSheet: false, invoiceSent: false, paymentReceived: false, orderCompleted: false
                    },
                    {
                        id: 2, orderNo: 'R240902-001', date: '2024-09-02',
                        customerName: 'ãˆ±æœ­å¹Œå¸‚å ´', pickupLocation: 'å¸¯åºƒå¸‚å ´',
                        pickupAddress: 'å¸¯åºƒå¸‚è¥¿20æ¡å—1ä¸ç›®', deliveryLocation: 'æœ­å¹Œä¸­å¤®å¸‚å ´',
                        deliveryAddress: 'æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—12æ¡', deliveryTel: '011-611-3111',
                        cargo: 'ã˜ã‚ƒãŒã„ã‚‚', quantity: 200, unit: 'è¢‹', packaging: 'éº»è¢‹20kg',
                        unitPrice: 85, amountNet: 17000, amountGross: 18700,
                        instructions: 'â€»åˆå‰ä¸­é…é€\nâ€»ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒ•ãƒˆè·é™ã‚ã—', driver: 'é–€è„‡æ‚Ÿå¤§',
                        vehicle: 'å¸¯åºƒ500ãŸ56-78', instructionSheet: true, invoiceSent: false, paymentReceived: false, orderCompleted: false
                    },
                    {
                        id: 3, orderNo: 'ROW7', date: '2025-09-03',
                        customerName: 'JAãã‚‰ã¡å—æœ¬æ‰€è²©å£²éƒ¨', pickupLocation: 'å €ç”° æ·³ä¸€',
                        pickupAddress: 'å¤•å¼µéƒ¡æ —å±±ç”ºé³©å±±ï¼”', deliveryLocation: 'JAãã‚‰ã¡å—æ —å±±ç”ºé¦¬éˆ´è–¯é›†å‡ºè·è²¯è”µã‚»ãƒ³ã‚¿ãƒ¼',
                        deliveryAddress: 'å¤•å¼µéƒ¡æ —å±±ç”ºå¯Œå£«', deliveryTel: '0123-73-5678',
                        cargo: 'ã‹ã¼ã¡ã‚ƒ', quantity: 368, unit: 'ã‚±ãƒ¼ã‚¹', packaging: '10kg DB',
                        unitPrice: 95, amountNet: 34960, amountGross: 38456,
                        instructions: 'â€»é›†è·æ™‚ã‚±ãƒ¼ã‚¹æ•°ç•°ãªã‚‹å ´åˆæœ‰', driver: 'æ¸¡è¾ºæµé›…',
                        vehicle: '85-82 æ—¥é‡å¤§å‹è»Š', instructionSheet: false, invoiceSent: false, paymentReceived: false, orderCompleted: false
                    }
                ];
            }
        }

        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadMasters() {
            const savedCustomers = localStorage.getItem('customerMaster');
            if (savedCustomers) customerMaster = JSON.parse(savedCustomers);
            
            const savedCargo = localStorage.getItem('cargoMaster');
            if (savedCargo) cargoMaster = JSON.parse(savedCargo);
            
            const savedPackaging = localStorage.getItem('packagingMaster');
            if (savedPackaging) packagingMaster = JSON.parse(savedPackaging);
            
            const savedUnit = localStorage.getItem('unitMaster');
            if (savedUnit) unitMaster = JSON.parse(savedUnit);
            
            const savedDriver = localStorage.getItem('driverMaster');
            if (savedDriver) driverMaster = JSON.parse(savedDriver);
            
            const savedVehicle = localStorage.getItem('vehicleMaster');
            if (savedVehicle) vehicleMaster = JSON.parse(savedVehicle);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // ====== ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆSupabaseï¼‰é–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
        let cloudConfig = { url: '', anonKey: '', enabled: false };

        function loadCloudConfig() {
            try {
                const saved = localStorage.getItem('cloudConfig');
                if (saved) {
                    cloudConfig = JSON.parse(saved) || cloudConfig;
                }
            } catch(e) { /* noop */ }
            return cloudConfig;
        }

        function saveCloudConfig(cfg) {
            cloudConfig = { ...cloudConfig, ...cfg };
            localStorage.setItem('cloudConfig', JSON.stringify(cloudConfig));
        }

        function cloudEnabled() {
            return !!(cloudConfig && cloudConfig.enabled && cloudConfig.url && cloudConfig.anonKey);
        }

        function getSupabaseBase() {
            return (cloudConfig.url || '').replace(/\/$/, '') + '/rest/v1';
        }

        function supabaseHeaders() {
            return {
                'Content-Type': 'application/json',
                'apikey': cloudConfig.anonKey,
                'Authorization': 'Bearer ' + cloudConfig.anonKey,
                'Prefer': 'return=representation, resolution=merge-duplicates'
            };
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼†ãƒ•ã‚§ãƒƒãƒå®‰å®šåŒ–ãƒ©ãƒƒãƒ‘ãƒ¼
        function isOnline() {
            try { return navigator.onLine !== false; } catch(_) { return true; }
        }
        async function cloudFetchRetry(url, options = {}, opts = {}) {
            const {
                retries = 2,
                timeoutMs = 10000,
                backoffBaseMs = 500,
                backoffFactor = 2,
                retryOnStatuses = [429, 500, 502, 503, 504]
            } = opts;
            let attempt = 0;
            while (true) {
                if (!isOnline()) {
                    const err = new Error('OFFLINE'); err.code = 'OFFLINE'; throw err;
                }
                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(timer);
                    if (!res.ok && retryOnStatuses.includes(res.status) && attempt < retries) {
                        const delay = backoffBaseMs * Math.pow(backoffFactor, attempt);
                        await new Promise(r => setTimeout(r, delay + Math.floor(Math.random()*100)));
                        attempt++;
                        continue;
                    }
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res;
                } catch(e) {
                    clearTimeout(timer);
                    if ((e && e.name === 'AbortError') || (e && e.code === 'OFFLINE') || attempt < retries) {
                        const delay = backoffBaseMs * Math.pow(backoffFactor, attempt);
                        await new Promise(r => setTimeout(r, delay + Math.floor(Math.random()*100)));
                        attempt++;
                        continue;
                    }
                    throw e;
                }
            }
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã‚­ãƒ¥ãƒ¼
        const CLOUD_QUEUE_KEY = 'cloudSyncQueue';
        function getCloudQueue() {
            try { const raw = localStorage.getItem(CLOUD_QUEUE_KEY); return raw ? JSON.parse(raw) : []; } catch(_) { return []; }
        }
        function setCloudQueue(q) {
            try { localStorage.setItem(CLOUD_QUEUE_KEY, JSON.stringify(q)); } catch(_) {}
        }
        function getCloudQueueLength() { try { return getCloudQueue().length; } catch(_) { return 0; } }
        function safeClone(obj) { try { return JSON.parse(JSON.stringify(obj)); } catch(_) { return obj; } }
        function enqueueCloudOp(op, payload) {
            const q = getCloudQueue();
            q.push({ op, payload: safeClone(payload), createdAt: Date.now() });
            setCloudQueue(q);
            try { compactCloudQueue(); } catch(_){}
            const newLen = getCloudQueueLength();
            try { logWarn('CLOUD_QUEUE', 'enqueue ' + op, newLen); } catch(_){}
            try { showToast(`CloudåŒæœŸå¾…ã¡ï¼ˆã‚­ãƒ¥ãƒ¼:${newLen}ï¼‰`, 'warn'); } catch(_){}
        }
        function compactCloudQueue() {
            const q = getCloudQueue();
            if (!q.length) return;
            const map = new Map();
            const localIdToOrderNo = new Map();
            try {
                for (const o of orders) {
                    localIdToOrderNo.set(o.id, o.orderNo);
                }
            } catch(_){}
            for (const item of q) {
                let key = '';
                if (item.op === 'update') {
                    const lid = item.payload && item.payload.localId;
                    const ono = localIdToOrderNo.get(lid) || '';
                    key = 'U:' + (ono || lid);
                    const existing = map.get(key);
                    if (existing) {
                        existing.payload.patch = { ...(existing.payload.patch||{}), ...(item.payload.patch||{}) };
                    } else {
                        map.set(key, safeClone(item));
                    }
                } else if (item.op === 'upsert') {
                    const ono = (item.payload && (item.payload.orderNo || item.payload.order_no)) || '';
                    key = 'P:' + ono;
                    map.set(key, safeClone(item));
                } else if (item.op === 'delete') {
                    const ono = item.payload && item.payload.orderNo;
                    key = 'D:' + ono;
                    // deleteã¯æœ€å„ªå…ˆã€‚é–¢é€£ã™ã‚‹update/upsertã‚’ä¸Šæ›¸ã
                    map.set(key, safeClone(item));
                    map.delete('U:' + ono);
                    map.delete('P:' + ono);
                } else if (item.op === 'batchUpdate') {
                    const ids = (item.payload && item.payload.localIds) || [];
                    key = 'B:' + ids.slice().sort().join(',');
                    const existing = map.get(key);
                    if (existing) {
                        existing.payload.patch = { ...(existing.payload.patch||{}), ...(item.payload.patch||{}) };
                    } else {
                        map.set(key, safeClone(item));
                    }
                } else {
                    key = 'X:' + JSON.stringify(item.payload || {});
                    map.set(key, safeClone(item));
                }
            }
            const compacted = Array.from(map.values());
            setCloudQueue(compacted);
            try { logInfo('CLOUD_QUEUE_COMPACT', 'size', compacted.length); } catch(_){}
        }
        async function flushCloudQueue(limit) {
            if (!cloudEnabled()) return;
            try { compactCloudQueue(); } catch(_){}
            const q = getCloudQueue();
            if (!q.length) { updateCloudStatusUI(true); return; }
            updateCloudStatusUI();
            const toProcess = typeof limit === 'number' ? q.slice(0, limit) : q.slice();
            let processed = 0;
            for (const item of toProcess) {
                try {
                    if (item.op === 'upsert') {
                        await cloudUpsertOrder(item.payload);
                    } else if (item.op === 'delete') {
                        await cloudDeleteOrderByOrderNo(item.payload.orderNo);
                    } else if (item.op === 'update') {
                        await cloudUpdateOrder(item.payload.localId, item.payload.patch);
                    } else if (item.op === 'batchUpdate') {
                        await cloudBatchUpdate(item.payload.localIds, item.payload.patch);
                    }
                    processed++;
                } catch(e) {
                    try { logError('CLOUD_QUEUE_FLUSH', e); } catch(_){ }
                    break; // æ¬¡å›ã«å†è©¦è¡Œ
                }
            }
            if (processed > 0) {
                const remaining = q.slice(processed);
                setCloudQueue(remaining);
                try { showToast(`CloudåŒæœŸå‡¦ç†ï¼ˆ${processed}ä»¶ï¼‰`); } catch(_){ }
            }
            if (!getCloudQueue().length) updateCloudStatusUI(true);
        }
        window.addEventListener('online', () => { try { flushCloudQueue(); } catch(_){} });
        setInterval(() => { try { flushCloudQueue(3); } catch(_){} }, 30000);

        function updateCloudStatusUI(connected) {
            const el = document.getElementById('cloudStatus');
            if (!el) return;
            const qlen = (typeof getCloudQueueLength === 'function') ? getCloudQueueLength() : 0;
            const queueText = qlen > 0 ? `ãƒ»ã‚­ãƒ¥ãƒ¼:${qlen}` : '';
            if (!cloudEnabled()) {
                el.textContent = 'æ¥ç¶š: ãƒ­ãƒ¼ã‚«ãƒ«';
                el.style.background = '#eee';
                el.style.color = '#333';
            } else if (connected === true) {
                el.textContent = `æ¥ç¶š: Cloudï¼ˆåŒæœŸå®Œäº†${queueText ? ' ' + queueText : ''}ï¼‰`;
                el.style.background = '#e7f7ef';
                el.style.color = '#0a7a3b';
            } else if (connected === false) {
                el.textContent = `æ¥ç¶š: Cloudï¼ˆã‚¨ãƒ©ãƒ¼${queueText ? ' ' + queueText : ''}ï¼‰`;
                el.style.background = '#fdecea';
                el.style.color = '#b71c1c';
            } else {
                el.textContent = `æ¥ç¶š: Cloudï¼ˆåŒæœŸä¸­${queueText ? ' ' + queueText : ''}ï¼‰`;
                el.style.background = '#f0f7ff';
                el.style.color = '#0b5ed7';
            }
        }

        // ç°¡æ˜“ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message, type) {
            try {
                const containerId = 'toast-container';
                let c = document.getElementById(containerId);
                if (!c) {
                    c = document.createElement('div');
                    c.id = containerId;
                    c.style.position = 'fixed';
                    c.style.top = '16px';
                    c.style.right = '16px';
                    c.style.zIndex = '9999';
                    c.style.display = 'flex';
                    c.style.flexDirection = 'column';
                    c.style.gap = '8px';
                    document.body.appendChild(c);
                }
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.padding = '10px 12px';
                toast.style.borderRadius = '4px';
                toast.style.color = '#fff';
                toast.style.fontSize = '12px';
                toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                toast.style.background = type === 'error' ? '#d93025' : (type === 'warn' ? '#f57c00' : '#2e7d32');
                c.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 300ms ease';
                    setTimeout(() => { try { c.removeChild(toast); } catch(_){} }, 320);
                }, 2000);
            } catch(_) { /* noop */ }
        }

        // ç°¡æ˜“ãƒ­ã‚¬ãƒ¼ï¼†ã‚¿ã‚°é›†è¨ˆ
        const logStats = { info: {}, warn: {}, error: {} };
        function logInfo(tag, ...args) {
            try { logStats.info[tag] = (logStats.info[tag] || 0) + 1; console.log(`[INFO:${tag}]`, ...args); } catch(_){}
        }
        function logWarn(tag, ...args) {
            try { logStats.warn[tag] = (logStats.warn[tag] || 0) + 1; console.warn(`[WARN:${tag}]`, ...args); } catch(_){}
        }
        function logError(tag, ...args) {
            try { logStats.error[tag] = (logStats.error[tag] || 0) + 1; console.error(`[ERROR:${tag}]`, ...args); } catch(_){}
        }
        function printLogStats() {
            try { console.table(logStats); } catch(_) { console.log('LOG_STATS', JSON.stringify(logStats)); }
        }

        // è¡Œæ­£è¦åŒ–ï¼ˆSupabaseâ†’ç”»é¢ï¼‰
        function normalizeOrderRow(row) {
            return {
                id: row.id,
                orderNo: row.order_no || row.orderno || row.orderNo,
                date: row.date,
                customerName: row.customer_name || row.customerName,
                pickupLocation: row.pickup_location || row.pickupLocation,
                pickupAddress: row.pickup_address || row.pickupAddress || '',
                deliveryLocation: row.delivery_location || row.deliveryLocation,
                deliveryAddress: row.delivery_address || row.deliveryAddress || '',
                deliveryTel: row.delivery_tel || row.deliveryTel || '',
                cargo: row.cargo,
                quantity: Number(row.quantity ?? 0),
                unit: row.unit || '',
                packaging: row.packaging || '',
                unitPrice: Number(row.unit_price ?? row.unitPrice ?? 0),
                amountNet: Number(row.amount_net ?? row.amountNet ?? 0),
                amountGross: Number(row.amount_gross ?? row.amountGross ?? 0),
                instructions: row.instructions || '',
                driver: row.driver || '',
                vehicle: row.vehicle || '',
                instructionSheet: !!row.instruction_sheet || !!row.instructionSheet,
                invoiceSent: !!row.invoice_sent || !!row.invoiceSent,
                paymentReceived: !!row.payment_received || !!row.paymentReceived,
                orderCompleted: !!row.order_completed || !!row.orderCompleted
            };
        }

        async function cloudFetchOrders() {
            const url = getSupabaseBase() + '/orders?select=*&order=date.asc&order=order_no.asc';
            const res = await cloudFetchRetry(url, { headers: supabaseHeaders() }, { retries: 2, timeoutMs: 10000 });
            return await res.json();
        }

        async function cloudUpsertOrder(order) {
            if (!cloudEnabled()) return;
            updateCloudStatusUI();
            const base = getSupabaseBase();
            const patchBody = serializeOrderForCloud(order);
            delete patchBody.id; // idã¯æ›´æ–°å¯¾è±¡å¤–
            const orderNo = order.orderNo || order.order_no;
            if (!orderNo) {
                console.warn('order_noãŒä¸æ˜ã®ãŸã‚ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            // 1) order_noã§PATCHï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°ç©ºé…åˆ—ãŒè¿”ã‚‹ï¼‰
            const urlPatch = `${base}/orders?order_no=eq.${encodeURIComponent(orderNo)}`;
            const resPatch = await cloudFetchRetry(urlPatch, { method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify(patchBody) }, { retries: 2, timeoutMs: 10000 });
            let updatedRows = [];
            try { updatedRows = await resPatch.json(); } catch(_) { /* representationãŒè¿”ã‚‰ãªã„å ´åˆ */ }
            if (Array.isArray(updatedRows) && updatedRows.length > 0) {
                const row = updatedRows[0];
                if (row && row.id) order.id = row.id; // Supabaseã®idã‚’åæ˜ 
                updateCloudStatusUI(true);
                return; // æ›´æ–°ã§å®Œäº†
            }
            // 2) æ—¢å­˜è¡ŒãŒãªã‘ã‚Œã°POSTï¼ˆidã¯é€ã‚‰ãªã„ï¼‰
            const insertBody = serializeOrderForCloud(order);
            delete insertBody.id;
            const urlPost = `${base}/orders?on_conflict=order_no`;
            try {
                const resPost = await cloudFetchRetry(urlPost, { method: 'POST', headers: supabaseHeaders(), body: JSON.stringify(insertBody) }, { retries: 2, timeoutMs: 10000 });
                const rows = await resPost.json();
                if (rows && rows[0] && rows[0].id) {
                    order.id = rows[0].id;
                }
                updateCloudStatusUI(true);
            } catch(e) {
                const msg = String(e && e.message || '');
                if (msg.includes('HTTP 409')) {
                    try {
                        const urlPatch2 = `${base}/orders?order_no=eq.${encodeURIComponent(orderNo)}`;
                        await cloudFetchRetry(urlPatch2, { method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify(patchBody) }, { retries: 2, timeoutMs: 10000 });
                        updateCloudStatusUI(true);
                        try { flushCloudQueue(2); } catch(_){}
                    } catch(e2) {
                        try { logError('CLOUD_UPSERT_CONFLICT_PATCH', e2); } catch(_){}
                        enqueueCloudOp('upsert', order);
                        updateCloudStatusUI(false);
                        try { showToast('CloudåŒæœŸç«¶åˆï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); } catch(_){}
                    }
                } else {
                    try { logError('CLOUD_UPSERT_POST', e); } catch(_){}
                    enqueueCloudOp('upsert', order);
                    updateCloudStatusUI(false);
                    try { showToast('CloudåŒæœŸã«å¤±æ•—ï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); } catch(_){}
                }
            }
        }

        async function cloudUpdateOrder(localId, patch) {
            if (!cloudEnabled()) return;
            updateCloudStatusUI();
            const base = getSupabaseBase();
            const o = orders.find(x => x.id === localId);
            if (!o) return;
            const body = serializeOrderForCloud({ ...o, ...patch });
            delete body.id;
            const url = `${base}/orders?order_no=eq.${encodeURIComponent(o.orderNo)}`;
            try {
                const res = await cloudFetchRetry(url, { method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify(body) }, { retries: 2, timeoutMs: 10000 });
                updateCloudStatusUI(true);
                try { flushCloudQueue(2); } catch(_){}
                return await res.json();
            } catch(e) {
                try { logError('CLOUD_UPDATE', e); } catch(_){}
                enqueueCloudOp('update', { localId, patch });
                updateCloudStatusUI(false);
                try { showToast('Cloudæ›´æ–°ã«å¤±æ•—ï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); } catch(_){}
            }
        }

        async function cloudBatchUpdate(localIds, patch) {
            if (!cloudEnabled() || !localIds || localIds.length === 0) return;
            updateCloudStatusUI();
            const base = getSupabaseBase();
            const orderNos = localIds.map(id => {
                const o = orders.find(x => x.id === id);
                return o ? o.orderNo : null;
            }).filter(v => v);
            if (orderNos.length === 0) return;
            const inParam = 'in.(' + orderNos.map(x => encodeURIComponent(String(x))).join(',') + ')';
            const url = `${base}/orders?order_no=${inParam}`;
            const body = serializeOrderForCloud(patch);
            delete body.id;
            try {
                await cloudFetchRetry(url, { method: 'PATCH', headers: supabaseHeaders(), body: JSON.stringify(body) }, { retries: 2, timeoutMs: 10000 });
                updateCloudStatusUI(true);
                try { flushCloudQueue(2); } catch(_){}
            } catch(e) {
                try { logError('CLOUD_BATCH_UPDATE', e); } catch(_){}
                enqueueCloudOp('batchUpdate', { localIds, patch });
                updateCloudStatusUI(false);
                try { showToast('Cloudä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); } catch(_){}
            }
        }

        async function cloudDeleteOrderByOrderNo(orderNo) {
            if (!cloudEnabled()) return;
            updateCloudStatusUI();
            const base = getSupabaseBase();
            const url = `${base}/orders?order_no=eq.${encodeURIComponent(orderNo)}`;
            try {
                await cloudFetchRetry(url, { method: 'DELETE', headers: supabaseHeaders() }, { retries: 2, timeoutMs: 10000 });
                updateCloudStatusUI(true);
                try { flushCloudQueue(2); } catch(_){}
            } catch(e) {
                try { logError('CLOUD_DELETE', e); } catch(_){ }
                enqueueCloudOp('delete', { orderNo });
                updateCloudStatusUI(false);
                try { showToast('Cloudå‰Šé™¤ã«å¤±æ•—ï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); } catch(_){}
            }
        }

        function serializeOrderForCloud(src) {
            // ç”»é¢â†’Supabaseãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
            const map = {
                id: src.id,
                order_no: src.orderNo,
                date: src.date,
                customer_name: src.customerName,
                pickup_location: src.pickupLocation,
                pickup_address: src.pickupAddress,
                delivery_location: src.deliveryLocation,
                delivery_address: src.deliveryAddress,
                delivery_tel: src.deliveryTel,
                cargo: src.cargo,
                quantity: src.quantity,
                unit: src.unit,
                packaging: src.packaging,
                unit_price: src.unitPrice,
                amount_net: src.amountNet,
                amount_gross: src.amountGross,
                instructions: src.instructions,
                driver: src.driver,
                vehicle: src.vehicle,
                instruction_sheet: src.instructionSheet,
                invoice_sent: src.invoiceSent,
                payment_received: src.paymentReceived,
                order_completed: src.orderCompleted
            };
            // æœªå®šç¾©ã‚’é™¤å»
            Object.keys(map).forEach(k => { if (map[k] === undefined) delete map[k]; });
            return map;
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function openCloudSettings() {
            loadCloudConfig();
            document.getElementById('cloudProjectUrl').value = cloudConfig.url || '';
            document.getElementById('cloudAnonKey').value = cloudConfig.anonKey || '';
            document.getElementById('cloudEnabledCheckbox').checked = !!cloudConfig.enabled;
            document.getElementById('cloudSettingsModal').style.display = 'block';
        }
        function closeCloudSettings() {
            document.getElementById('cloudSettingsModal').style.display = 'none';
        }
        function saveCloudSettings() {
            const url = document.getElementById('cloudProjectUrl').value.trim();
            const key = document.getElementById('cloudAnonKey').value.trim();
            const enabled = document.getElementById('cloudEnabledCheckbox').checked;
            saveCloudConfig({ url, anonKey: key, enabled });
            updateCloudStatusUI();
            closeCloudSettings();
            // è¨­å®šãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸã‚‰å³æ™‚åŒæœŸï¼ˆèª­ã¿è¾¼ã¿ï¼‰
            if (cloudEnabled()) {
                cloudFetchOrders().then(fetched => {
                    if (Array.isArray(fetched)) {
                        orders = fetched.map(row => normalizeOrderRow(row));
                        saveData();
                        renderTable();
                        updateStats();
                        setupFilters();
                        updateCloudStatusUI(true);
                    }
                }).catch(err => {
                    console.warn('ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—:', err);
                    updateCloudStatusUI(false);
                });
            }
        }
/* ===== ã‚«ãƒ©ãƒ¼è‡ªå‹•ç”Ÿæˆï¼ˆcargo / driver ç”¨ï¼‰: renderTable ã®ç›´å‰ã«è¿½è¨˜ ===== */

// åå‰ç©ºé–“ã”ã¨ã«è‰²ãƒãƒƒãƒ—ã‚’localStorageã«ä¿æŒ
function getColorMapKey(ns) { return `colorMap_${ns}`; }
function getColorMap(ns) {
    try { return JSON.parse(localStorage.getItem(getColorMapKey(ns))) || {}; }
    catch { return {}; }
}
function setColorMap(ns, map) {
    localStorage.setItem(getColorMapKey(ns), JSON.stringify(map));
}

// æ–‡å­—åˆ—â†’ãƒãƒƒã‚·ãƒ¥ï¼ˆDJB2ï¼‰
function hashString(str) {
    let h = 5381;
    for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
    return h >>> 0; // unsigned
}

// HSL â†’ HEX
function hslToHex(h, s, l) {
    s /= 100; l /= 100;
    const c = (1 - Math.abs(2*l - 1)) * s;
    const x = c * (1 - Math.abs(((h/60) % 2) - 1));
    const m = l - c/2;
    let r=0,g=0,b=0;
    if (0<=h && h<60) { r=c; g=x; b=0; }
    else if (60<=h && h<120) { r=x; g=c; b=0; }
    else if (120<=h && h<180) { r=0; g=c; b=x; }
    else if (180<=h && h<240) { r=0; g=x; b=c; }
    else if (240<=h && h<300) { r=x; g=0; b=c; }
    else { r=c; g=0; b=x; }
    const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

// HEX â†’ ç›¸å¯¾è¼åº¦ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè‰²æ±ºå®šç”¨ï¼‰
function hexLuminance(hex) {
    const r = parseInt(hex.slice(1,3),16)/255;
    const g = parseInt(hex.slice(3,5),16)/255;
    const b = parseInt(hex.slice(5,7),16)/255;
    const a = [r,g,b].map(v => v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
    return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
}
/* === ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å€‹åˆ¥ã®è‰²ã‚’å¼·åˆ¶æŒ‡å®šï¼ˆã“ã®2åã¯å›ºå®šè‰²ï¼‰ === */
var COLOR_OVERRIDES = {
  driver: {
    'æ¸¡æ›¾ç¾Šä¸€': { bg: '#0EA5E9', fg: '#FFFFFF', _hue: 198 }, // æ˜ã‚‹ã„ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼
    'é–€é¦¬å°†å¤ª': { bg: '#F97316', fg: '#FFFFFF', _hue: 24 }    // æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸
  }
};

// === ã“ã“ã‹ã‚‰è¿½è¨˜ï¼šè‰²ã®è¢«ã‚Šã‚’é¿ã‘ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
function hueDiff(a, b) {
  var d = Math.abs(a - b) % 360;
  return d > 180 ? 360 - d : d;
}

// æ—¢å­˜ã§ä½¿ã£ã¦ã„ã‚‹è‰²ï¼ˆmapï¼‰ã‹ã‚‰ä½¿ç”¨æ¸ˆã¿Hueé…åˆ—ã‚’å–ã‚Šå‡ºã™ï¼ˆ_hueãŒç„¡ã„å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ï¼‰
function getUsedHuesFromMap(map) {
  var used = [];
  for (var k in map) {
    if (map.hasOwnProperty(k) && map[k] && typeof map[k]._hue === 'number') {
      used.push(map[k]._hue);
    }
  }
  return used;
}

// æŒ‡å®šã®æœ€å°è‰²å·®(minGap)ã‚’ä¿ã¡ãªãŒã‚‰ã€åå‰ã‹ã‚‰å®‰å®šçš„ã«Hueã‚’æ±ºã‚ã‚‹
function assignDistinctColor(ns, name, usedHues, minGapDeg) {
  // é»„é‡‘è§’ï¼ˆç´„137.508ï¼‰ã‚’ä½¿ã£ã¦ãƒãƒƒã‚·ãƒ¥ç”±æ¥ã®åˆæœŸHueã‚’åºƒã’ã‚‹
  var baseHue = ((hashString(name) * 137.508) % 360 + 360) % 360;
  var step = 27; // æ¢ç´¢ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåº¦ï¼‰ã€‚å¤§ãã„ã»ã©è¡çªå›é¿ã—ã‚„ã™ã„
  var sat  = (ns === 'cargo') ? 65 : 70; // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯ã‚ˆã‚Šé®®ã‚„ã‹ã«
  var lig  = (ns === 'cargo') ? 45 : 45;

  // æ—¢å­˜Hueã¨ååˆ†é›¢ã‚Œã‚‹ã¾ã§å›ã™
  for (var i = 0; i < 360 / step + 2; i++) {
    var hue = (baseHue + i * step) % 360;
    var ok = true;
    for (var j = 0; j < usedHues.length; j++) {
      if (hueDiff(hue, usedHues[j]) < minGapDeg) { ok = false; break; }
    }
    if (ok) {
      var bg = hslToHex(hue, sat, lig);
      var fg = hexLuminance(bg) > 0.6 ? '#111827' : '#ffffff';
      return { bg: bg, fg: fg, _hue: hue };
    }
  }
  // ä¸‡ä¸€ã™ã¹ã¦è¿‘ã„å ´åˆã¯ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨
  var bg2 = hslToHex(baseHue, sat, lig);
  var fg2 = hexLuminance(bg2) > 0.6 ? '#111827' : '#ffffff';
  return { bg: bg2, fg: fg2, _hue: baseHue };
}
// === ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç­‰ã®ä¸€è¦§ã«å¯¾ã—ã¦ã€è‰²ã‚’å†å‰²å½“ï¼ˆå…¨å“¡ãŒååˆ†ã«é•ã†è‰²ã«ï¼‰ ===
function rebuildColorMapFor(ns, namesArray) {
  var names = (namesArray || []).slice();
  var map = {};
  var used = [];

  // 1) ã¾ãšå¼·åˆ¶æŒ‡å®šï¼ˆOVERRIDEï¼‰ã‚’å…ˆã«ç¢ºå®šã—ã¦ used ã«ç™»éŒ²
  var ovr = (COLOR_OVERRIDES[ns] || {});
  for (var k in ovr) {
    if (ovr.hasOwnProperty(k)) {
      map[k] = ovr[k];
      if (typeof ovr[k]._hue === 'number') used.push(ovr[k]._hue);
    }
  }

  // 2) æ®‹ã‚Šã‚’åå‰é †ã§è‡ªå‹•å‰²å½“
  names.sort(function(a, b){ return String(a).localeCompare(String(b)); });
  for (var i = 0; i < names.length; i++) {
    var nm = (names[i] || '').trim();
    if (!nm) continue;
    if (map[nm]) continue; // æ—¢ã«ä¸Šæ›¸ãæ¸ˆã¿ã¯ã‚¹ã‚­ãƒƒãƒ—
    var minGap = (ns === 'driver') ? 26 : 18;
    var col = assignDistinctColor(ns, nm, used, minGap);
    map[nm] = col;
    used.push(col._hue);
  }

  setColorMap(ns, map);
}


// â˜… ç½®ãæ›ãˆç‰ˆï¼šè‰²ã®æœ€å°è·é›¢ã‚’ç¢ºä¿ã—ã¦å‰²å½“
function nameToColor(ns, nameRaw) {
// â˜…è¿½åŠ ï¼šå€‹åˆ¥ä¸Šæ›¸ããŒã‚ã‚Œã°ãã‚Œã‚’å³è¿”ã™
var ovr = (COLOR_OVERRIDES[ns] || {});
if (ovr[name]) {
  var map0 = getColorMap(ns) || {};
  map0[name] = ovr[name];
  setColorMap(ns, map0);
  return ovr[name];
}

  var name = (nameRaw || '').trim();
  if (!name) return { bg:'#e5e7eb', fg:'#111827' };

  var map = getColorMap(ns) || {};
  if (map[name] && map[name].bg && map[name].fg) {
    return map[name]; // æ—¢å­˜å‰²å½“ãŒã‚ã‚Œã°ãã®ã¾ã¾
  }

  // æ—¢å­˜ã®ä½¿ç”¨Hueä¸€è¦§ï¼ˆ_hueãŒç„¡ã„å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
  var usedHues = getUsedHuesFromMap(map);
  var minGap = (ns === 'driver') ? 26 : 18; // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯ã‚ˆã‚Šåºƒãè‰²å·®ã‚’å–ã‚‹

  var col = assignDistinctColor(ns, name, usedHues, minGap);
  map[name] = col;
  setColorMap(ns, map);
  return col;
}


// ä¸€è¦§ã‚¿ã‚°ç”¨ã® style æ–‡å­—åˆ—ã‚’è¿”ã™
function getTagStyle(ns, name) {
    const { bg, fg } = nameToColor(ns, name);
    return `background:${bg};color:${fg};border:1px solid ${bg}`;
}

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            let monthOrders = getMonthOrders();
            
            // ä¸¦ã³æ›¿ãˆå‡¦ç†
            const sortOrder = document.getElementById('sortOrder') ? document.getElementById('sortOrder').value : 'date-asc';
            if (sortOrder === 'date-asc') {
                // æ—¥ä»˜é †ï¼ˆæ˜‡é †ï¼‰
                monthOrders.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA.getTime() === dateB.getTime()) {
                        // åŒã˜æ—¥ä»˜ã®å ´åˆã¯IDã§ä¸¦ã³æ›¿ãˆ
                        return a.id - b.id;
                    }
                    return dateA - dateB;
                });
            } else if (sortOrder === 'id-asc') {
                // ç™»éŒ²é †ï¼ˆIDé †ï¼‰
                monthOrders.sort((a, b) => a.id - b.id);
            }
            
tbody.innerHTML = monthOrders.map(function(o) {
    // ã‚¿ã‚°è‰²: æ—¢å­˜ã® getTagStyle ã‚’åˆ©ç”¨
    var cargoHtml  = '<span class="tag" style="' + getTagStyle('cargo',  o.cargo)  + '">' + (o.cargo || '-') + '</span>';
    var driverHtml = o.driver
        ? '<span class="tag" style="' + getTagStyle('driver', o.driver) + '">' + o.driver + '</span>'
        : '-';

    var qty = (o.quantity !== null && o.quantity !== undefined) ? o.quantity : '';
    var unit = (o.unit || '');

    return '' +
      '<tr data-order-id="' + o.id + '">' +
        '<td><input type="checkbox" class="checkbox order-checkbox" data-id="' + o.id + '" onchange="updateRowSelection()"></td>' +
        '<td style="white-space: nowrap;">' + formatDate(o.date) + '</td>' +
        '<td>' + (o.customerName || '-') + '</td>' +
        '<td>' + (o.pickupLocation || '-') + '</td>' +
        '<td>' + (o.deliveryLocation || '-') + '</td>' +
        '<td>' + cargoHtml + '</td>' +
        '<td style="white-space: nowrap;">' + qty + ' ' + unit + '</td>' +
        '<td>' + (o.packaging || '-') + '</td>' +
        '<td style="text-align: right;">Â¥' + ((o.unitPrice || 0).toLocaleString()) + '</td>' +
        '<td style="text-align: right;">Â¥' + ((o.amountNet || 0).toLocaleString()) + '</td>' +
        '<td style="text-align: right;">Â¥' + ((o.amountGross || 0).toLocaleString()) + '</td>' +
        '<td>' + driverHtml + '</td>' +
        '<td style="font-size: 0.7rem;">' + (o.vehicle || '-') + '</td>' +
        '<td style="text-align: center;">' + (o.instructionSheet ? '<span class="badge badge-success">æ¸ˆ</span>' : '<span class="badge badge-warning">æœª</span>') + '</td>' +
        '<td style="text-align: center;"><input type="checkbox" class="checkbox-small" ' + (o.invoiceSent ? 'checked' : '') + ' onchange="toggleInvoice(' + o.id + ')"></td>' +
        '<td style="text-align: center;"><input type="checkbox" class="checkbox-small" ' + (o.paymentReceived ? 'checked' : '') + ' onchange="togglePayment(' + o.id + ')"></td>' +
'<td style="white-space: nowrap;">' +
  '<button class="btn btn-sm btn-primary" style="margin-right: 2px;" onclick="editOrder(' + o.id + ', this)">ç·¨é›†</button>' +
  '<button class="btn btn-sm btn-warning" style="margin-right: 2px;" onclick="duplicateOrder(' + o.id + ', this)">è¤‡è£½</button>' +
  '<button class="btn btn-sm btn-danger" onclick="deleteOrder(' + o.id + ')">å‰Šé™¤</button>' +
'</td>' +

      '</tr>';
}).join('');

updateStatsFromView();
        }
        
        // ä¸¦ã³æ›¿ãˆå‡¦ç†
        function sortTable() {
            renderTable();
            filterTable(); // ãƒ•ã‚£ãƒ«ã‚¿ã‚‚å†é©ç”¨
        }

        // è«‹æ±‚æ›¸ãƒã‚§ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
        function toggleInvoice(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.invoiceSent = !order.invoiceSent;
                saveData();
                // ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°
                try { if (cloudEnabled()) cloudUpdateOrder(id, { invoiceSent: order.invoiceSent }); } catch(e) {}
            }
        }

        // å…¥é‡‘ãƒã‚§ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
        function togglePayment(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.paymentReceived = !order.paymentReceived;
                saveData();
                // ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°
                try { if (cloudEnabled()) cloudUpdateOrder(id, { paymentReceived: order.paymentReceived }); } catch(e) {}
            }
        }

        // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getMonthOrders() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 1); // æ¬¡æœˆã®1æ—¥ã®0æ™‚0åˆ†
            
            return orders.filter(order => {
                const orderDate = new Date(order.date + 'T00:00:00'); // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å•é¡Œã‚’å›é¿
                return orderDate >= startDate && orderDate < endDate;
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const monthOrders = getMonthOrders();
            const totalGross = monthOrders.reduce((sum, order) => sum + (order.amountGross || 0), 0);
            const totalNet = monthOrders.reduce((sum, order) => sum + (order.amountNet || 0), 0);
            const incomplete = monthOrders.filter(order => !order.orderCompleted).length;
            
            // æœ¬æ—¥ã¨ç¿Œæ—¥ã®é…é€äºˆå®šä»¶æ•°ã‚’è¨ˆç®—
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            const tomorrowStr = `${tomorrow.getFullYear()}-${(tomorrow.getMonth() + 1).toString().padStart(2, '0')}-${tomorrow.getDate().toString().padStart(2, '0')}`;
            
            const todayDeliveries = orders.filter(order => 
                order.date === todayStr && !order.orderCompleted
            ).length;
            
            const tomorrowDeliveries = orders.filter(order => 
                order.date === tomorrowStr && !order.orderCompleted
            ).length;
            
            document.getElementById('totalGross').textContent = `Â¥${totalGross.toLocaleString()}`;
            document.getElementById('totalNet').textContent = `Â¥${totalNet.toLocaleString()}`;
            document.getElementById('orderCount').textContent = `${monthOrders.length}ä»¶`;
            document.getElementById('incompleteCount').textContent = `${incomplete}ä»¶`;
            document.getElementById('todayDeliveryCount').textContent = `${todayDeliveries}ä»¶`;
            document.getElementById('tomorrowDeliveryCount').textContent = `${tomorrowDeliveries}ä»¶`;
        }
// ===== è¡¨ç¤ºä¸­ã®ä¸€è¦§ï¼ˆ#tableBody ã®å¯è¦–è¡Œï¼‰ã‹ã‚‰é›†è¨ˆã—ã¦ä¸Šéƒ¨ã‚«ãƒ¼ãƒ‰ã«åæ˜  =====
function updateStatsFromView() {
    const rows = document.querySelectorAll('#tableBody tr');
    let visibleIds = [];
    rows.forEach(tr => {
        if (tr.style.display !== 'none') {
            const id = parseInt(tr.getAttribute('data-order-id'));
            if (!isNaN(id)) visibleIds.push(id);
        }
    });

    const visibleOrders = orders.filter(o => visibleIds.includes(o.id));

    const totalGross = visibleOrders.reduce((sum, o) => sum + (o.amountGross || 0), 0);
    const totalNet   = visibleOrders.reduce((sum, o) => sum + (o.amountNet   || 0), 0);
    const count      = visibleOrders.length;
    const incomplete = visibleOrders.filter(o => !o.orderCompleted).length;

    document.getElementById('totalGross').textContent = `Â¥${totalGross.toLocaleString()}`;
    document.getElementById('totalNet').textContent   = `Â¥${totalNet.toLocaleString()}`;
    document.getElementById('orderCount').textContent = `${count}ä»¶`;
    document.getElementById('incompleteCount').textContent = `${incomplete}ä»¶`;
}


        // æœˆè¡¨ç¤ºæ›´æ–°
        function updateMonth() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            document.getElementById('currentMonth').textContent = `${year}å¹´${month}æœˆ`;
        }

        // å‰æœˆ
        function prevMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            updateMonth();
            renderTable();
            updateStats();
        }

        // æ¬¡æœˆ
        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            updateMonth();
            renderTable();
            updateStats();
        }

        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
        function clearDateFilter() {
            document.getElementById('dateFilter').value = '';
            filterTable();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦å—æ³¨ç™»éŒ²';
            document.getElementById('orderForm').reset();
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            generateOrderNo();
            document.getElementById('orderModal').style.display = 'block';
            const content = document.querySelector('#orderModal .modal-content');
            if (content) content.scrollTop = 0;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
            editingId = null;
            document.querySelectorAll('.autocomplete-list').forEach(list => {
                list.classList.remove('active');
            });
        }

        // é¡§å®¢ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openCustomerMaster() {
            renderCustomerMaster();
            document.getElementById('customerMasterModal').style.display = 'block';
        }

        // é¡§å®¢ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeCustomerMaster() {
            document.getElementById('customerMasterModal').style.display = 'none';
        }

        // é¡§å®¢ãƒã‚¹ã‚¿æç”»
        function renderCustomerMaster() {
            const tbody = document.getElementById('customerMasterBody');
            tbody.innerHTML = customerMaster.map((customer, index) => `
                <tr>
                    <td><input type="text" class="form-input-full jp-input" value="${customer.name}" data-field="name" data-index="${index}" lang="ja" inputmode="text"></td>
                    <td><input type="text" class="form-input-full jp-input" value="${customer.address}" data-field="address" data-index="${index}" lang="ja" inputmode="text"></td>
                    <td><input type="tel" class="form-input-full numeric-input" value="${customer.tel}" data-field="tel" data-index="${index}" inputmode="tel"></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${index})">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // é¡§å®¢è¿½åŠ è¡Œ
        function addCustomerRow() {
            customerMaster.push({ name: '', address: '', tel: '' });
            renderCustomerMaster();
        }

        // é¡§å®¢å‰Šé™¤
        function deleteCustomer(index) {
            customerMaster.splice(index, 1);
            renderCustomerMaster();
        }

        // é¡§å®¢ãƒã‚¹ã‚¿ä¿å­˜
        function saveCustomerMaster() {
            const inputs = document.querySelectorAll('#customerMasterBody input');
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const field = input.dataset.field;
                customerMaster[index][field] = input.value;
            });
            
            localStorage.setItem('customerMaster', JSON.stringify(customerMaster));
            setupFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
            closeCustomerMaster();
            alert('é¡§å®¢ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openCargoMaster() {
            currentMasterType = 'cargo';
            document.getElementById('simpleMasterTitle').textContent = 'ç©è·ãƒã‚¹ã‚¿ç®¡ç†';
            renderSimpleMaster(cargoMaster);
            document.getElementById('simpleMasterModal').style.display = 'block';
        }

        function openPackagingMaster() {
            currentMasterType = 'packaging';
            document.getElementById('simpleMasterTitle').textContent = 'è·å§¿ãƒã‚¹ã‚¿ç®¡ç†';
            renderSimpleMaster(packagingMaster);
            document.getElementById('simpleMasterModal').style.display = 'block';
        }

        function openUnitMaster() {
            currentMasterType = 'unit';
            document.getElementById('simpleMasterTitle').textContent = 'å˜ä½ãƒã‚¹ã‚¿ç®¡ç†';
            renderSimpleMaster(unitMaster);
            document.getElementById('simpleMasterModal').style.display = 'block';
        }

        function openDriverMaster() {
            currentMasterType = 'driver';
            document.getElementById('simpleMasterTitle').textContent = 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒã‚¹ã‚¿ç®¡ç†';
            renderSimpleMaster(driverMaster);
            document.getElementById('simpleMasterModal').style.display = 'block';
        }

        function openVehicleMaster() {
            currentMasterType = 'vehicle';
            document.getElementById('simpleMasterTitle').textContent = 'è»Šä¸¡ãƒã‚¹ã‚¿ç®¡ç†';
            renderSimpleMaster(vehicleMaster);
            document.getElementById('simpleMasterModal').style.display = 'block';
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿æç”»
        function renderSimpleMaster(masterData) {
            const list = document.getElementById('simpleMasterList');
            list.innerHTML = masterData.map((item, index) => `
                <div class="master-item" draggable="true" data-index="${index}">
                    <span class="drag-handle">â˜°</span>
                    <span class="master-item-content">${item}</span>
                    <div class="master-item-actions">
                        <button onclick="deleteSimpleMasterItem(${index})">Ã—</button>
                    </div>
                </div>
            `).join('');
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            setupDragAndDrop();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.master-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.currentTarget;
            e.currentTarget.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(e.currentTarget.parentElement, e.clientY);
            if (afterElement == null) {
                e.currentTarget.parentElement.appendChild(draggedItem);
            } else {
                e.currentTarget.parentElement.insertBefore(draggedItem, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            updateMasterOrder();
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.master-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateMasterOrder() {
            const items = document.querySelectorAll('.master-item');
            const newOrder = [];
            
            items.forEach(item => {
                const index = parseInt(item.dataset.index);
                switch(currentMasterType) {
                    case 'cargo': newOrder.push(cargoMaster[index]); break;
                    case 'packaging': newOrder.push(packagingMaster[index]); break;
                    case 'unit': newOrder.push(unitMaster[index]); break;
                    case 'driver': newOrder.push(driverMaster[index]); break;
                    case 'vehicle': newOrder.push(vehicleMaster[index]); break;
                }
            });
            
            switch(currentMasterType) {
                case 'cargo': cargoMaster = newOrder; renderSimpleMaster(cargoMaster); break;
                case 'packaging': packagingMaster = newOrder; renderSimpleMaster(packagingMaster); break;
                case 'unit': unitMaster = newOrder; renderSimpleMaster(unitMaster); break;
                case 'driver': driverMaster = newOrder; renderSimpleMaster(driverMaster); break;
                case 'vehicle': vehicleMaster = newOrder; renderSimpleMaster(vehicleMaster); break;
            }
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
        function addSimpleMasterItem() {
            const input = document.getElementById('simpleMasterInput');
            const value = input.value.trim();
            if (!value) return;
            
            switch(currentMasterType) {
                case 'cargo': cargoMaster.push(value); renderSimpleMaster(cargoMaster); break;
                case 'packaging': packagingMaster.push(value); renderSimpleMaster(packagingMaster); break;
                case 'unit': unitMaster.push(value); renderSimpleMaster(unitMaster); break;
                case 'driver': driverMaster.push(value); renderSimpleMaster(driverMaster); break;
                case 'vehicle': vehicleMaster.push(value); renderSimpleMaster(vehicleMaster); break;
            }
            
            input.value = '';
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤
        function deleteSimpleMasterItem(index) {
            switch(currentMasterType) {
                case 'cargo': cargoMaster.splice(index, 1); renderSimpleMaster(cargoMaster); break;
                case 'packaging': packagingMaster.splice(index, 1); renderSimpleMaster(packagingMaster); break;
                case 'unit': unitMaster.splice(index, 1); renderSimpleMaster(unitMaster); break;
                case 'driver': driverMaster.splice(index, 1); renderSimpleMaster(driverMaster); break;
                case 'vehicle': vehicleMaster.splice(index, 1); renderSimpleMaster(vehicleMaster); break;
            }
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeSimpleMaster() {
            document.getElementById('simpleMasterModal').style.display = 'none';
            document.getElementById('simpleMasterInput').value = '';
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãƒã‚¹ã‚¿ä¿å­˜
        function saveSimpleMaster() {
            switch(currentMasterType) {
                case 'cargo': localStorage.setItem('cargoMaster', JSON.stringify(cargoMaster)); break;
                case 'packaging': localStorage.setItem('packagingMaster', JSON.stringify(packagingMaster)); break;
                case 'unit': localStorage.setItem('unitMaster', JSON.stringify(unitMaster)); break;
                case 'driver': localStorage.setItem('driverMaster', JSON.stringify(driverMaster)); break;
                case 'vehicle': localStorage.setItem('vehicleMaster', JSON.stringify(vehicleMaster)); break;
            }
            
            updateSelectOptions();
            setupFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
            closeSimpleMaster();
            alert(`${document.getElementById('simpleMasterTitle').textContent.replace('ç®¡ç†', '')}ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        // é¡§å®¢æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAddCustomerModal() {
            const form = document.getElementById('customerAddForm');
            if (form) form.reset();
            document.getElementById('customerAddModal').style.display = 'block';
            const nameInput = document.getElementById('newCustomerName');
            if (nameInput) nameInput.focus();
        }

        // é¡§å®¢æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCustomerAddModal() {
            document.getElementById('customerAddModal').style.display = 'none';
        }

        // é¡§å®¢æ–°è¦è¿½åŠ ã‚’ä¿å­˜
        function saveNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            const tel = document.getElementById('newCustomerTel').value.trim();

            if (!name) {
                alert('é¡§å®¢åã¯å¿…é ˆã§ã™');
                return;
            }

            // åŒåé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåå‰ãƒ™ãƒ¼ã‚¹ï¼‰
            const exists = customerMaster.some(c => c.name === name);
            if (exists) {
                alert('åŒåã®é¡§å®¢ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            customerMaster.push({ name, address, tel });
            localStorage.setItem('customerMaster', JSON.stringify(customerMaster));
            renderCustomerMaster();
            setupFilters();
            closeCustomerAddModal();
            alert('é¡§å®¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        // ã‚»ãƒ¬ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
        function updateSelectOptions() {
            // ç©è·
            const cargoSelect = document.getElementById('cargo');
            cargoSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                cargoMaster.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // è·å§¿
            const packagingSelect = document.getElementById('packaging');
            packagingSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                packagingMaster.map(p => `<option value="${p}">${p}</option>`).join('');
            
            // å˜ä½
            const unitSelect = document.getElementById('unit');
            unitSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                unitMaster.map(u => `<option value="${u}">${u}</option>`).join('');
            
            // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼
            const driverSelect = document.getElementById('driver');
            driverSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                driverMaster.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // è»Šä¸¡
            const vehicleSelect = document.getElementById('vehicle');
            vehicleSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                vehicleMaster.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        // å—æ³¨ç•ªå·ç”Ÿæˆï¼ˆåŒæ—¥ãƒ»åŒãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®æœ€å¤§ç•ªå·+1ï¼‰
        function generateOrderNo() {
            const dateInput = document.getElementById('orderDate');
            const dateStr = (dateInput && dateInput.value) ? dateInput.value : new Date().toISOString().split('T')[0];
            const [yearFull, monthRaw, dayRaw] = dateStr.split('-');
            const yy = String(yearFull || '').slice(2);
            const mm = String(monthRaw || '').padStart(2, '0');
            const dd = String(dayRaw || '').padStart(2, '0');
            const prefix = `R${yy}${mm}${dd}-`;
            let maxN = 0;
            if (Array.isArray(orders)) {
                for (const o of orders) {
                    const on = o && o.orderNo ? String(o.orderNo) : '';
                    if (on.startsWith(prefix)) {
                        const n = parseInt(on.slice(prefix.length), 10);
                        if (!Number.isNaN(n)) maxN = Math.max(maxN, n);
                    }
                }
            }
            const next = maxN + 1;
            const orderNo = `${prefix}${String(next).padStart(3, '0')}`;
            const input = document.getElementById('orderNo');
            if (input) input.value = orderNo;
        }

        // é‡‘é¡è¨ˆç®—ï¼ˆæ•°é‡Ã—å˜ä¾¡ã‹ã‚‰è¨ˆç®—ï¼‰
        function calculateAmount() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            
            if (quantity && unitPrice) {
                const amountNet = quantity * unitPrice;
                const amountGross = Math.round(amountNet * 1.1);
                
                document.getElementById('amountNet').value = amountNet;
                document.getElementById('amountGross').value = amountGross;
            }
        }

        // ç¨åˆ¥é‡‘é¡ã‹ã‚‰ç¨è¾¼é‡‘é¡ã‚’è¨ˆç®—
        function calculateGrossFromNet() {
            const amountNet = parseFloat(document.getElementById('amountNet').value) || 0;
            const amountGross = Math.round(amountNet * 1.1);
            document.getElementById('amountGross').value = amountGross;
        }


        // å—æ³¨ä¿å­˜
        function saveOrder() {
            // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤ã®å–å¾—ã¨æ¤œè¨¼
            const orderNo = document.getElementById('orderNo').value;
            const orderDate = document.getElementById('orderDate').value;
            const customerName = document.getElementById('customerName').value;
            const pickupLocation = document.getElementById('pickupLocation').value;
            const deliveryLocation = document.getElementById('deliveryLocation').value;
            const cargo = document.getElementById('cargo').value;
            const quantity = document.getElementById('quantity').value;
            const unit = document.getElementById('unit').value;
            const packaging = document.getElementById('packaging').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const amountNet = document.getElementById('amountNet').value;
            
            // å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°é‡ã€å˜ä½ã€å˜ä¾¡ã¯å¿…é ˆã‹ã‚‰é™¤å¤–ï¼‰
            if (!orderNo || !orderDate || !customerName || !pickupLocation || !deliveryLocation || !cargo) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            // å—æ³¨Noé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆç·¨é›†æ™‚ã¯è‡ªèº«ã‚’é™¤å¤–ï¼‰
            const hasDup = orders.some(o => String(o.orderNo) === String(orderNo) && (!editingId || o.id !== editingId));
            if (hasDup) {
                alert('å—æ³¨NoãŒæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡ã—ã¦ã„ã¾ã™ã€‚åˆ¥ã®ç•ªå·ã«ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const formData = {
                orderNo: orderNo,
                date: orderDate,
                customerName: customerName,
                pickupLocation: pickupLocation,
                pickupAddress: document.getElementById('pickupAddress').value,
                deliveryLocation: deliveryLocation,
                deliveryAddress: document.getElementById('deliveryAddress').value,
                deliveryTel: document.getElementById('deliveryTel').value,
                cargo: cargo,
                quantity: parseFloat(quantity) || 0,
                unit: unit || '',
                packaging: packaging || '',
                unitPrice: parseFloat(unitPrice) || 0,
                amountNet: parseFloat(amountNet) || 0,
                amountGross: parseFloat(document.getElementById('amountGross').value) || 0,
                instructions: document.getElementById('instructions').value,
                driver: document.getElementById('driver').value,
                vehicle: document.getElementById('vehicle').value,
                instructionSheet: false,
                invoiceSent: false,
                paymentReceived: false,
                orderCompleted: false
            };
            
            if (editingId) {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                const index = orders.findIndex(o => o.id === editingId);
                if (index !== -1) {
                    orders[index] = { ...orders[index], ...formData, id: editingId };
                }
            } else {
                // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
                formData.id = Date.now();
                orders.push(formData);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¨ç”»é¢æ›´æ–°
            let savedOk = true;
            try { saveData(); } catch(e) { savedOk = false; logError('LOCAL_SAVE', e); }
            // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ï¼ˆæœ‰åŠ¹æ™‚ï¼‰
            try {
                const target = editingId ? orders.find(o => o.id === editingId) : formData;
                if (cloudEnabled() && target) {
                    cloudUpsertOrder(target)
                        .then(() => { logInfo('CLOUD_SYNC', 'upsert ok', target.orderNo); showToast('CloudåŒæœŸå®Œäº†'); try { flushCloudQueue(2); } catch(_){} })
                        .catch(err => { logError('CLOUD_SYNC', err); enqueueCloudOp('upsert', target); updateCloudStatusUI(false); showToast('CloudåŒæœŸã«å¤±æ•—ï¼ˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼‰', 'error'); });
                }
            } catch(e) { logError('CLOUD_SYNC_UNCAUGHT', e); }
            
            // ç™»éŒ²ã—ãŸæœˆã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆ
            const orderDateObj = new Date(orderDate);
            currentMonth = new Date(orderDateObj.getFullYear(), orderDateObj.getMonth(), 1);
            updateMonth();
            
            const prevScrollY = window.scrollY;
            renderTable();
            const prevSearch = document.getElementById('searchInput')?.value || '';
            const prevDateFilter = document.getElementById('dateFilter')?.value || '';
            const prevDriverFilter = document.getElementById('driverFilter')?.value || '';
            const prevCustomerFilterSearch = document.getElementById('customerFilterSearch')?.value || '';
            
            updateStats();
            setupFilters();
            
            if (document.getElementById('searchInput')) document.getElementById('searchInput').value = prevSearch;
            if (document.getElementById('dateFilter')) document.getElementById('dateFilter').value = prevDateFilter;
            if (document.getElementById('customerFilterSearch')) document.getElementById('customerFilterSearch').value = prevCustomerFilterSearch;
            if (document.getElementById('driverFilter')) {
                const driverSel = document.getElementById('driverFilter');
                const exists = Array.from(driverSel.options).some(opt => opt.value === prevDriverFilter);
                driverSel.value = exists ? prevDriverFilter : '';
            }
            
            filterTable();
            // ç·¨é›†ã—ãŸè¡Œã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆè¡ŒãŒéè¡¨ç¤ºãªã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒï¼‰
            try {
                const targetId = editingId ? editingId : formData.id;
                setTimeout(() => {
                    const row = document.querySelector('#tableBody tr[data-order-id="' + targetId + '"]');
                    if (row && row.style.display !== 'none') {
                         row.scrollIntoView({ block: 'center', behavior: 'smooth' });
                         // ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ2ç§’ç¨‹åº¦ã§è‡ªå‹•è§£é™¤ï¼‰
                         try {
                             row.classList.add('row-highlight');
                             setTimeout(() => { try { row.classList.remove('row-highlight'); } catch(_){} }, 2000);
                         } catch(_){}
                         const editBtn = row.querySelector('.btn.btn-sm.btn-primary');
                         if (editBtn) { try { editBtn.focus({ preventScroll: true }); } catch(_){} }
                     } else {
                         window.scrollTo({ top: prevScrollY, behavior: 'auto' });
                     }
                }, 0);
            } catch(_) { /* noop */ }
            closeModal();
            
            if (savedOk) { showToast(editingId ? 'ç·¨é›†ã‚’ä¿å­˜ã—ã¾ã—ãŸ' : 'æ–°è¦å—æ³¨ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); } else { showToast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
        }

        // å—æ³¨ç·¨é›†ï¼ˆidãŒå–ã‚Œãªã„å ´åˆã¯è¡Œã®data-order-idã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function editOrder(id, el) {
            let order = orders.find(o => o.id === id);
            if (!order) {
                const btn = el || document.activeElement;
                const tr = btn && typeof btn.closest === 'function' ? btn.closest('tr') : null;
                const idAttr = tr ? tr.getAttribute('data-order-id') : null;
                if (idAttr != null) {
                    order = orders.find(o => String(o.id) === String(idAttr));
                }
            }
            if (!order) return;
            
            editingId = order.id;
            document.getElementById('modalTitle').textContent = 'å—æ³¨ç·¨é›†';
            
            document.getElementById('orderNo').value = order.orderNo;
            document.getElementById('orderDate').value = order.date;
            document.getElementById('customerName').value = order.customerName;
            document.getElementById('pickupLocation').value = order.pickupLocation;
            document.getElementById('pickupAddress').value = order.pickupAddress || '';
            document.getElementById('deliveryLocation').value = order.deliveryLocation;
            document.getElementById('deliveryAddress').value = order.deliveryAddress || '';
            document.getElementById('deliveryTel').value = order.deliveryTel || '';
            document.getElementById('cargo').value = order.cargo;
            document.getElementById('quantity').value = order.quantity;
            document.getElementById('unit').value = order.unit;
            document.getElementById('packaging').value = order.packaging || '';
            document.getElementById('unitPrice').value = order.unitPrice;
            document.getElementById('amountNet').value = order.amountNet;
            document.getElementById('amountGross').value = order.amountGross;
            document.getElementById('instructions').value = order.instructions || '';
            document.getElementById('driver').value = order.driver || '';
            document.getElementById('vehicle').value = order.vehicle || '';
            
            document.getElementById('orderModal').style.display = 'block';
            const content = document.querySelector('#orderModal .modal-content');
            if (content) content.scrollTop = 0;
        }
// === å—æ³¨è¤‡è£½æ©Ÿèƒ½ï¼ˆidãŒå–ã‚Œãªã„å ´åˆã¯è¡Œã®data-order-idã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ===
function duplicateOrder(id, el) {
    let o = orders.find(x => x.id === id);
    if (!o) {
        const btn = el || document.activeElement;
        const tr = btn && typeof btn.closest === 'function' ? btn.closest('tr') : null;
        const idAttr = tr ? tr.getAttribute('data-order-id') : null;
        if (idAttr != null) {
            o = orders.find(x => String(x.id) === String(idAttr));
        }
    }
    if (!o) return;

    // ç·¨é›†IDã¯æ–°è¦ã¨ã—ã¦æ‰±ã†
    editingId = null;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    document.getElementById('modalTitle').textContent = 'å—æ³¨è¤‡è£½';

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    document.getElementById('orderForm').reset();
    document.getElementById('orderModal').style.display = 'block';
    const content = document.querySelector('#orderModal .modal-content');
    if (content) content.scrollTop = 0;

    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æµã—è¾¼ã¿ï¼ˆå¿…è¦ç®‡æ‰€ã ã‘å¼•ãç¶™ãï¼‰
    document.getElementById('orderDate').value = '';
    document.getElementById('customerName').value = o.customerName || '';
    document.getElementById('pickupLocation').value = o.pickupLocation || '';
    document.getElementById('pickupAddress').value = o.pickupAddress || '';
    document.getElementById('deliveryLocation').value = o.deliveryLocation || '';
    document.getElementById('deliveryAddress').value = o.deliveryAddress || '';
    document.getElementById('deliveryTel').value = o.deliveryTel || '';
    document.getElementById('cargo').value = o.cargo || '';
    document.getElementById('quantity').value = o.quantity || '';
    document.getElementById('unit').value = o.unit || '';
    document.getElementById('packaging').value = o.packaging || '';
    document.getElementById('unitPrice').value = o.unitPrice || '';
    document.getElementById('amountNet').value = o.amountNet || '';
    document.getElementById('amountGross').value = o.amountGross || '';
    document.getElementById('instructions').value = o.instructions || '';
    document.getElementById('driver').value = '';
    document.getElementById('vehicle').value = '';

    // æ–°ã—ã„å—æ³¨Noã‚’æ¡ç•ªï¼ˆç¾åœ¨ã®æ³¨æ–‡æ—¥å…¥åŠ›å€¤ã«åŸºã¥ãï¼‰
    generateOrderNo();

    // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã®å€™è£œã‚’é–‰ã˜ã‚‹
    document.querySelectorAll('.autocomplete-list').forEach(list => list.classList.remove('active'));
}


        // å—æ³¨å‰Šé™¤
        function deleteOrder(id) {
            if (!confirm('ã“ã®å—æ³¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const target = orders.find(o => o.id === id);
            orders = orders.filter(o => o.id !== id);
            saveData();
            renderTable();
            updateStats();
            setupFilters();
            // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
            if (target && cloudEnabled()) {
                cloudDeleteOrderByOrderNo(target.orderNo).catch(err => logError('CLOUD_DELETE', err));
            }
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
        function setupFilters() {
            // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆ
            document.getElementById('driverFilter').innerHTML = '<option value="">å…¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>' +
                driverMaster.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰ã¯å»ƒæ­¢ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢å€™è£œã®ã¿ç”Ÿæˆ

            // é¡§å®¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢å€™è£œï¼ˆdatalistï¼‰ã‚’ç”Ÿæˆ
            const customerList = document.getElementById('customerFilterList');
            if (customerList) {
                customerList.innerHTML = customerMaster.map(c => `<option value="${c.name}"></option>`).join('');
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ•ã‚£ãƒ«ã‚¿
        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const driverFilter = document.getElementById('driverFilter').value;
            const customerFilterSearch = (document.getElementById('customerFilterSearch')?.value || '').toLowerCase();
            
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const dateText = row.cells[1].textContent;
                const driver = row.cells[11].textContent;
                const customer = row.cells[2].textContent;
                
                let show = true;
                
                if (search && !text.includes(search)) show = false;
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const rowDateStr = `${filterDate.getMonth() + 1}`.padStart(2, '0') + '/' + `${filterDate.getDate()}`.padStart(2, '0');
                    if (dateText !== rowDateStr) show = false;
                }
                if (driverFilter && !driver.includes(driverFilter)) show = false;
                if (customerFilterSearch && !customer.toLowerCase().includes(customerFilterSearch)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
updateStatsFromView();  // â˜…ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œã®å¯è¦–è¡Œã§å†é›†è¨ˆ

        }

        // å…¨é¸æŠåˆ‡ã‚Šæ›¿ãˆ
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#tableBody .order-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateRowSelection();
        }

        // é‹è¡ŒæŒ‡ç¤ºæ›¸å°åˆ·
        // é‹è¡ŒæŒ‡ç¤ºæ›¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å¤‰æ•°
        let instructionOrders = [];
        let dispatchTimeValue = '';

        // é‹è¡ŒæŒ‡ç¤ºæ›¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openInstructionSettingsModal(selectedOrders) {
            instructionOrders = [...selectedOrders];
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é…è»Šæ™‚é–“ã‚’è¨­å®šï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('dispatchTime').value = `${hours}:${minutes}`;
            
            // é †åºãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            renderOrderSequenceList();
            
            document.getElementById('instructionSettingsModal').style.display = 'flex';
        }

        // é‹è¡ŒæŒ‡ç¤ºæ›¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeInstructionSettingsModal() {
            document.getElementById('instructionSettingsModal').style.display = 'none';
            instructionOrders = [];
        }

        // é †åºãƒªã‚¹ãƒˆã‚’æç”»
        function renderOrderSequenceList() {
            const listContainer = document.getElementById('orderSequenceList');
            listContainer.innerHTML = '';
            
            instructionOrders.forEach((order, index) => {
                const item = document.createElement('div');
                item.className = 'order-sequence-item';
                item.draggable = true;
                item.dataset.index = index;
                
                item.innerHTML = `
                    <div class="drag-handle">â‰¡</div>
                    <div class="order-number">${index + 1}.</div>
                    <div class="order-info">
                        <strong>${order.customerName || order.customer_name || 'ï¼ˆé¡§å®¢åãªã—ï¼‰'}</strong>
                        <span style="color: #666; margin-left: 10px;">${order.orderNo || order.order_no || ''}</span>
                    </div>
                `;
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                
                listContainer.appendChild(item);
            });
        }

        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        let draggedElement = null;
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.style.opacity = '0.4';
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const dropIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedIndex !== dropIndex) {
                // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
                const draggedItem = instructionOrders[draggedIndex];
                instructionOrders.splice(draggedIndex, 1);
                instructionOrders.splice(dropIndex, 0, draggedItem);
                
                // ãƒªã‚¹ãƒˆã‚’å†æç”»
                renderOrderSequenceList();
            }
            
            return false;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd(e) {
            e.currentTarget.style.opacity = '1';
        }

        // é‹è¡ŒæŒ‡ç¤ºæ›¸ã‚’ç”Ÿæˆ
        function generateInstructionSheet() {
            const dispatchTime = document.getElementById('dispatchTime').value;
            
            if (!dispatchTime) {
                alert('é…è»Šæ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            dispatchTimeValue = dispatchTime;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeInstructionSettingsModal();
            
            // é‹è¡ŒæŒ‡ç¤ºæ›¸ã‚’å°åˆ·ï¼ˆä¿®æ­£ç‰ˆï¼‰
            printInstructionsWithSettings(instructionOrders, dispatchTimeValue);
        }
        // é…è»Šæ™‚é–“ã¨é †åºã‚’è¨­å®šã—ãŸé‹è¡ŒæŒ‡ç¤ºæ›¸ã‚’å°åˆ·ï¼ˆå®Œå…¨ç‰ˆï¼‰
        function printInstructionsWithSettings(printOrders, dispatchTime) {
            // ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–: ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ã¨ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã®ä¸¡æ–¹ã«å¯¾å¿œ
            printOrders = printOrders.map(order => ({
                ...order,
                orderNo: order.orderNo || order.order_no || '',
                customerName: order.customerName || order.customer_name || '',
                pickupLocation: order.pickupLocation || order.pickup_location || '',
                pickupAddress: order.pickupAddress || order.pickup_address || '',
                deliveryLocation: order.deliveryLocation || order.delivery_location || '',
                deliveryAddress: order.deliveryAddress || order.delivery_address || '',
                deliveryTel: order.deliveryTel || order.delivery_tel || '',
                cargo: order.cargo || '',
                quantity: order.quantity || '',
                unit: order.unit || '',
                packaging: order.packaging || '',
                instructions: order.instructions || '',
                driver: order.driver || '',
                vehicle: order.vehicle || ''
            }));
            
            // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰
            if (printOrders.length > 1) {
                const drivers = Array.from(new Set(
                    printOrders
                        .map(o => (o.driver || '').trim())
                        .filter(d => d.length > 0)
                ));
                if (drivers.length > 1) {
                    alert('è¤‡æ•°é¸æŠæ™‚ã¯åŒä¸€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§å°åˆ·ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰');
                    return;
                }
            }
            
            // é‹è¡ŒæŒ‡ç¤ºæ›¸ã®ç”Ÿæˆ
            let printContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>é‹è¡ŒæŒ‡ç¤ºæ›¸</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 10mm 15mm;
                        }
                        body { 
                            font-family: 'MS Gothic', 'ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯', monospace; 
                            font-size: 10pt;
                            line-height: 1.3;
                            color: #000;
                        }
                        .page { 
                            page-break-after: always;
                            position: relative;
                            width: 100%;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 8px;
                        }
                        .title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin-bottom: 2px;
                        }
                        .company-info {
                            font-size: 9pt;
                            line-height: 1.2;
                        }
                        
                        /* é…è»Šæ™‚é–“ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
                        .dispatch-time {
                            font-size: 16pt;
                            font-weight: bold;
                            margin: 10px 0 15px 0;
                            padding: 10px;
                            background: #ffffcc;
                            border: 2px solid #000;
                            text-align: center;
                        }
                        
                        /* è¤‡æ•°æ¡ˆä»¶ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                        .multi-orders {
                            margin-top: 10px;
                        }
                        .order-section {
                            margin-bottom: 15px;
                            border: 2px solid #000;
                            padding: 5px;
                        }
                        .order-header-outside {
                            font-size: 12pt;
                            font-weight: bold;
                            margin: 6px 0 6px 0;
                            line-height: 1.4;
                        }
                        .compact-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 5px;
                            font-size: 9pt;
                        }
                        .compact-table th {
                            background: #eeeeee;
                            border: 1px solid #000;
                            padding: 2px 4px;
                            text-align: left;
                            width: 20%;
                            font-weight: normal;
                        }
                        .compact-table td {
                            border: 1px solid #000;
                            padding: 2px 4px;
                        }
                        .instructions-compact {
                            border: 1px solid #000;
                            padding: 3px 5px;
                            font-size: 8pt;
                            min-height: 25px;
                            margin-bottom: 5px;
                        }
                        
                        /* æ¨™æº–æŒ‡ç¤ºäº‹é …ï¼ˆè¤‡æ•°æ¡ˆä»¶ç”¨ï¼‰ */
                        .standard-instructions {
                            font-size: 8pt;
                            line-height: 1.5;
                            margin-top: 10px;
                            padding: 8px;
                            background: #f5f5f5;
                            border: 1px solid #000;
                        }
                        
                        /* æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”» */
                        .operation-plan {
                            border: 1px solid #000;
                            padding: 8px;
                            font-size: 9pt;
                            margin-top: 10px;
                        }
                        .operation-plan-title {
                            font-size: 10pt;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .plan-table {
                            width: 100%;
                        }
                        .plan-table td {
                            padding: 3px 0;
                            font-size: 9pt;
                            vertical-align: bottom;
                        }
                        .plan-label {
                            width: 30%;
                        }
                        .plan-value {
                            border-bottom: 1px solid #000;
                            width: 70%;
                        }
                        
                        /* æŠ¼å°ã‚¹ãƒšãƒ¼ã‚¹ */
                        .signature-area {
                            margin-top: 10px;
                            text-align: right;
                        }
                        .signature-box {
                            display: inline-block;
                            text-align: center;
                        }
                        .signature-label {
                            font-size: 9pt;
                            margin-bottom: 3px;
                        }
                        .signature-stamp {
                            border: 1px solid #000;
                            width: 60px;
                            height: 60px;
                            display: inline-block;
                        }
                        
                        /* ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜ */
                        .footer-note {
                            font-size: 8pt;
                            margin-top: 10px;
                            line-height: 1.3;
                        }
                    </style>
                </head>
                <body>
            `;
            
            // è¤‡æ•°æ¡ˆä»¶ã‚’1æšã«ã¾ã¨ã‚ã‚‹å ´åˆ
            const MULTI_ORDERS_PER_PAGE = 4;
            
            for (let startIdx = 0; startIdx < printOrders.length; startIdx += MULTI_ORDERS_PER_PAGE) {
                const chunk = printOrders.slice(startIdx, startIdx + MULTI_ORDERS_PER_PAGE);
                const isLastPage = (startIdx + MULTI_ORDERS_PER_PAGE) >= printOrders.length;
                const isFirstPage = (startIdx === 0);

                printContent += `
                    <div class="page">
                        <div class="header">
                            <div class="title">é‹è¡ŒæŒ‡ç¤ºæ›¸ï¼ˆè²¨ç‰©ï¼‰</div>
                            <div class="company-info">
                                ${companyInfo.name}<br>
                                ${companyInfo.address}<br>
                                TELãƒ»FAX ${companyInfo.tel}
                            </div>
                        </div>
                `;
                
                // é…è»Šæ™‚é–“ã‚’1ãƒšãƒ¼ã‚¸ç›®ã®æœ€åˆã®æ¡ˆä»¶ã®ä¸Šã«è¡¨ç¤º
                if (isFirstPage && dispatchTime) {
                    printContent += `
                        <div class="dispatch-time">
                            1ä»¶ç›®ã®é…è»Šæ™‚é–“: ${dispatchTime}
                        </div>
                    `;
                }

                printContent += `<div class="multi-orders">`;

                // ã“ã®ãƒšãƒ¼ã‚¸ã«è¼‰ã›ã‚‹æ¡ˆä»¶ã‚’è¡¨ç¤º
                chunk.forEach((order, idx) => {
                    const globalIdx = startIdx + idx;
                    const orderDate = order.date ? new Date(order.date).toLocaleDateString('ja-JP') : '';
                    
                    printContent += `
                        <div class="order-header-outside">
                            ${globalIdx + 1}ä»¶ç›®: ${order.customerName || ''} (${orderDate})
                        </div>
                        <div class="order-section">
                            <table class="compact-table">
                                <tr>
                                    <th>å¼•å–å…ˆ</th>
                                    <td>${order.pickupLocation || ''}</td>
                                    <th>é…é€å…ˆ</th>
                                    <td>${order.deliveryLocation || ''}</td>
                                </tr>
                                <tr>
                                    <th>å¼•å–ä½æ‰€</th>
                                    <td colspan="3">${order.pickupAddress || ''}</td>
                                </tr>
                                <tr>
                                    <th>é…é€ä½æ‰€</th>
                                    <td colspan="3">${order.deliveryAddress || ''}</td>
                                </tr>
                                <tr>
                                    <th>ç©è·</th>
                                    <td>${order.cargo || ''}</td>
                                    <th>æ•°é‡</th>
                                    <td>${order.quantity || ''} ${order.unit || ''}</td>
                                </tr>
                            </table>
                            <div class="instructions-compact">
                                <strong>æŒ‡ç¤ºäº‹é …:</strong> ${(order.instructions || '').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                });

                printContent += `</div>`;

                const firstOrder = chunk[0];
                const driverName = firstOrder.driver || '';
                const vehicleName = firstOrder.vehicle || '';

                printContent += `
                    <div style="margin-top: 15px; font-size: 10pt;">
                        <div style="margin-bottom: 5px;">
                            <strong>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼:</strong> ${driverName}ã€€
                            <strong>è»Šä¸¡:</strong> ${vehicleName}
                        </div>
                    </div>
                `;

                // æœ€çµ‚ãƒšãƒ¼ã‚¸ã«ã®ã¿æ¨™æº–æŒ‡ç¤ºäº‹é …ã€æ³•ä»¤éµå®ˆã€æŠ¼å°ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜ã‚’è¡¨ç¤º
                if (isLastPage) {
                    printContent += `
                        <div class="standard-instructions">
                            <strong>ã€æ¨™æº–æŒ‡ç¤ºäº‹é …ã€‘</strong><br>
                            ãƒ»æ³•å®šé€Ÿåº¦ãƒ»è»Šé–“è·é›¢ãƒ»ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆå¾¹åº•<br>
                            ãƒ»é€£ç¶šé‹è»¢4æ™‚é–“ä»¥å†…ã”ã¨ã«30åˆ†ä»¥ä¸Šã®ä¼‘æ†©ï¼ˆåˆ†å‰²å¯ï¼‰<br>
                            ãƒ»è·å´©ã‚Œé˜²æ­¢ï¼å›ºç¸›ç¢ºèªã€å±é™ºäºˆæ¸¬é‹è»¢ã®å¾¹åº•<br>
                            ãƒ»å‡ºç™ºï¼å¸°åº«æ™‚ã®ç‚¹å‘¼ã€é…’æ°—å¸¯ã³ç„¡ãƒ»ä½“èª¿è‰¯å¥½ã‚’ç¢ºèª<br>
                            ãƒ»ç•°å¸¸ï¼äº‹æ•…ï¼æ¸‹æ»ç­‰ã¯é€Ÿã‚„ã‹ã«é…è»Šã¸é€£çµ¡
                        </div>
                        
                        <div class="operation-plan">
                            <div class="operation-plan-title">æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”»ï¼ˆç¾å ´è¨˜å…¥å¯ï¼‰</div>
                            <table class="plan-table">
                                <tr>
                                    <td class="plan-label">å‡ºç™ºäºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">åˆ°ç€äºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">é‹è¡ŒçµŒè·¯ãƒ»ä¸»ãªçµŒç”±åœ°ï¼ˆæ—¥æ™‚ï¼‰</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">æ³¨æ„ãŒå¿…è¦ãªç®‡æ‰€ã®ä½ç½®</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">ä¼‘æ†©åœ°ç‚¹ã¨æ™‚é–“</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">äº¤ä»£åœ°ç‚¹</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding-top: 5px;">ãã®ä»– å®‰å…¨ç¢ºä¿ã«å¿…è¦ãªäº‹é …</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="plan-value">&nbsp;</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-label">é‹è¡Œç®¡ç†è€…ã€€æŠ¼å°</div>
                                <div class="signature-stamp"></div>
                            </div>
                        </div>
                        
                        <div class="footer-note">
                            â€»æœ¬æŒ‡ç¤ºæ›¸ã¯è¼¸é€å®‰å…¨è¦å‰‡ã«æ²¿ã£ãŸè¨˜è¼‰é …ç›®ã‚’å«ã¿ã¾ã™ã€‚ç‚¹å‘¼ç°¿ãƒ»é‹è»¢æ—¥å ±ã¨ä½µã›ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    `;
                }

                printContent += `</div>`;
            }

            printContent += `
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            // æŒ‡ç¤ºæ›¸ç™ºè¡Œãƒ•ãƒ©ã‚°æ›´æ–°
            printOrders.forEach(order => {
                order.instructionSheet = true;
            });
            saveData();
            // ã‚¯ãƒ©ã‚¦ãƒ‰ä¸€æ‹¬æ›´æ–°
            try {
                if (cloudEnabled()) {
                    const ids = printOrders.map(o => o.id).filter(id => id != null);
                    cloudBatchUpdate(ids, { instructionSheet: true });
                }
            } catch(e) {}
            renderTable();
            updateStats();
        }


        function printInstructions() {
            const checkboxes = document.querySelectorAll('#tableBody .order-checkbox:checked');
            
            const selected = [];
            checkboxes.forEach(cb => {
                const id = parseInt(cb.getAttribute('data-id'));
                if (!isNaN(id)) {
                    selected.push(id);
                }
            });
            
            if (selected.length === 0) {
                alert('å°åˆ·ã™ã‚‹å—æ³¨ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const printOrders = orders.filter(o => selected.includes(o.id));

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            openInstructionSettingsModal(printOrders);
            return;

            // è¤‡æ•°é¸æŠæ™‚ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰
            if (printOrders.length > 1) {
                const drivers = Array.from(new Set(
                    printOrders
                        .map(o => (o.driver || '').trim())
                        .filter(d => d.length > 0)
                ));
                if (drivers.length > 1) {
                    alert('è¤‡æ•°é¸æŠæ™‚ã¯åŒä¸€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§å°åˆ·ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯é™¤å¤–ï¼‰');
                    return;
                }
            }
            
            // é‹è¡ŒæŒ‡ç¤ºæ›¸ã®ç”Ÿæˆ
            let printContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>é‹è¡ŒæŒ‡ç¤ºæ›¸</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 10mm 15mm;
                        }
                        body { 
                            font-family: 'MS Gothic', 'ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯', monospace; 
                            font-size: 10pt;
                            line-height: 1.3;
                            color: #000;
                        }
                        .page { 
                            page-break-after: always;
                            position: relative;
                            width: 100%;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 8px;
                        }
                        .title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin-bottom: 2px;
                        }
                        .company-info {
                            font-size: 9pt;
                            line-height: 1.2;
                        }
                        
                        /* è¤‡æ•°æ¡ˆä»¶ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                        .multi-orders {
                            margin-top: 10px;
                        }
                        .order-section {
                            margin-bottom: 15px;
                            border: 2px solid #000;
                            padding: 5px;
                        }
                        /* å„æ¡ˆä»¶ã®è¦‹å‡ºã—ã¯æ å¤–ä¸Šéƒ¨ã«ç‹¬ç«‹è¡¨ç¤ºï¼ˆå¼·èª¿è¡¨ç¤ºï¼‰ */
                        .order-header-outside {
                            font-size: 12pt; /* ã‚ˆã‚Šå¤§ããã—ã¦è¦–èªæ€§å‘ä¸Š */
                            font-weight: bold;
                            margin: 6px 0 6px 0; /* å‰å¾Œã«ä½™ç™½ã‚’è¿½åŠ  */
                            line-height: 1.4;
                        }
                        .compact-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 5px;
                            font-size: 9pt;
                        }
                        .compact-table th {
                            background: #eeeeee;
                            border: 1px solid #000;
                            padding: 2px 4px;
                            text-align: left;
                            width: 20%;
                            font-weight: normal;
                        }
                        .compact-table td {
                            border: 1px solid #000;
                            padding: 2px 4px;
                        }
                        .instructions-compact {
                            border: 1px solid #000;
                            padding: 3px 5px;
                            font-size: 8pt;
                            min-height: 25px;
                            margin-bottom: 5px;
                        }
                        
                        /* å˜ä¸€æ¡ˆä»¶ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                        .info-table {
                            width: 100%;
                            margin: 15px 0;
                        }
                        .info-table td {
                            padding: 3px 5px;
                            font-size: 10pt;
                        }
                        .main-table {
                            width: 100%;
                            border-collapse: collapse;
                            border: 2px solid #000;
                            margin-bottom: 10px;
                        }
                        .main-table th {
                            background: #d8d8d8;
                            border: 1px solid #000;
                            padding: 4px;
                            font-size: 10pt;
                            font-weight: normal;
                            text-align: left;
                            width: 25%;
                        }
                        .main-table td {
                            border: 1px solid #000;
                            padding: 4px;
                            font-size: 10pt;
                        }
                        .cargo-table {
                            width: 100%;
                            border-collapse: collapse;
                            border: 2px solid #000;
                            margin-bottom: 10px;
                        }
                        .cargo-table th {
                            background: #d8d8d8;
                            border: 1px solid #000;
                            padding: 4px;
                            font-size: 9pt;
                            font-weight: normal;
                            text-align: center;
                        }
                        .cargo-table td {
                            border: 1px solid #000;
                            padding: 4px 6px;
                            font-size: 10pt;
                            text-align: center;
                        }
                        .instructions-box {
                            font-size: 9pt;
                            line-height: 1.6;
                            vertical-align: top;
                            text-align: left !important;
                        }
                        .individual-box {
                            border: 1px solid #000;
                            padding: 5px;
                            margin-bottom: 10px;
                            min-height: 40px;
                            font-size: 10pt;
                        }
                        .individual-box-title {
                            font-size: 9pt;
                            margin-bottom: 3px;
                        }
                        .operation-plan {
                            border: 1px solid #000;
                            padding: 8px;
                            font-size: 9pt;
                        }
                        .operation-plan-title {
                            font-size: 10pt;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .plan-table {
                            width: 100%;
                        }
                        .plan-table td {
                            padding: 3px 0;
                            font-size: 9pt;
                            vertical-align: bottom;
                        }
                        .plan-label {
                            width: 30%;
                        }
                        .plan-value {
                            border-bottom: 1px solid #000;
                            width: 70%;
                        }
                        .signature-area {
                            margin-top: 10px;
                            text-align: right;
                        }
                        .signature-box {
                            display: inline-block;
                            text-align: center;
                        }
                        .signature-label {
                            font-size: 9pt;
                            margin-bottom: 3px;
                        }
                        .signature-stamp {
                            border: 1px solid #000;
                            width: 60px;
                            height: 60px;
                            display: inline-block;
                        }
                        .footer-note {
                            font-size: 8pt;
                            margin-top: 10px;
                            line-height: 1.3;
                        }
                        .standard-instructions {
                            font-size: 8pt;
                            line-height: 1.3;
                            margin-top: 5px;
                            padding: 3px;
                            background: #f5f5f5;
                        }
                    </style>
                </head>
                <body>
            `;
            
            // è¤‡æ•°æ¡ˆä»¶ã‚’1æšã«ã¾ã¨ã‚ã‚‹å ´åˆ
            if (printOrders.length > 1) {
                // é¸æŠæ¡ˆä»¶ã‚’ãã®ã¾ã¾4ä»¶ãšã¤ãƒšãƒ¼ã‚¸åˆ†å‰²ï¼ˆæ—¥ä»˜ã§åˆ†ã‘ãªã„ï¼‰
                for (let startIdx = 0; startIdx < printOrders.length; startIdx += MULTI_ORDERS_PER_PAGE) {
                    const chunk = printOrders.slice(startIdx, startIdx + MULTI_ORDERS_PER_PAGE);

                    const isLastPage = (startIdx + MULTI_ORDERS_PER_PAGE) >= printOrders.length;

                    printContent += `
                        <div class="page">
                            <div class="header">
                                <div class="title">é‹è¡ŒæŒ‡ç¤ºæ›¸ï¼ˆè²¨ç‰©ï¼‰</div>
                                <div class="company-info">
                                    ${companyInfo.name}<br>
                                    ${companyInfo.address}<br>
                                    TELãƒ»FAX ${companyInfo.tel}
                                </div>
                            </div>

                            <div class="multi-orders">
                    `;

                    // ã“ã®ãƒšãƒ¼ã‚¸ã«è¼‰ã›ã‚‹æ¡ˆä»¶ã‚’è¡¨ç¤º
                    chunk.forEach((order, index) => {
                        const orderDate = new Date(order.date);
                        const formattedDate = `${orderDate.getFullYear()}/${(orderDate.getMonth() + 1).toString().padStart(2, '0')}/${orderDate.getDate().toString().padStart(2, '0')}`;
                        const displayIndex = startIdx + index + 1; // é¸æŠå…¨ä½“ã®é€šã—ç•ªå·

                        printContent += `
                                <div class="order-header-outside">
                                    ã€${displayIndex}ã€‘é‹è¡Œæ—¥: ${formattedDate} / é‹è»¢è€…: ${order.driver || 'æœªå®š'} / è»Šä¸¡: ${order.vehicle || 'æœªå®š'}
                                </div>
                                <div class="order-section">

                                <table class="compact-table">
                                    <tr>
                                        <th>å¼•å–å…ˆ</th>
                                        <td colspan="3">${order.pickupLocation} æ§˜ ${order.pickupAddress ? `(${order.pickupAddress})` : ''}</td>
                                    </tr>
                                    <tr>
                                        <th>è·æ¸¡å…ˆ</th>
                                        <td colspan="3">${order.deliveryLocation} æ§˜ ${order.deliveryAddress ? `(${order.deliveryAddress})` : ''}</td>
                                    </tr>
                                    <tr>
                                        <th>é€£çµ¡å…ˆ</th>
                                        <td>${order.deliveryTel || '-'}</td>
                                        <th style="width: 15%; background: #eeeeee;">ç©è·</th>
                                        <td>${order.cargo}</td>
                                    </tr>
                                    <tr>
                                        <th>æ•°é‡</th>
                                        <td>${order.quantity} ${order.unit}</td>
                                        <th style="background: #eeeeee;">è·å§¿</th>
                                        <td>${order.packaging || '-'}</td>
                                    </tr>
                                </table>

                                ${order.instructions ? `
                                <div class="instructions-compact">
                                    <strong>å€‹åˆ¥æŒ‡ç¤ºäº‹é …:</strong> ${order.instructions.replace(/\n/g, ' / ')}
                                </div>
                                ` : ''}
                                </div>
                        `;
                    });

                    printContent += `
                            </div>

                            <div class="standard-instructions">
                                <strong>æ¨™æº–æŒ‡ç¤ºäº‹é …:</strong>
                                æ³•å®šé€Ÿåº¦ãƒ»è»Šé–“è·é›¢ãƒ»ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆå¾¹åº• /
                                é€£ç¶šé‹è»¢4æ™‚é–“ä»¥å†…ã”ã¨ã«30åˆ†ä»¥ä¸Šã®ä¼‘æ†©ï¼ˆåˆ†å‰²å¯ï¼‰ /
                                è·å´©ã‚Œé˜²æ­¢ï¼å›ºç¸›ç¢ºèªã€å±é™ºäºˆæ¸¬é‹è»¢ã®å¾¹åº• /
                                å‡ºç™ºï¼å¸°åº«æ™‚ã®ç‚¹å‘¼ã€é…’æ°—å¸¯ã³ç„¡ãƒ»ä½“èª¿è‰¯å¥½ã‚’ç¢ºèª /
                                ç•°å¸¸ï¼äº‹æ•…ï¼æ¸‹æ»ç­‰ã¯é€Ÿã‚„ã‹ã«é…è»Šã¸é€£çµ¡
                            </div>

                            <div class="operation-plan" style="margin-top: 10px;">
                                <div style="font-size: 9pt; font-weight: bold; margin-bottom: 5px;">æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”»ï¼ˆç¾å ´è¨˜å…¥å¯ï¼‰</div>
                                <table class="plan-table">
                                    <tr>
                                        <td style="width: 25%;">å‡ºç™ºäºˆå®š:</td>
                                        <td style="border-bottom: 1px solid #000;">&nbsp;</td>
                                        <td style="width: 25%; padding-left: 10px;">åˆ°ç€äºˆå®š:</td>
                                        <td style="border-bottom: 1px solid #000;">&nbsp;</td>
                                    </tr>
                                    <tr>
                                        <td>é‹è¡ŒçµŒè·¯:</td>
                                        <td colspan="3" style="border-bottom: 1px solid #000;">&nbsp;</td>
                                    </tr>
                                    <tr>
                                        <td>ä¼‘æ†©åœ°ç‚¹:</td>
                                        <td style="border-bottom: 1px solid #000;">&nbsp;</td>
                                        <td style="padding-left: 10px;">æ³¨æ„ç®‡æ‰€:</td>
                                        <td style="border-bottom: 1px solid #000;">&nbsp;</td>
                                    </tr>
                                </table>
                            </div>

                            ${isLastPage ? `
                            <div class="signature-area">
                                <div class="signature-box">
                                    <div class="signature-label">é‹è¡Œç®¡ç†è€…ã€€æŠ¼å°</div>
                                    <div class="signature-stamp"></div>
                                </div>
                            </div>

                            <div class="footer-note">
                                â€»æœ¬æŒ‡ç¤ºæ›¸ã¯è¼¸é€å®‰å…¨è¦å‰‡ã«æ²¿ã£ãŸè¨˜è¼‰é …ç›®ã‚’å«ã¿ã¾ã™ã€‚ç‚¹å‘¼ç°¿ãƒ»é‹è»¢æ—¥å ±ã¨ä½µã›ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } else {
                // å˜ä¸€æ¡ˆä»¶ã®å ´åˆã¯å¾“æ¥ã®å½¢å¼
                const order = printOrders[0];
                const orderDate = new Date(order.date);
                const formattedDate = `${orderDate.getFullYear()}/${(orderDate.getMonth() + 1).toString().padStart(2, '0')}/${orderDate.getDate().toString().padStart(2, '0')}`;
                
                printContent += `
                    <div class="page">
                        <div class="header">
                            <div class="title">é‹è¡ŒæŒ‡ç¤ºæ›¸ï¼ˆè²¨ç‰©ï¼‰</div>
                            <div class="company-info">
                                ${companyInfo.name}<br>
                                ${companyInfo.address}<br>
                                TELãƒ»FAX ${companyInfo.tel}
                            </div>
                        </div>
                        
                        <table class="info-table">
                            <tr>
                                <td style="width: 25%;">æŒ‡ç¤ºæ—¥/é‹è¡Œæ—¥</td>
                                <td colspan="3"><strong>${formattedDate}</strong></td>
                            </tr>
                            <tr>
                                <td>é‹è»¢è€…</td>
                                <td><strong>${order.driver || 'æœªå®š'}</strong></td>
                                <td>è»Šä¸¡</td>
                                <td><strong>${order.vehicle || 'æœªå®š'}</strong></td>
                            </tr>
                        </table>
                        
                        <table class="main-table">
                            <tr>
                                <th>å‡ºç™ºåœ°ï¼ˆå¼•å–å…ˆï¼‰</th>
                                <td colspan="3">${order.pickupLocation} æ§˜<br>${order.pickupAddress || ''}</td>
                            </tr>
                            <tr>
                                <th>åˆ°ç€åœ°ï¼ˆè·æ¸¡å…ˆï¼‰</th>
                                <td colspan="3">${order.deliveryLocation} æ§˜<br>${order.deliveryAddress || ''}</td>
                            </tr>
                            <tr>
                                <th>é€£çµ¡å…ˆï¼ˆç´å“å…ˆï¼‰</th>
                                <td colspan="3">${order.deliveryTel || ''}</td>
                            </tr>
                        </table>
                        
                        <table class="cargo-table">
                            <tr>
                                <th style="width: 20%;">ç©è¼‰ç‰©</th>
                                <th style="width: 15%;">è·å§¿</th>
                                <th style="width: 15%;">æ•°é‡</th>
                                <th style="width: 50%;">æ¨™æº–æŒ‡ç¤ºäº‹é …</th>
                            </tr>
                            <tr>
                                <td>${order.cargo}</td>
                                <td>${order.packaging || ''}</td>
                                <td>${order.quantity}<br>${order.unit}</td>
                                <td rowspan="2" class="instructions-box">
                                    ãƒ»æ³•å®šé€Ÿåº¦ãƒ»è»Šé–“è·é›¢ãƒ»ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆå¾¹åº•<br>
                                    ãƒ»é€£ç¶šé‹è»¢4æ™‚é–“ä»¥å†…ã”ã¨ã«30åˆ†ä»¥ä¸Šã®ä¼‘æ†©ï¼ˆåˆ†å‰²å¯ï¼‰<br>
                                    ãƒ»è·å´©ã‚Œé˜²æ­¢ï¼å›ºç¸›ç¢ºèªã€å±é™ºäºˆæ¸¬é‹è»¢ã®å¾¹åº•<br>
                                    ãƒ»å‡ºç™ºï¼å¸°åº«æ™‚ã®ç‚¹å‘¼ã€é…’æ°—å¸¯ã³ç„¡ãƒ»ä½“èª¿è‰¯å¥½ã‚’ç¢ºèª<br>
                                    ãƒ»ç•°å¸¸ï¼äº‹æ•…ï¼æ¸‹æ»ç­‰ã¯é€Ÿã‚„ã‹ã«é…è»Šã¸é€£çµ¡
                                </td>
                            </tr>
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                        </table>
                        
                        <div class="individual-box">
                            <div class="individual-box-title">å€‹åˆ¥æŒ‡ç¤ºäº‹é …ï¼ˆãƒ¬ã‚³ãƒ¼ãƒ‰ã€ŒæŒ‡ç¤ºäº‹é …ã€ã‚’åæ˜ ï¼‰</div>
                            ${order.instructions ? order.instructions.replace(/\n/g, '<br>') : '&nbsp;'}
                        </div>
                        
                        <div class="operation-plan">
                            <div class="operation-plan-title">æ³•ä»¤éµå®ˆã«åŸºã¥ãé‹è¡Œè¨ˆç”»ï¼ˆç¾å ´è¨˜å…¥å¯ï¼‰</div>
                            <table class="plan-table">
                                <tr>
                                    <td class="plan-label">å‡ºç™ºäºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">åˆ°ç€äºˆå®š</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">é‹è¡ŒçµŒè·¯ãƒ»ä¸»ãªçµŒç”±åœ°ï¼ˆæ—¥æ™‚ï¼‰</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">æ³¨æ„ãŒå¿…è¦ãªç®‡æ‰€ã®ä½ç½®</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">ä¼‘æ†©åœ°ç‚¹ã¨æ™‚é–“</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="plan-label">äº¤ä»£åœ°ç‚¹</td>
                                    <td class="plan-value">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding-top: 5px;">ãã®ä»– å®‰å…¨ç¢ºä¿ã«å¿…è¦ãªäº‹é …</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="plan-value">&nbsp;</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-label">é‹è¡Œç®¡ç†è€…ã€€æŠ¼å°</div>
                                <div class="signature-stamp"></div>
                            </div>
                        </div>
                        
                        <div class="footer-note">
                            â€»æœ¬æŒ‡ç¤ºæ›¸ã¯è¼¸é€å®‰å…¨è¦å‰‡ã«æ²¿ã£ãŸè¨˜è¼‰é …ç›®ã‚’å«ã¿ã¾ã™ã€‚ç‚¹å‘¼ç°¿ãƒ»é‹è»¢æ—¥å ±ã¨ä½µã›ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>
                `;
            }
            
            printContent += '</body></html>';
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (printWindow) {
                printWindow.document.write(printContent);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, PRINT_DELAY_MS);
                
                // æŒ‡ç¤ºæ›¸ç™ºè¡Œãƒ•ãƒ©ã‚°æ›´æ–°
                printOrders.forEach(order => {
                    order.instructionSheet = true;
                });
                saveData();
                // ã‚¯ãƒ©ã‚¦ãƒ‰ä¸€æ‹¬æ›´æ–°
                try {
                    if (cloudEnabled()) {
                        const ids = printOrders.map(o => o.id).filter(id => id != null);
                        cloudBatchUpdate(ids, { instructionSheet: true });
                    }
                } catch(e) {}
                renderTable();
                updateStats();
            }
        }

        // å¼•å–æ›¸å°åˆ·
        function printPickupSlips() {
            const checkboxes = document.querySelectorAll('#tableBody .order-checkbox:checked');
            
            const selected = [];
            checkboxes.forEach(cb => {
                const id = parseInt(cb.getAttribute('data-id'));
                if (!isNaN(id)) {
                    selected.push(id);
                }
            });
            
            if (selected.length === 0) {
                alert('å°åˆ·ã™ã‚‹å—æ³¨ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const printOrders = orders.filter(o => selected.includes(o.id));
            
            // è²¨ç‰©å¼•å–æ›¸ãƒ»è·æ¸¡æ›¸ã®ç”Ÿæˆ
            let printContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>è²¨ç‰©å¼•å–æ›¸ãƒ»è·æ¸¡æ›¸</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 10mm;
                        }
                        body { 
                            font-family: 'MS Gothic', 'ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯', monospace; 
                            font-size: 10pt;
                            line-height: 1.3;
                            color: #000;
                        }
                        .page { 
                            page-break-after: always;
                            position: relative;
                        }
                        .slip {
                            border: 2px dashed #333;
                            padding: 12px;
                            margin-bottom: 15px;
                            position: relative;
                            height: 48%;
                        }
                        .slip-type {
                            position: absolute;
                            top: 8px;
                            right: 12px;
                            font-size: 9pt;
                        }
                        .title {
                            font-size: 14pt;
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 5px;
                        }
                        .company-info {
                            text-align: center;
                            font-size: 9pt;
                            line-height: 1.2;
                            margin-bottom: 8px;
                        }
                        .info-table {
                            width: 100%;
                            margin-bottom: 8px;
                        }
                        .info-table td {
                            padding: 2px 5px;
                            font-size: 9pt;
                        }
                        .main-table {
                            width: 100%;
                            border-collapse: collapse;
                            border: 1px solid #000;
                            margin-bottom: 8px;
                        }
                        .main-table th {
                            background: #d8d8d8;
                            border: 1px solid #000;
                            padding: 3px;
                            font-size: 9pt;
                            font-weight: normal;
                            text-align: center;
                        }
                        .main-table td {
                            border: 1px solid #000;
                            padding: 3px;
                            font-size: 9pt;
                            text-align: center;
                        }
                        .address-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        .address-table td {
                            border: 1px solid #000;
                            padding: 4px 6px;
                            font-size: 9pt;
                        }
                        .address-label {
                            background: #d8d8d8;
                            width: 20%;
                            font-weight: normal;
                        }
                        .receipt-section {
                            margin-top: 10px;
                            border: 1px solid #000;
                            padding: 5px;
                        }
                        .receipt-title {
                            font-size: 9pt;
                            margin-bottom: 8px;
                        }
                        .receipt-table {
                            width: 100%;
                        }
                        .receipt-table td {
                            padding: 3px 0;
                            font-size: 9pt;
                        }
                        .underline {
                            display: inline-block;
                            border-bottom: 1px solid #000;
                            min-width: 150px;
                            margin: 0 5px;
                        }
                        .stamp-box {
                            display: inline-block;
                            border: 1px solid #000;
                            width: 40px;
                            height: 40px;
                            vertical-align: bottom;
                            margin-left: 10px;
                        }
                        .cut-line {
                            border-top: 1px dotted #666;
                            margin: 10px 0;
                            position: relative;
                            height: 0;
                        }
                    </style>
                </head>
                <body>
            `;
            
            // å„å—æ³¨ã”ã¨ã«è²¨ç‰©å¼•å–æ›¸ãƒ»è·æ¸¡æ›¸ã‚’ç”Ÿæˆ
            printOrders.forEach((order, index) => {
                const orderDate = new Date(order.date);
                const formattedDate = `${orderDate.getFullYear()}/${(orderDate.getMonth() + 1).toString().padStart(2, '0')}/${orderDate.getDate().toString().padStart(2, '0')}`;
                
                printContent += `
                    <div class="page">
                        <!-- ãŠå®¢æ§˜æ§ãˆ -->
                        <div class="slip">
                            <div class="slip-type">ã€ŠãŠå®¢æ§˜æ§ã€‹</div>
                            <div class="title">è²¨ç‰©å¼•å–æ›¸ãƒ»è·æ¸¡æ›¸</div>
                            <div class="company-info">
                                ${companyInfo.name}ã€ŠãŠå®¢æ§˜æ§ã€‹<br>
                                ${companyInfo.address}<br>
                                TELãƒ»FAX ${companyInfo.tel}
                            </div>
                            
                            <table class="info-table">
                                <tr>
                                    <td style="width: 15%;">é…é”æ—¥</td>
                                    <td style="width: 35%;"><strong>${formattedDate}</strong></td>
                                    <td style="width: 15%;">è»Šç•ª</td>
                                    <td style="width: 35%;"><strong>${order.vehicle || ''}</strong></td>
                                </tr>
                                <tr>
                                    <td>é‹è»¢è€…</td>
                                    <td colspan="3"><strong>${order.driver || ''}</strong></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 4px;">
                                <tr>
                                    <td class="address-label">å¼•å–å…ˆ</td>
                                    <td>${order.pickupLocation} æ§˜<br><span style="font-size: 8pt;">${order.pickupAddress || ''}</span></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 4px;">
                                <tr>
                                    <td class="address-label">è·æ¸¡å…ˆ</td>
                                    <td>${order.deliveryLocation} æ§˜<br><span style="font-size: 8pt;">${order.deliveryAddress || ''}</span></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 8px;">
                                <tr>
                                    <td class="address-label">ã”ä¾é ¼ä¸»</td>
                                    <td>${order.customerName} æ§˜</td>
                                </tr>
                            </table>
                            
                            <table class="main-table">
                                <tr>
                                    <th style="width: 16%;">å“å</th>
                                    <th style="width: 14%;">å“ç¨®</th>
                                    <th style="width: 14%;">è¦æ ¼</th>
                                    <th style="width: 14%;">è·å§¿</th>
                                    <th style="width: 14%;">å€‹æ•°</th>
                                    <th style="width: 14%;">å˜ä½</th>
                                </tr>
                                <tr>
                                    <td>${order.cargo}</td>
                                    <td></td>
                                    <td></td>
                                    <td>${order.packaging || ''}</td>
                                    <td>${order.quantity}</td>
                                    <td>${order.unit}</td>
                                </tr>
                                <tr style="height: 20px;">
                                    <td>&nbsp;</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="text-align: right; background: #d8d8d8;">åˆè¨ˆ</td>
                                    <td style="font-weight: bold;">${order.quantity}</td>
                                    <td style="font-weight: bold;">${order.unit}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="cut-line"></div>
                        
                        <!-- åŸæœ¬ï¼ˆä¿ç®¡ç”¨ï¼‰ -->
                        <div class="slip">
                            <div class="slip-type">ã€ŠåŸæœ¬ï¼ˆä¿ç®¡ç”¨ï¼‰ã€‹</div>
                            <div class="title">è²¨ç‰©å¼•å–æ›¸ãƒ»è·æ¸¡æ›¸</div>
                            <div class="company-info">
                                ${companyInfo.name}ã€ŠåŸæœ¬ï¼ˆä¿ç®¡ç”¨ï¼‰ã€‹<br>
                                ${companyInfo.address}<br>
                                TELãƒ»FAX ${companyInfo.tel}
                            </div>
                            
                            <table class="info-table">
                                <tr>
                                    <td style="width: 15%;">é…é”æ—¥</td>
                                    <td style="width: 35%;"><strong>${formattedDate}</strong></td>
                                    <td style="width: 15%;">è»Šç•ª</td>
                                    <td style="width: 35%;"><strong>${order.vehicle || ''}</strong></td>
                                </tr>
                                <tr>
                                    <td>é‹è»¢è€…</td>
                                    <td colspan="3"><strong>${order.driver || ''}</strong></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 4px;">
                                <tr>
                                    <td class="address-label">å¼•å–å…ˆ</td>
                                    <td>${order.pickupLocation} æ§˜<br><span style="font-size: 8pt;">${order.pickupAddress || ''}</span></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 4px;">
                                <tr>
                                    <td class="address-label">è·æ¸¡å…ˆ</td>
                                    <td>${order.deliveryLocation} æ§˜<br><span style="font-size: 8pt;">${order.deliveryAddress || ''}</span></td>
                                </tr>
                            </table>
                            
                            <table class="address-table" style="margin-bottom: 8px;">
                                <tr>
                                    <td class="address-label">ã”ä¾é ¼ä¸»</td>
                                    <td>${order.customerName} æ§˜</td>
                                </tr>
                            </table>
                            
                            <table class="main-table" style="margin-bottom: 8px;">
                                <tr>
                                    <th style="width: 16%;">å“å</th>
                                    <th style="width: 14%;">å“ç¨®</th>
                                    <th style="width: 14%;">è¦æ ¼</th>
                                    <th style="width: 14%;">è·å§¿</th>
                                    <th style="width: 14%;">å€‹æ•°</th>
                                    <th style="width: 14%;">å˜ä½</th>
                                </tr>
                                <tr>
                                    <td>${order.cargo}</td>
                                    <td></td>
                                    <td></td>
                                    <td>${order.packaging || ''}</td>
                                    <td>${order.quantity}</td>
                                    <td>${order.unit}</td>
                                </tr>
                                <tr style="height: 20px;">
                                    <td>&nbsp;</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="text-align: right; background: #d8d8d8;">åˆè¨ˆ</td>
                                    <td style="font-weight: bold;">${order.quantity}</td>
                                    <td style="font-weight: bold;">${order.unit}</td>
                                </tr>
                            </table>
                            
                            <div class="receipt-section">
                                <div class="receipt-title">å—é ˜ç¢ºèªï¼ˆãŠå®¢æ§˜ã”è¨˜å…¥ï¼‰</div>
                                <table class="receipt-table">
                                    <tr>
                                        <td style="width: 30%;">ãƒ»å—é ˜è€…æ°åï¼ˆç½²åï¼‰ï¼š</td>
                                        <td>
                                            <span class="underline">&nbsp;</span>
                                            æ§˜å°ï¼š<span class="stamp-box"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>ãƒ»æ—¥ä»˜ï¼š</td>
                                        <td>
                                            <span style="display: inline-block; border-bottom: 1px solid #000; width: 60px;">&nbsp;</span>å¹´
                                            <span style="display: inline-block; border-bottom: 1px solid #000; width: 40px;">&nbsp;</span>æœˆ
                                            <span style="display: inline-block; border-bottom: 1px solid #000; width: 40px;">&nbsp;</span>æ—¥
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            printContent += '</body></html>';
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (printWindow) {
                printWindow.document.write(printContent);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, PRINT_DELAY_MS);
            }
        }

        // ç¤¾å†…ç”¨CSVã‚’å½“æœˆå—æ³¨ã‹ã‚‰ç”Ÿæˆï¼ˆBOMä»˜ã€æ•°å€¤ã¯æ­£è¦åŒ–ï¼‰
        async function exportCSV() {
            const monthOrders = getMonthOrders();
            // CSVåˆ—å®šç¾©ï¼ˆç¤¾å†…ç”¨ï¼‰
            const headers = ['æ—¥ä»˜', 'é¡§å®¢å', 'å¼•å–å…ˆ', 'é…é€å…ˆ', 'ç©è·', 'æ•°é‡', 'å˜ä½', 'å˜ä¾¡', 'é‡‘é¡(ç¨åˆ¥)', 'é‡‘é¡(ç¨è¾¼)', 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼', 'è»Šä¸¡'];

            let csv = headers.join(',') + '\n';
            monthOrders.forEach(order => {
                const row = [
                    order.date,
                    order.customerName,
                    order.pickupLocation,
                    order.deliveryLocation,
                    order.cargo,
                    order.quantity,
                    order.unit,
                    toNumber(order.unitPrice),
                    toNumber(order.amountNet),
                    toNumber(order.amountGross),
                    order.driver || '',
                    order.vehicle || ''
                ];
                csv += row.map(v => `"${v}"`).join(',') + '\n';
            });

            const blob = new Blob([CSV_BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const fname = `å—æ³¨æ˜ç´°_${currentMonth.getFullYear()}å¹´${currentMonth.getMonth() + 1}æœˆ.csv`;
            // æ¡ˆä»¶CSV ãƒ•ã‚©ãƒ«ãƒ€ã¸ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ«ãƒ€è¨­å®šæ¸ˆã¿ãªã‚‰ï¼‰
            if (await saveCsvToDir(blob, fname)) {
                alert('CSVã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆè¨­å®šãƒ•ã‚©ãƒ«ãƒ€ï¼‰');
                return;
            }
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé€šå¸¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fname;
            link.click();
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;
                    
                    const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if (!values) continue;
                    
                    const cleanValues = values.map(v => v.replace(/^"|"$/g, ''));
                    
                    const order = {
                        id: Date.now() + i,
                        orderNo: `R${new Date().getFullYear().toString().slice(2)}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}-${(orders.length + i).toString().padStart(3, '0')}`,
                        date: cleanValues[0],
                        customerName: cleanValues[1],
                        pickupLocation: cleanValues[2],
                        pickupAddress: '',
                        cargo: cleanValues[4],
                        quantity: parseFloat(cleanValues[5]) || 0,
                        unit: cleanValues[6],
                        packaging: cleanValues[7] || '',
                        unitPrice: parseFloat(cleanValues[8]) || 0,
                        amountNet: parseFloat(cleanValues[9]) || 0,
                        amountGross: parseFloat(cleanValues[10]) || 0,
                        driver: cleanValues[11] || '',
                        vehicle: cleanValues[12] || '',
                        instructions: cleanValues[13] || '',
                        instructionSheet: false,
                        invoiceSent: false,
                        paymentReceived: false,
                        orderCompleted: false
                    };
                    
                    orders.push(order);
                }
                
                saveData();
                renderTable();
                updateStats();
                setupFilters();
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // é¡§å®¢ãƒã‚¹ã‚¿CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportCustomerCSV() {
            const headers = ['é¡§å®¢å', 'ä½æ‰€', 'é›»è©±ç•ªå·'];
            
            let csv = headers.join(',') + '\n';
            customerMaster.forEach(customer => {
                const row = [
                    customer.name,
                    customer.address,
                    customer.tel
                ];
                csv += row.map(v => `"${v}"`).join(',') + '\n';
            });
            
            const blob = new Blob([CSV_BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const date = new Date();
            const dateStr = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            const fname = `é¡§å®¢ãƒã‚¹ã‚¿_${dateStr}.csv`;
            if (await saveCsvToDir(blob, fname)) {
                alert('CSVã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆè¨­å®šãƒ•ã‚©ãƒ«ãƒ€ï¼‰');
                return;
            }
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fname;
            link.click();
        }

        // é¡§å®¢ãƒã‚¹ã‚¿CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCustomerCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    const hasHeader = lines[0].includes('é¡§å®¢å') || lines[0].includes('ä½æ‰€') || lines[0].includes('é›»è©±ç•ªå·');
                    const startIndex = hasHeader ? 1 : 0;
                    
                    let importCount = 0;
                    let skipCount = 0;
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // CSVã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã«å¯¾å¿œï¼‰
                        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                        if (!values) {
                            skipCount++;
                            continue;
                        }
                        
                        // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
                        const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
                        
                        // åˆ—ä¸è¶³ã¯ç©ºæ–‡å­—ã§è£œå®Œï¼ˆä½æ‰€ãƒ»é›»è©±ãŒç©ºã§ã‚‚å–ã‚Šè¾¼ã‚€ï¼‰
                        const nameVal = cleanValues[0] ?? '';
                        const addressVal = cleanValues[1] ?? '';
                        const telVal = cleanValues[2] ?? '';

                        const newCustomer = {
                            name: nameVal,
                            address: addressVal,
                            tel: telVal
                        };
                        
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆé¡§å®¢åãŒåŒã˜ã‚‚ã®ã¯è¿½åŠ ã—ãªã„ï¼‰
                        const exists = customerMaster.some(c => c.name === newCustomer.name);
                        if (!exists && newCustomer.name) {
                            customerMaster.push(newCustomer);
                            importCount++;
                        } else {
                            skipCount++;
                        }
                    }
                    
                    // ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¦ç”»é¢ã‚’æ›´æ–°
                    localStorage.setItem('customerMaster', JSON.stringify(customerMaster));
                    renderCustomerMaster();
                    setupFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                    
                    // çµæœã‚’è¡¨ç¤º
                    let message = `CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\n`;
                    message += `è¿½åŠ : ${importCount}ä»¶`;
                    if (skipCount > 0) {
                        message += `\nã‚¹ã‚­ãƒƒãƒ—: ${skipCount}ä»¶ï¼ˆé‡è¤‡ã¾ãŸã¯ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ï¼‰`;
                    }
                    alert(message);
                    
                } catch (error) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    // ã‚¨ãƒ©ãƒ¼ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã§é€šçŸ¥ï¼ˆä¸è¦ãªã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã¯å‰Šé™¤ï¼‰
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        }

// ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰è«‹æ±‚æ›¸CSVã‚’å½“æœˆå—æ³¨ã‹ã‚‰ç”Ÿæˆï¼ˆåˆ—é †å›ºå®šãƒ»æºæ³‰å¾´åä¸€æ‹¬æŒ‡å®šï¼‰
async function exportInvoiceCSV() {
  const orders = (typeof getMonthOrders === 'function') ? getMonthOrders() : [];
  if (!orders || orders.length === 0) {
    alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå½“æœˆã®å—æ³¨ãŒ0ä»¶ï¼‰');
    return;
  }

  // MFã‚µãƒ³ãƒ—ãƒ«CSVã®1è¡Œç›®ï¼ˆ40åˆ—ï¼‰ã¨å®Œå…¨ä¸€è‡´
  const HEADERS = [
    'csv_type(å¤‰æ›´ä¸å¯)', 'è¡Œå½¢å¼', 'å–å¼•å…ˆåç§°', 'ä»¶å', 'è«‹æ±‚æ—¥', 'ãŠæ”¯æ‰•æœŸé™', 'è«‹æ±‚æ›¸ç•ªå·', 'å£²ä¸Šè¨ˆä¸Šæ—¥',
    'ãƒ¡ãƒ¢', 'ã‚¿ã‚°', 'å°è¨ˆ', 'æ¶ˆè²»ç¨', 'æºæ³‰å¾´åç¨', 'åˆè¨ˆé‡‘é¡', 'å–å¼•å…ˆæ•¬ç§°', 'å–å¼•å…ˆéƒµä¾¿ç•ªå·',
    'å–å¼•å…ˆéƒ½é“åºœçœŒ', 'å–å¼•å…ˆä½æ‰€1', 'å–å¼•å…ˆä½æ‰€2', 'å–å¼•å…ˆéƒ¨ç½²', 'å–å¼•å…ˆæ‹…å½“è€…å½¹è·', 'å–å¼•å…ˆæ‹…å½“è€…æ°å',
    'è‡ªç¤¾æ‹…å½“è€…æ°å', 'å‚™è€ƒ', 'æŒ¯è¾¼å…ˆ', 'å…¥é‡‘ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'éƒµé€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ç´å“æ—¥', 'å“å', 'å“ç›®ã‚³ãƒ¼ãƒ‰', 'å˜ä¾¡', 'æ•°é‡', 'å˜ä½', 'ç´å“æ›¸ç•ªå·',
    'è©³ç´°', 'é‡‘é¡', 'æºæ³‰å¾´å', 'å“ç›®æ¶ˆè²»ç¨ç‡'
  ];

  // å…±æœ‰å®šæ•°ã‚’ä½¿ç”¨ï¼ˆCSVæ”¹è¡Œãƒ»BOMãƒ»æºæ³‰å¾´åæŒ‡å®šï¼‰

  // å¸¸æ™‚ã‚¯ã‚©ãƒ¼ãƒˆ
  const q = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;

  // æ•°å€¤å¤‰æ›ã¯å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ toNumber ã‚’ä½¿ç”¨

  const y = currentMonth.getFullYear();
  const m = currentMonth.getMonth() + 1;
  const yyyymm = `${y}${String(m).padStart(2,'0')}`;

  // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ fmtDate ã‚’ä½¿ç”¨

  // è«‹æ±‚æ—¥ï¼å½“æœˆæœ«ã€æ”¯æ‰•æœŸé™ï¼ç¿Œæœˆæœ«
  const lastDayOfMonth = new Date(y, m, 0);
  const invoiceDate = `${y}/${String(m).padStart(2,'0')}/${String(lastDayOfMonth.getDate()).padStart(2,'0')}`;
  const dueDate = (() => {
    const ny = m === 12 ? y+1 : y;
    const nm = m === 12 ? 1 : (m+1);
    const last = new Date(ny, nm, 0);
    return `${ny}/${String(nm).padStart(2,'0')}/${String(last.getDate()).padStart(2,'0')}`;
  })();

  // é¡§å®¢ã”ã¨ã«é›†è¨ˆ
  const byCustomer = {};
  orders.forEach(o => {
    const key = o.customerName || '(ä¸æ˜é¡§å®¢)';
    if (!byCustomer[key]) byCustomer[key] = { items: [], net:0, gross:0, tax:0 };
    const item = {
      date: fmtDate(o.date),
      cargo: o.cargo || '',
      pickup: o.pickupLocation || '',
      delivery: o.deliveryLocation || '',
      instructions: o.instructions || '',
      unitPrice: toNumber(o.unitPrice),
      quantity : toNumber(o.quantity),
      unit     : o.unit || '',
      packaging: o.packaging || '',
      amountNet: toNumber(o.amountNet),
      amountGross: toNumber(o.amountGross)
    };
    byCustomer[key].items.push(item);
    byCustomer[key].net   += item.amountNet;
    byCustomer[key].gross += item.amountGross;
    byCustomer[key].tax   += (item.amountGross - item.amountNet);
  });

  // è¡Œç”Ÿæˆï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ HEADERSé †ã«ä¸¦ã¹ã¦å‡ºåŠ›ï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰
  const rowFrom = (obj) => HEADERS.map(h => q(obj[h]));

  const rows = [];
  rows.push(HEADERS.map(q));

  let invSeq = 0;
  let detailCount = 0;

  Object.entries(byCustomer).forEach(([customerName, sum]) => {
    if (!sum.items.length) return;
    invSeq += 1;
    const invoiceNo = `${yyyymm}-${String(invSeq).padStart(3,'0')}`;

    // 1) è«‹æ±‚æ›¸è¡Œï¼ˆãƒã‚¹ã‚¿ï¼‰
    const master = {
      'csv_type(å¤‰æ›´ä¸å¯)': '40101',
      'è¡Œå½¢å¼': 'è«‹æ±‚æ›¸',
      'å–å¼•å…ˆåç§°': customerName,
      'ä»¶å': `${y}å¹´${m}æœˆåˆ† é‹é€æ–™`,
      'è«‹æ±‚æ—¥': invoiceDate,
      'ãŠæ”¯æ‰•æœŸé™': dueDate,
      'è«‹æ±‚æ›¸ç•ªå·': invoiceNo,
      'å£²ä¸Šè¨ˆä¸Šæ—¥': invoiceDate,
      'å°è¨ˆ': byCustomer[customerName].net,
      'æ¶ˆè²»ç¨': byCustomer[customerName].tax,
      'åˆè¨ˆé‡‘é¡': byCustomer[customerName].gross,
      'å‚™è€ƒ': `é…é€å®Ÿç¸¾: ${sum.items.length}ä»¶`,
      'æºæ³‰å¾´å': MF_WITHHOLDING // â˜…ã“ã“ãŒå¿…ãšå…¥ã‚‹
      // ä»–ã®åˆ—ã¯æœªæŒ‡å®šãªã‚‰ç©ºæ–‡å­—ã«ãªã‚‹
    };
    rows.push(rowFrom(master));

    // 2) å“ç›®è¡Œï¼ˆæ˜ç´°ï¼‰
    sum.items.sort((a,b)=> new Date(a.date.replace(/\//g,'-')) - new Date(b.date.replace(/\//g,'-')));
    sum.items.forEach(it => {
      const d = it.date ? new Date(it.date.replace(/\//g,'-')) : null;
      const md = d && !isNaN(d) ? `${d.getMonth()+1}/${d.getDate()}` : '';
      const itemName = `${md} ${it.cargo}é‹é€`.trim();
      const pLoc = it.pickup ? (String(it.pickup).endsWith('æ§˜') ? it.pickup : `${it.pickup} æ§˜`) : '';
      const dLoc = it.delivery ? (String(it.delivery).endsWith('æ§˜') ? it.delivery : `${it.delivery} æ§˜`) : '';
      const detail = `${pLoc}â†’${dLoc}`;

      const itemRow = {
        'csv_type(å¤‰æ›´ä¸å¯)': '40101',
        'è¡Œå½¢å¼': 'å“ç›®',
        'ç´å“æ—¥': it.date,
        'å“å': itemName,
        'å˜ä¾¡': it.unitPrice,
        'æ•°é‡': it.quantity,
        'å˜ä½': it.unit,
        'è©³ç´°': detail,
        'é‡‘é¡': it.amountNet,
        'æºæ³‰å¾´å': MF_WITHHOLDING, // â˜…ã“ã“ã‚‚å¿…ãšå…¥ã‚‹
        'å“ç›®æ¶ˆè²»ç¨ç‡': TAX_RATE_STR
      };
      rows.push(rowFrom(itemRow));
      detailCount++;
    });
  });

  if (detailCount === 0) {
    alert('å‡ºåŠ›ã™ã‚‹æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¨ã¦0å††ã‹æœªå…¥åŠ›ã®å¯èƒ½æ€§ï¼‰');
    return;
  }

  // å–ã‚Šè¾¼ã¿å‰ã®ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ï¼ˆæºæ³‰å¾´åãŒç©ºã®è¡ŒãŒã‚ã‚Œã°ä¸­æ–­ï¼‰
  const colIdx = HEADERS.indexOf('æºæ³‰å¾´å');
  const firstBad = rows.findIndex((r, i) => i>0 && r[colIdx] === '""'); // å…ˆé ­ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã®ã§é™¤å¤–
  if (firstBad !== -1) {
    alert(`å†…éƒ¨æ¤œè¨¼: ${firstBad} è¡Œç›®ã®ã€Œæºæ³‰å¾´åã€ãŒç©ºã§ã™ã€‚ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™ã€‚`);
    return;
  }

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆBOMä»˜UTF-8 + CRLFï¼‰
  const csvText = rows.map(r => r.join(',')).join(CSV_CRLF);
  const blob = new Blob([CSV_BOM + csvText], { type: 'text/csv;charset=utf-8;' });
  const fname = `è«‹æ±‚æ›¸_${y}å¹´${String(m).padStart(2,'0')}æœˆåˆ†_ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰.csv`;
  if (await saveCsvToDir(blob, fname)) {
    alert(`è«‹æ±‚æ›¸CSVã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆè¨­å®šãƒ•ã‚©ãƒ«ãƒ€ã€æ˜ç´° ${detailCount} è¡Œï¼‰ã€‚`);
    return;
  }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();

  alert(`è«‹æ±‚æ›¸CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆæ˜ç´° ${detailCount} è¡Œï¼‰ã€‚MFã¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚`);
}
       // ï¼ˆä»•æ§˜å¤‰æ›´ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„
window.onclick = function(event) {
    // ä½•ã‚‚ã—ãªã„ï¼ˆÃ—ãƒœã‚¿ãƒ³ or ESC ã ã‘ã§é–‰ã˜ã¾ã™ï¼‰
};


        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeCustomerMaster();
                closeSimpleMaster();
                closeCustomerAddModal();
            }
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openModal();
            }
            // Ctrl/Command + S ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®ã¿ï¼‰
            if ((e.ctrlKey || e.metaKey) && (e.key && e.key.toLowerCase() === 's')) {
                const modal = document.getElementById('orderModal');
                const isOpen = modal && (modal.style.display === 'block' || getComputedStyle(modal).display !== 'none');
                if (isOpen) {
                    e.preventDefault();
                    e.stopPropagation();
                    saveOrder();
                }
            }
        });
    </script>
</body>
</html>