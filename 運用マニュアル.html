<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>運用マニュアル（方式Aのみ）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "メイリオ", sans-serif; line-height: 1.7; color: #222; padding: 24px; }
    h1, h2, h3, h4 { margin: 0.4em 0 0.3em; }
    ul { margin: 0.2em 0 1em; padding-left: 1.2em; }
    .steps > li { margin-bottom: 0.5em; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f4f4f4; border: 1px solid #ddd; border-radius: 4px; padding: 0 4px; }
    pre.kbd { padding: 8px; overflow-x: auto; }
    .note { color: #555; font-size: 0.95em; }
    .section { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>運用マニュアル（企業別横展開：方式Aのみ）</h1>

  <div class="section">
    <h2>企業別横展開（方式A）導入テンプレート</h2>
    <ul class="steps">
      <li>Supabaseで会社ごとにプロジェクト作成 → <span class="kbd">Project URL</span>/<span class="kbd">anon key</span>を控える。</li>
      <li>SQL Editorで以下を実行（受注テーブル・インデックス・RLS簡易許可）。
        <pre class="kbd" style="white-space: pre-wrap">-- orders（受注）
create table if not exists orders (
  id bigserial primary key,
  order_no text unique not null,
  date date not null,
  customer_name text not null,
  pickup_location text not null,
  pickup_address text,
  delivery_location text not null,
  delivery_address text,
  delivery_tel text,
  cargo text not null,
  quantity numeric,
  unit text,
  packaging text,
  unit_price numeric,
  amount_net numeric,
  amount_gross numeric,
  driver text,
  vehicle text,
  instructions text,
  instruction_sheet boolean default false,
  invoice_sent boolean default false,
  payment_received boolean default false,
  order_completed boolean default false,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create index if not exists orders_date_idx on orders (date);
create index if not exists orders_order_no_idx on orders (order_no);

alter table orders enable row level security;
create policy allow_anon_select on orders for select using (auth.role() = 'anon');
create policy allow_anon_insert on orders for insert with check (auth.role() = 'anon');
create policy allow_anon_update on orders for update using (auth.role() = 'anon');
create policy allow_anon_delete on orders for delete using (auth.role() = 'anon');</pre>
      </li>
      <li>API設定 → CORSのAllowed Originsに社内アクセス元（例: <span class="kbd">http://PCのIP:8000</span> または <span class="kbd">http://localhost:8000</span>）を追加。</li>
      <li>アプリの「☁️ クラウド設定（Supabase）」に<span class="kbd">Project URL</span>/<span class="kbd">anon key</span>を入力 → 「クラウド接続を有効化」をオン → 保存。</li>
      <li>初回動作チェック
        <ul>
          <li>新規登録 → 一覧に表示 → 再読込で <span class="kbd">date.asc</span>, <span class="kbd">order_no.asc</span> で安定表示。</li>
          <li>重複受注No → サーバー側アップサート（<span class="kbd">on_conflict=order_no</span>＋<span class="kbd">Prefer: resolution=merge-duplicates</span>）で更新扱い。</li>
          <li>オフライン保存 → 「キューに追加」トースト → 復帰後に自動同期（ステータスにキュー件数）。</li>
          <li>請求/入金トグル → ローカル即時保存 → 失敗時はキュー投入。</li>
        </ul>
      </li>
    </ul>
    <p class="note">前提：<span class="kbd">order_no</span> に一意制約（Unique）が設定されていること。</p>
  </div>

  <div class="section">
    <h2>画面操作ガイド（方式A）</h2>
    <h3>クラウド接続の設定</h3>
    <ul>
      <li>画面上部の「☁️ クラウド設定（Supabase）」をクリック。</li>
      <li><span class="kbd">Project URL</span> と <span class="kbd">anon key</span> を入力。</li>
      <li>「クラウド接続を有効化」にチェック → 「保存」。</li>
      <li>画面右上のステータスが「接続: Cloud」に変われば接続完了（不調時は「接続: ローカル」／キュー件数が表示）。</li>
    </ul>

    <h3>新規受注の登録</h3>
    <ul>
      <li>「＋ 新規受注」をクリックして入力フォームを開く。</li>
      <li>必須項目（<span class="kbd">日付</span>/<span class="kbd">顧客名</span>/<span class="kbd">引取先</span>/<span class="kbd">配送先</span>/<span class="kbd">積荷</span>）を入力。</li>
      <li>必要に応じて「数量／荷姿／単価／金額（税別/税込）／特記事項／ドライバー／車両」を入力。</li>
      <li>「保存」→ ローカル保存後、Cloud接続時は自動でクラウドへ同期（重複Noはアップサート更新）。</li>
    </ul>

    <h3>行操作（複製・削除・チェック）</h3>
    <ul>
      <li>複製：行の「操作」列のボタンから「複製」を選択 → 必要項目を修正 → 保存。</li>
      <li>削除：行の「操作」列から「削除」→ 確認ダイアログでOK。Cloud接続時はクラウド側も削除。</li>
      <li>請求/入金の切替：行の「請求書」「入金」列のチェックボックスをクリック → ローカル保存＆クラウド更新（失敗時はキューに追加）。</li>
    </ul>

    <h3>印刷・エクスポート</h3>
    <ul>
      <li>運行指示書：対象行のチェックボックスをON → 「📄 運行指示書（選択分）」をクリック。複数選択時は同一ドライバーで印刷。</li>
      <li>引取書：対象行を選択 → 「📋 引取書（選択分）」をクリック。</li>
      <li>請求書CSV（MF用）：「💰 請求書CSV（MF用）」をクリック。</li>
      <li>CSV出力：「📊 CSV出力」をクリック。
        <ul>
          <li>保存先フォルダ設定：「💾 CSV保存先フォルダ設定」でフォルダを選択（設定済みなら自動保存、未設定は通常ダウンロード）。</li>
        </ul>
      </li>
    </ul>

    <h3>検索・フィルタ</h3>
    <ul>
      <li>ドライバー絞り込み：「ドライバー」セレクトで選択（初期：<span class="kbd">全ドライバー</span>）。</li>
      <li>顧客検索：入力欄「<span class="kbd">顧客検索（キーワード）</span>」に文字入力。</li>
      <li>行選択：「一覧の左端チェック」または「全選択」チェックで選択・解除。</li>
    </ul>

    <h3>オフライン時の動作</h3>
    <ul>
      <li>保存/更新が失敗すると「Cloud更新に失敗（キューに追加）」トーストが表示され、右上ステータスに「キュー:件数」が表示。</li>
      <li>ネット復帰後は自動でキュー処理され、「Cloud同期完了」トーストが表示されます。</li>
    </ul>
  </div>
</body>
</html>